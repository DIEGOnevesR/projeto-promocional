<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Template - Banners Promocionais</title>
    <!-- 
        Configura√ß√£o de URLs para produ√ß√£o:
        URLs configuradas para usar os servi√ßos no Render
        DESCOMENTAR as linhas abaixo para usar em produ√ß√£o (Render)
    -->
    <!-- <meta name="backend-url" content="https://projeto-promocional.onrender.com"> -->
    <!-- <meta name="whatsapp-url" content="https://whatsapp-sender-weq8.onrender.com"> -->
    <!-- <meta name="gmail-url" content="https://gmail-monitor-pfts.onrender.com"> -->
    <!-- 
        Se n√£o configurar, o sistema detecta automaticamente:
        - Em localhost: usa localhost:5000, localhost:3001, localhost:5001
        - Em produ√ß√£o: usa a mesma origem da p√°gina atual
    -->
    <!-- Google Fonts - Fontes para banners promocionais -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Anton&family=Impact&family=Raleway:wght@400;600;700;800;900&family=Nunito:wght@400;600;700;800;900&family=Montserrat:wght@400;500;600;700;800;900&family=Roboto:wght@400;500;700;900&family=Poppins:wght@400;500;600;700;800;900&family=Open+Sans:wght@400;600;700;800&family=Lato:wght@400;700;900&family=Oswald:wght@400;500;600;700&family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- SheetJS CDN para ler arquivos Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- QRCode.js para renderizar QR Codes de login -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        /* Fontes Locais - Goldplay */
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-RegularIt.ttf') format('truetype');
            font-weight: 400;
            font-style: italic;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-MediumIt.ttf') format('truetype');
            font-weight: 500;
            font-style: italic;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-SemiBoldIt.ttf') format('truetype');
            font-weight: 600;
            font-style: italic;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-BoldIt.ttf') format('truetype');
            font-weight: 700;
            font-style: italic;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-BlackIt.ttf') format('truetype');
            font-weight: 900;
            font-style: italic;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-ThinIt.ttf') format('truetype');
            font-weight: 100;
            font-style: italic;
        }
        @font-face {
            font-family: 'Goldplay';
            src: url('Fontes/Goldplay-LightIt.ttf') format('truetype');
            font-weight: 300;
            font-style: italic;
        }
        /* Nota: Goldplay Light normal (n√£o it√°lico) n√£o est√° dispon√≠vel na pasta Fontes, apenas LightIt.ttf */
        
        /* GoldplayAlt */
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-Regular.ttf') format('truetype');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-RegularIt.ttf') format('truetype');
            font-weight: 400;
            font-style: italic;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-LightIt.ttf') format('truetype');
            font-weight: 300;
            font-style: italic;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-MediumIt.ttf') format('truetype');
            font-weight: 500;
            font-style: italic;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-SemiBold.ttf') format('truetype');
            font-weight: 600;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-SemiBoldIt.ttf') format('truetype');
            font-weight: 600;
            font-style: italic;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-Bold.ttf') format('truetype');
            font-weight: 700;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-BoldIt.ttf') format('truetype');
            font-weight: 700;
            font-style: italic;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-Black.ttf') format('truetype');
            font-weight: 900;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-BlackIt.ttf') format('truetype');
            font-weight: 900;
            font-style: italic;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-Thin.ttf') format('truetype');
            font-weight: 100;
            font-style: normal;
        }
        @font-face {
            font-family: 'GoldplayAlt';
            src: url('Fontes/GoldplayAlt-ThinIt.ttf') format('truetype');
            font-weight: 100;
            font-style: italic;
        }
        
        /* Goldplay Light (OTF) */
        @font-face {
            font-family: 'Goldplay Light';
            src: url('Fontes/Latinotype - Goldplay Light.otf') format('opentype');
            font-weight: 300;
            font-style: normal;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { display: flex; gap: 20px; max-width: 1800px; margin: 0 auto; }
        .controls-panel { width: 400px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto; max-height: calc(100vh - 40px); }
        .preview-panel { flex: 1; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; overflow: hidden; max-height: calc(100vh - 40px); }
        h1 { color: #333; margin-bottom: 20px; font-size: 24px; }
        h2 { color: #555; margin: 20px 0 10px 0; font-size: 18px; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #666; font-size: 14px; font-weight: bold; }
        input[type="range"] { width: 100%; margin-bottom: 5px; }
        .value-display { display: inline-block; width: 60px; text-align: right; color: #007bff; font-weight: bold; margin-left: 10px; }
        input[type="color"] { width: 50px; height: 30px; border: none; border-radius: 4px; cursor: pointer; }
        .preview-container { width: 100%; max-width: 1120px; min-height: 400px; height: calc(100vh - 180px); border: 2px solid #ddd; border-radius: 10px; overflow: auto; background: #f0f0f0; position: relative; padding: 20px; display: flex; justify-content: center; align-items: flex-start; }
        .preview-wrapper { width: 1080px; height: 1920px; position: relative; transform: scale(1); transform-origin: top center; margin: 0; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .export-btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 20px; width: 100%; }
        .export-btn:hover { background: #0056b3; }
        .reset-btn { background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 14px; margin-top: 10px; width: 100%; }
        .reset-btn:hover { background: #545b62; }
        .progress-container { background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #ddd; }
        .progress-bar-wrapper { width: 100%; height: 25px; background: #e9ecef; border-radius: 12px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #28a745, #20c997); width: 0%; transition: width 0.3s ease; border-radius: 12px; }
        .progress-text { text-align: center; font-weight: bold; color: #333; margin-top: 5px; }
        .current-task { text-align: center; color: #666; font-size: 12px; margin-top: 5px; font-style: italic; }
        .logs-container { background: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #ddd; }
        #logs-output { width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 11px; background: #1e1e1e; color: #d4d4d4; resize: vertical; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; background: #f8f9fa; border: none; border-bottom: 3px solid transparent; font-size: 16px; font-weight: bold; color: #666; transition: all 0.3s; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; color: #007bff; border-bottom-color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .image-preview { max-width: 100%; max-height: 300px; border: 2px solid #ddd; border-radius: 8px; margin: 10px 0; }
        .recipients-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin: 10px 0; }
        .recipient-item { padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; display: flex; align-items: center; gap: 10px; }
        .recipient-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .recipient-item label { margin: 0; cursor: pointer; flex: 1; }
        .selected-recipients { margin: 10px 0; padding: 10px; background: #e7f3ff; border-radius: 5px; }
        .selected-recipient { display: inline-block; padding: 5px 10px; margin: 3px; background: #007bff; color: white; border-radius: 15px; font-size: 12px; }
        .selected-recipient .remove { cursor: pointer; margin-left: 5px; font-weight: bold; }
        textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: Arial, sans-serif; resize: vertical; min-height: 100px; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; }
        .file-input-wrapper input[type="file"] { position: absolute; left: -9999px; }
        .file-input-label { display: block; padding: 10px; background: #007bff; color: white; text-align: center; border-radius: 5px; cursor: pointer; }
        .file-input-label:hover { background: #0056b3; }
        .text-editor-toolbar { display: flex; gap: 5px; padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px 5px 0 0; flex-wrap: wrap; }
        .text-editor-btn { padding: 6px 12px; background: white; border: 1px solid #ddd; border-radius: 3px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .text-editor-btn:hover { background: #e9ecef; }
        .text-editor-btn.active { background: #007bff; color: white; border-color: #007bff; }
        .search-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .emoji-picker-container { position: relative; display: inline-block; }
        .emoji-picker { 
            display: none; 
            position: fixed; 
            bottom: auto;
            top: auto;
            left: auto;
            right: auto;
            width: 500px; 
            max-width: 90vw;
            background: white; 
            border: 2px solid #007bff; 
            border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.25); 
            z-index: 10000; 
            max-height: 500px; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 10px;
        }
        /* Estilizar scrollbar do emoji picker */
        .emoji-picker::-webkit-scrollbar {
            width: 8px;
        }
        .emoji-picker::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .emoji-picker::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .emoji-picker::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .emoji-picker.active { display: block; }
        .emoji-category { padding: 12px 8px; border-bottom: 1px solid #eee; }
        .emoji-category:last-child { border-bottom: none; }
        .emoji-category-title { 
            font-size: 12px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px; 
            text-transform: uppercase; 
            padding: 5px 0;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 5px;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .emoji-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 8px; padding: 5px 0; }
        .emoji-item { 
            font-size: 28px; 
            padding: 10px; 
            text-align: center; 
            cursor: pointer; 
            border-radius: 8px; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 48px;
        }
        .emoji-item:hover { 
            background: #e3f2fd; 
            transform: scale(1.15); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .emoji-btn { 
            padding: 8px 14px; 
            background: white; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 20px;
            transition: all 0.2s;
        }
        .emoji-btn:hover { 
            background: #f0f0f0; 
            border-color: #007bff;
            transform: scale(1.05);
        }
        .messenger-mode-section {
            transition: opacity 0.3s ease;
        }
        #mode-individual-btn, #mode-batch-btn {
            transition: all 0.3s ease;
        }
        
        /* Modal para sele√ß√£o de coluna da planilha */
        .excel-column-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        .excel-column-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .excel-column-modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .excel-column-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .excel-column-modal-header h3 {
            margin: 0;
            color: #333;
            font-size: 18px;
        }
        .excel-column-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        .excel-column-modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        .excel-column-list {
            margin: 20px 0;
        }
        .excel-column-item {
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        .excel-column-item:hover {
            border-color: #007bff;
            background: #f8f9ff;
            transform: translateX(5px);
        }
        .excel-column-item.selected {
            border-color: #007bff;
            background: #e7f3ff;
            font-weight: bold;
        }
        .excel-column-item-header {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }
        .excel-column-item-preview {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        .excel-column-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        .excel-preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 12px;
        }
        .excel-preview-table th,
        .excel-preview-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .excel-preview-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .excel-preview-table tr:hover {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls-panel">
            <h1>üé® Editor de Template</h1>
            
            <!-- Abas -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('editor')">üìê Editor</button>
                <button class="tab" onclick="switchTab('messenger')">üì± Mensager</button>
                <button class="tab" onclick="switchTab('gmail')">üìß Gmail Monitor</button>
            </div>
            
            <!-- Conte√∫do da aba Editor -->
            <div id="tab-editor" class="tab-content active">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 2px solid #007bff;">
                <button class="reset-btn" onclick="resetValues()" style="margin: 0;">‚Ü∫ Resetar Valores</button>
                <button type="button" id="toggle-impulsionamento-drag" onclick="toggleImpulsionamentoDragMode()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold;" title="Ativar/Desativar modo de arrastar no preview">üéØ Posicionar no Preview</button>
            </div>
            <small style="color: #666; font-size: 11px; display: block; margin-bottom: 15px; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                üí° Dica: Clique em "Posicionar no Preview" e ent√£o clique e arraste qualquer elemento diretamente na imagem do preview para posicion√°-lo. O modo permanece ativo para mover m√∫ltiplos elementos.
            </small>
            
            <h2>üìê Posicionamento</h2>
            <div class="control-group">
                <label>Top Logo Ofertas: <span class="value-display" id="logo-ofertas-top-val">50</span>px</label>
                <input type="range" id="logo-ofertas-top" min="0" max="300" value="50" oninput="updateCSS()">
            </div>
            
            <h2>üéØ Logo Ofertas</h2>
            <div class="control-group">
                <label>Left (ajuste horizontal): <span class="value-display" id="logo-ofertas-left-val">50</span>%</label>
                <input type="range" id="logo-ofertas-left" min="0" max="100" value="50" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Width: <span class="value-display" id="logo-ofertas-width-val">450</span>px</label>
                <input type="range" id="logo-ofertas-width" min="100" max="800" value="450" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="logo-ofertas-height-val">450</span>px</label>
                <input type="range" id="logo-ofertas-height" min="100" max="800" value="450" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Top Container Produtos: <span class="value-display" id="produtos-container-top-val">650</span>px</label>
                <input type="range" id="produtos-container-top" min="400" max="800" value="650" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Gap entre Produtos (espa√ßamento): <span class="value-display" id="produtos-container-gap-val">20</span>px</label>
                <input type="range" id="produtos-container-gap" min="0" max="100" value="20" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = sem espa√ßamento</small>
            </div>
            
            <h2>‚ûñ Separador entre Produtos</h2>
            <div class="control-group">
                <label>Cor do Separador: <span class="value-display" id="separador-color-val">#FF0000</span></label>
                <input type="color" id="separador-color" value="#FF0000" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Largura: <span class="value-display" id="separador-width-val">3</span>px</label>
                <input type="range" id="separador-width" min="1" max="20" value="3" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Altura: <span class="value-display" id="separador-height-val">200</span>px</label>
                <input type="range" id="separador-height" min="10" max="500" value="200" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Top: <span class="value-display" id="separador-top-val">0</span>px</label>
                <input type="range" id="separador-top" min="0" max="500" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">Posi√ß√£o vertical relativa ao container</small>
            </div>
            <div class="control-group">
                <label>Left: <span class="value-display" id="separador-left-val">0</span>px</label>
                <input type="range" id="separador-left" min="-100" max="100" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">Ajuste horizontal (negativo = esquerda, positivo = direita)</small>
            </div>
            
            <h2>üì¶ Container do Produto</h2>
            <div class="control-group">
                <label>Padding: <span class="value-display" id="produto-container-padding-val">15</span>px</label>
                <input type="range" id="produto-container-padding" min="0" max="50" value="15" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Background Color (cor de fundo):</label>
                <input type="color" id="produto-container-bg-color" value="#FFFFFF" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Background Opacity: <span class="value-display" id="produto-container-bg-opacity-val">0.9</span></label>
                <input type="range" id="produto-container-bg-opacity" min="0" max="100" value="90" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Border Radius: <span class="value-display" id="produto-container-border-radius-val">15</span>px</label>
                <input type="range" id="produto-container-border-radius" min="0" max="50" value="15" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Max Width (Largura M√°xima do Container): <span class="value-display" id="produto-item-max-width-val">320</span>px</label>
                <input type="range" id="produto-item-max-width" min="200" max="500" value="320" oninput="updateCSS()">
            </div>
            
            <h2>üì¶ Container de Imagem do Produto</h2>
            <div class="control-group">
                <label>Altura: <span class="value-display" id="produto-imagem-container-height-val">420</span>px</label>
                <input type="range" id="produto-imagem-container-height" min="200" max="1000" value="420" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Margin Bottom: <span class="value-display" id="produto-imagem-container-margin-bottom-val">30</span>px</label>
                <input type="range" id="produto-imagem-container-margin-bottom" min="0" max="100" value="30" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Cor de Fundo:</label>
                <input type="color" id="produto-imagem-container-bg-color" value="#FFFFFF" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Opacidade do Fundo: <span class="value-display" id="produto-imagem-container-bg-opacity-val">0.8</span></label>
                <input type="range" id="produto-imagem-container-bg-opacity" min="0" max="100" value="80" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = transparente, 100 = totalmente opaco</small>
            </div>
            
            <h2>üñºÔ∏è Imagem do Produto</h2>
            <div class="control-group">
                <label>Top: <span class="value-display" id="produto-imagem-top-val">20</span>px</label>
                <input type="range" id="produto-imagem-top" min="0" max="500" value="20" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Left (ajuste horizontal): <span class="value-display" id="produto-imagem-left-val">50</span>%</label>
                <input type="range" id="produto-imagem-left" min="0" max="100" value="50" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Width: <span class="value-display" id="produto-imagem-width-val">80</span>%</label>
                <input type="range" id="produto-imagem-width" min="40" max="120" value="80" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Max Width: <span class="value-display" id="produto-imagem-max-width-val">200</span>px</label>
                <input type="range" id="produto-imagem-max-width" min="100" max="350" value="200" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="produto-imagem-height-val">auto</span></label>
                <input type="range" id="produto-imagem-height" min="0" max="400" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (mant√©m propor√ß√£o)</small>
            </div>
            
            <div class="control-group">
                <label>Max Height: <span class="value-display" id="produto-imagem-max-height-val">240</span>px</label>
                <input type="range" id="produto-imagem-max-height" min="100" max="500" value="240" oninput="updateCSS()">
            </div>
            
            <h2>ü™µ Base do Produto</h2>
            <div class="control-group">
                <label>Bottom: <span class="value-display" id="base-produto-bottom-val">-100</span>px</label>
                <input type="range" id="base-produto-bottom" min="-200" max="200" value="-100" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Left (ajuste horizontal): <span class="value-display" id="base-produto-left-val">50</span>%</label>
                <input type="range" id="base-produto-left" min="0" max="100" value="50" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Width: <span class="value-display" id="base-produto-width-val">200</span>%</label>
                <input type="range" id="base-produto-width" min="100" max="300" value="200" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Max Width: <span class="value-display" id="base-produto-max-width-val">500</span>px</label>
                <input type="range" id="base-produto-max-width" min="300" max="700" value="500" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="base-produto-height-val">auto</span></label>
                <input type="range" id="base-produto-height" min="0" max="200" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (mant√©m propor√ß√£o)</small>
            </div>
            
            <div class="control-group">
                <label>Opacity: <span class="value-display" id="base-produto-opacity-val">0.9</span></label>
                <input type="range" id="base-produto-opacity" min="0" max="100" value="90" oninput="updateCSS()">
            </div>
            
            <h2>üè∑Ô∏è Badge de Desconto</h2>
            <div class="control-group">
                <label>Formato:</label>
                <select id="desconto-badge-shape" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="pill">Retangular com borda</option>
                    <option value="circle">Circular</option>
                    <option value="starburst">Estrela/Raio</option>
                </select>
            </div>
            <div class="control-group">
                <label>Top: <span class="value-display" id="desconto-badge-top-val">8</span>px</label>
                <input type="range" id="desconto-badge-top" min="0" max="600" value="8" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Right: <span class="value-display" id="desconto-badge-right-val">8</span>px</label>
                <input type="range" id="desconto-badge-right" min="0" max="600" value="8" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Bottom: <span class="value-display" id="desconto-badge-bottom-val">auto</span></label>
                <input type="range" id="desconto-badge-bottom" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = autom√°tico (usa top)</small>
            </div>
            
            <div class="control-group">
                <label>Left: <span class="value-display" id="desconto-badge-left-val">auto</span></label>
                <input type="range" id="desconto-badge-left" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = autom√°tico (usa right)</small>
            </div>
            
            <div class="control-group">
                <label>Width: <span class="value-display" id="desconto-badge-width-val">auto</span></label>
                <input type="range" id="desconto-badge-width" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto</small>
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="desconto-badge-height-val">auto</span></label>
                <input type="range" id="desconto-badge-height" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto</small>
            </div>
            
            <div class="control-group">
                <label>Font Size: <span class="value-display" id="desconto-badge-font-size-val">16</span>px</label>
                <input type="range" id="desconto-badge-font-size" min="10" max="100" value="16" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Borda (largura): <span class="value-display" id="desconto-badge-border-width-val">0</span>px</label>
                <input type="range" id="desconto-badge-border-width" min="0" max="20" value="0" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Cor da Borda:</label>
                <input type="color" id="desconto-badge-border-color" value="#FFFFFF" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Color (texto):</label>
                <input type="color" id="desconto-badge-color" value="#FFFFFF" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Background Color (cor de fundo):</label>
                <input type="color" id="desconto-badge-bg-color" value="#FF0000" oninput="updateCSS()">
            </div>
            
            <h2>üè≥Ô∏è Bandeira</h2>
            <div class="control-group">
                <label>Top: <span class="value-display" id="bandeira-top-val">auto</span></label>
                <input type="range" id="bandeira-top" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = autom√°tico (usa bottom)</small>
            </div>
            
            <div class="control-group">
                <label>Right: <span class="value-display" id="bandeira-right-val">auto</span></label>
                <input type="range" id="bandeira-right" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = autom√°tico (usa left)</small>
            </div>
            
            <div class="control-group">
                <label>Bottom: <span class="value-display" id="bandeira-bottom-val">auto</span></label>
                <input type="range" id="bandeira-bottom" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = autom√°tico (posiciona abaixo do badge)</small>
            </div>
            
            <div class="control-group">
                <label>Left: <span class="value-display" id="bandeira-left-val">auto</span></label>
                <input type="range" id="bandeira-left" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = autom√°tico (usa right)</small>
            </div>
            
            <div class="control-group">
                <label>Width: <span class="value-display" id="bandeira-width-val">auto</span></label>
                <input type="range" id="bandeira-width" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (usa mesmo tamanho do badge)</small>
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="bandeira-height-val">auto</span></label>
                <input type="range" id="bandeira-height" min="0" max="600" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (usa mesmo tamanho do badge)</small>
            </div>
            
            <h2>üìù Textos do Produto</h2>
            <div class="control-group">
                <label>Nome - Font Size: <span class="value-display" id="produto-nome-font-size-val">16</span>px</label>
                <input type="range" id="produto-nome-font-size" min="10" max="100" value="16" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Nome - Color:</label>
                <input type="color" id="produto-nome-color" value="#1a1a1a" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Nome - Fonte:</label>
                <select id="produto-nome-font-family" onchange="handleFontFamilyChange('produto-nome-font-family'); updateCSS();" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <optgroup label="üìç Fontes Locais - Goldplay">
                        <option value="'Goldplay', sans-serif" data-weight="100">Goldplay (Thin)</option>
                        <option value="'Goldplay', sans-serif" data-weight="300">Goldplay (Light)</option>
                        <option value="'Goldplay', sans-serif">Goldplay (Regular)</option>
                        <option value="'Goldplay', sans-serif" data-weight="500">Goldplay (Medium)</option>
                        <option value="'Goldplay', sans-serif" data-weight="600">Goldplay (SemiBold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="700">Goldplay (Bold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="900">Goldplay (Black)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="100">GoldplayAlt (Thin)</option>
                        <option value="'GoldplayAlt', sans-serif">GoldplayAlt (Regular)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="300">GoldplayAlt (Light)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="500">GoldplayAlt (Medium)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="600">GoldplayAlt (SemiBold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="700">GoldplayAlt (Bold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="900">GoldplayAlt (Black)</option>
                        <option value="'Goldplay Light', sans-serif">Goldplay Light (OTF)</option>
                    </optgroup>
                    <optgroup label="üåê Google Fonts">
                        <option value="'Bebas Neue', sans-serif">Bebas Neue (Estilo Banner)</option>
                        <option value="'Anton', sans-serif">Anton (Bold Impactante)</option>
                        <option value="'Impact', sans-serif">Impact (Cl√°ssica Bold)</option>
                        <option value="'Raleway', sans-serif">Raleway (Moderna)</option>
                        <option value="'Nunito', sans-serif">Nunito (Arredondada)</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Poppins', sans-serif">Poppins</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Oswald', sans-serif">Oswald</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="'Arial Black', Arial, sans-serif">Arial Black</option>
                    </optgroup>
                </select>
            </div>
            <div class="control-group">
                <label>Nome - Peso:</label>
                <select id="produto-nome-font-weight" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="normal">Normal</option>
                    <option value="bold">Negrito</option>
                </select>
            </div>
            <div class="control-group">
                <label>Nome - Estilo:</label>
                <select id="produto-nome-font-style" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="normal">Normal</option>
                    <option value="italic">It√°lico</option>
                </select>
            </div>
            
            <h3 style="margin-top: 15px; margin-bottom: 10px; color: #333; font-size: 14px;">üìç Posi√ß√£o - Nome do Produto</h3>
            <div class="control-group">
                <label>Top: <span class="value-display" id="produto-nome-top-val">0</span>px</label>
                <input type="range" id="produto-nome-top" min="-500" max="500" value="0" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Left: <span class="value-display" id="produto-nome-left-val">0</span>px</label>
                <input type="range" id="produto-nome-left" min="-100" max="100" value="0" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>C√≥digo - Font Size: <span class="value-display" id="produto-codigo-font-size-val">14</span>px</label>
                <input type="range" id="produto-codigo-font-size" min="10" max="100" value="14" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>C√≥digo - Color:</label>
                <input type="color" id="produto-codigo-color" value="#666666" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>C√≥digo - Fonte:</label>
                <select id="produto-codigo-font-family" onchange="handleFontFamilyChange('produto-codigo-font-family'); updateCSS();" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <optgroup label="üìç Fontes Locais - Goldplay">
                        <option value="'Goldplay', sans-serif" data-weight="100">Goldplay (Thin)</option>
                        <option value="'Goldplay', sans-serif" data-weight="300">Goldplay (Light)</option>
                        <option value="'Goldplay', sans-serif">Goldplay (Regular)</option>
                        <option value="'Goldplay', sans-serif" data-weight="500">Goldplay (Medium)</option>
                        <option value="'Goldplay', sans-serif" data-weight="600">Goldplay (SemiBold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="700">Goldplay (Bold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="900">Goldplay (Black)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="100">GoldplayAlt (Thin)</option>
                        <option value="'GoldplayAlt', sans-serif">GoldplayAlt (Regular)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="300">GoldplayAlt (Light)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="500">GoldplayAlt (Medium)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="600">GoldplayAlt (SemiBold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="700">GoldplayAlt (Bold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="900">GoldplayAlt (Black)</option>
                        <option value="'Goldplay Light', sans-serif">Goldplay Light (OTF)</option>
                    </optgroup>
                    <optgroup label="üåê Google Fonts">
                        <option value="'Bebas Neue', sans-serif">Bebas Neue (Estilo Banner)</option>
                        <option value="'Anton', sans-serif">Anton (Bold Impactante)</option>
                        <option value="'Impact', sans-serif">Impact (Cl√°ssica Bold)</option>
                        <option value="'Raleway', sans-serif">Raleway (Moderna)</option>
                        <option value="'Nunito', sans-serif">Nunito (Arredondada)</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Poppins', sans-serif">Poppins</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Oswald', sans-serif">Oswald</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="'Arial', sans-serif">Arial</option>
                    </optgroup>
                </select>
            </div>
            <div class="control-group">
                <label>C√≥digo - Peso:</label>
                <select id="produto-codigo-font-weight" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="normal">Normal</option>
                    <option value="bold">Negrito</option>
                </select>
            </div>
            <div class="control-group">
                <label>C√≥digo - Estilo:</label>
                <select id="produto-codigo-font-style" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="normal">Normal</option>
                    <option value="italic">It√°lico</option>
                </select>
            </div>
            
            <h3 style="margin-top: 15px; margin-bottom: 10px; color: #333; font-size: 14px;">üìç Posi√ß√£o - C√≥digo do Produto</h3>
            <div class="control-group">
                <label>Top: <span class="value-display" id="produto-codigo-top-val">0</span>px</label>
                <input type="range" id="produto-codigo-top" min="-500" max="500" value="0" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Left: <span class="value-display" id="produto-codigo-left-val">0</span>px</label>
                <input type="range" id="produto-codigo-left" min="-100" max="100" value="0" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Pre√ßo Comercial - Font Size: <span class="value-display" id="preco-comercial-font-size-val">14</span>px</label>
                <input type="range" id="preco-comercial-font-size" min="10" max="100" value="14" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Pre√ßo Comercial - Color:</label>
                <input type="color" id="preco-comercial-color" value="#e53935" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Pre√ßo Comercial - Fonte:</label>
                <select id="preco-comercial-font-family" onchange="handleFontFamilyChange('preco-comercial-font-family'); updateCSS();" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <optgroup label="üìç Fontes Locais - Goldplay">
                        <option value="'Goldplay', sans-serif" data-weight="100">Goldplay (Thin)</option>
                        <option value="'Goldplay', sans-serif" data-weight="300">Goldplay (Light)</option>
                        <option value="'Goldplay', sans-serif">Goldplay (Regular)</option>
                        <option value="'Goldplay', sans-serif" data-weight="500">Goldplay (Medium)</option>
                        <option value="'Goldplay', sans-serif" data-weight="600">Goldplay (SemiBold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="700">Goldplay (Bold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="900">Goldplay (Black)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="100">GoldplayAlt (Thin)</option>
                        <option value="'GoldplayAlt', sans-serif">GoldplayAlt (Regular)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="300">GoldplayAlt (Light)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="500">GoldplayAlt (Medium)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="600">GoldplayAlt (SemiBold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="700">GoldplayAlt (Bold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="900">GoldplayAlt (Black)</option>
                        <option value="'Goldplay Light', sans-serif">Goldplay Light (OTF)</option>
                    </optgroup>
                    <optgroup label="üåê Google Fonts">
                        <option value="'Bebas Neue', sans-serif">Bebas Neue (Estilo Banner)</option>
                        <option value="'Anton', sans-serif">Anton (Bold Impactante)</option>
                        <option value="'Impact', sans-serif">Impact (Cl√°ssica Bold)</option>
                        <option value="'Raleway', sans-serif">Raleway (Moderna)</option>
                        <option value="'Nunito', sans-serif">Nunito (Arredondada)</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Poppins', sans-serif">Poppins</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Oswald', sans-serif">Oswald</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="'Courier New', monospace">Courier New</option>
                    </optgroup>
                </select>
            </div>
            <div class="control-group">
                <label>Pre√ßo Comercial - Peso:</label>
                <select id="preco-comercial-font-weight" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="normal">Normal</option>
                    <option value="bold">Negrito</option>
                </select>
            </div>
            <div class="control-group">
                <label>Pre√ßo Comercial - Estilo:</label>
                <select id="preco-comercial-font-style" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="normal">Normal</option>
                    <option value="italic">It√°lico</option>
                </select>
            </div>
            
            <h3 style="margin-top: 15px; margin-bottom: 10px; color: #333; font-size: 14px;">üìç Posi√ß√£o - Label "DE"</h3>
            <div class="control-group">
                <label>Tamanho da Fonte: <span class="value-display" id="preco-de-font-size-val">16</span>px</label>
                <input type="range" id="preco-de-font-size" min="8" max="60" value="16" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Top: <span class="value-display" id="preco-de-top-val">0</span>px</label>
                <input type="range" id="preco-de-top" min="-500" max="500" value="0" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Left: <span class="value-display" id="preco-de-left-val">0</span>px</label>
                <input type="range" id="preco-de-left" min="-100" max="100" value="0" oninput="updateCSS()">
            </div>
            
            <h3 style="margin-top: 15px; margin-bottom: 10px; color: #333; font-size: 14px;">üìç Posi√ß√£o - Pre√ßo Comercial</h3>
            <div class="control-group">
                <label>Top: <span class="value-display" id="preco-comercial-top-val">0</span>px</label>
                <input type="range" id="preco-comercial-top" min="-500" max="500" value="0" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Left: <span class="value-display" id="preco-comercial-left-val">0</span>px</label>
                <input type="range" id="preco-comercial-left" min="-100" max="100" value="0" oninput="updateCSS()">
            </div>
            
            <h3 style="margin-top: 15px; margin-bottom: 10px; color: #333; font-size: 14px;">üìç Posi√ß√£o - Label "POR"</h3>
            <div class="control-group">
                <label>Tamanho da Fonte: <span class="value-display" id="preco-por-font-size-val">16</span>px</label>
                <input type="range" id="preco-por-font-size" min="8" max="60" value="16" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Top: <span class="value-display" id="preco-por-top-val">0</span>px</label>
                <input type="range" id="preco-por-top" min="-500" max="500" value="0" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Left: <span class="value-display" id="preco-por-left-val">0</span>px</label>
                <input type="range" id="preco-por-left" min="-100" max="100" value="0" oninput="updateCSS()">
            </div>
            
            <h3 style="margin-top: 15px; margin-bottom: 10px; color: #333; font-size: 14px;">üìç Posi√ß√£o - Label "POR [Unidade]"</h3>
            <div class="control-group">
                <label>Tamanho da Fonte: <span class="value-display" id="preco-por-unidade-font-size-val">16</span>px</label>
                <input type="range" id="preco-por-unidade-font-size" min="8" max="60" value="16" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Top: <span class="value-display" id="preco-por-unidade-top-val">0</span>px</label>
                <input type="range" id="preco-por-unidade-top" min="-500" max="500" value="0" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Left: <span class="value-display" id="preco-por-unidade-left-val">0</span>px</label>
                <input type="range" id="preco-por-unidade-left" min="-100" max="100" value="0" oninput="updateCSS()">
            </div>
            
            <h2>üí∞ Pre√ßo Promocional</h2>
            <div class="control-group">
                <label>Font Size: <span class="value-display" id="preco-promocional-font-size-val">28</span>px</label>
                <input type="range" id="preco-promocional-font-size" min="20" max="100" value="28" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Color:</label>
                <input type="color" id="preco-promocional-color" value="#FF6B00" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Pre√ßo Promocional - Fonte:</label>
                <select id="preco-promocional-font-family" onchange="handleFontFamilyChange('preco-promocional-font-family'); updateCSS();" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <optgroup label="üìç Fontes Locais - Goldplay">
                        <option value="'Goldplay', sans-serif">Goldplay (Regular)</option>
                        <option value="'Goldplay', sans-serif" data-weight="500">Goldplay (Medium)</option>
                        <option value="'Goldplay', sans-serif" data-weight="600">Goldplay (SemiBold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="700">Goldplay (Bold) ‚≠ê</option>
                        <option value="'Goldplay', sans-serif" data-weight="900">Goldplay (Black)</option>
                        <option value="'GoldplayAlt', sans-serif">GoldplayAlt (Regular)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="300">GoldplayAlt (Light)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="500">GoldplayAlt (Medium)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="600">GoldplayAlt (SemiBold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="700">GoldplayAlt (Bold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="900">GoldplayAlt (Black)</option>
                        <option value="'Goldplay Light', sans-serif">Goldplay Light (OTF)</option>
                    </optgroup>
                    <optgroup label="üåê Google Fonts">
                        <option value="'Bebas Neue', sans-serif">Bebas Neue (Estilo Banner)</option>
                        <option value="'Anton', sans-serif">Anton (Bold Impactante)</option>
                        <option value="'Impact', sans-serif">Impact (Cl√°ssica Bold)</option>
                        <option value="'Raleway', sans-serif">Raleway (Moderna)</option>
                        <option value="'Nunito', sans-serif">Nunito (Arredondada)</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Poppins', sans-serif">Poppins</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Oswald', sans-serif">Oswald</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="'Arial Black', Arial, sans-serif">Arial Black</option>
                    </optgroup>
                </select>
            </div>
            <div class="control-group">
                <label>Pre√ßo Promocional - Peso:</label>
                <select id="preco-promocional-font-weight" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="normal">Normal</option>
                    <option value="bold">Negrito</option>
                </select>
            </div>
            <div class="control-group">
                <label>Pre√ßo Promocional - Estilo:</label>
                <select id="preco-promocional-font-style" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="normal">Normal</option>
                    <option value="italic">It√°lico</option>
                </select>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #333; font-size: 16px;">üí∞ S√≠mbolo "R$"</h3>
            <div class="control-group">
                <label>Cor do "R$":</label>
                <input type="color" id="preco-rs-color" value="#FF6B00" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Tamanho da Fonte do "R$": <span class="value-display" id="preco-rs-font-size-val">0.5</span>em</label>
                <input type="range" id="preco-rs-font-size" min="0.1" max="2" step="0.1" value="0.5" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Alinhamento Vertical do "R$":</label>
                <select id="preco-rs-vertical-align" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="center">Centralizado</option>
                    <option value="flex-start">Topo</option>
                    <option value="flex-end">Base</option>
                </select>
            </div>
            
            <h3 style="margin-top: 20px; margin-bottom: 10px; color: #333; font-size: 16px;">üí∞ Parte Decimal ",90"</h3>
            <div class="control-group">
                <label>Cor da Parte Decimal:</label>
                <input type="color" id="preco-decimal-color" value="#FF6B00" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Tamanho da Fonte da Parte Decimal: <span class="value-display" id="preco-decimal-font-size-val">0.65</span>em</label>
                <input type="range" id="preco-decimal-font-size" min="0.1" max="2" step="0.05" value="0.65" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Alinhamento Vertical da Parte Decimal:</label>
                <select id="preco-decimal-vertical-align" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="top" selected>Topo</option>
                    <option value="middle">Meio</option>
                    <option value="baseline">Base</option>
                </select>
            </div>
            
            <h3 style="margin-top: 15px; margin-bottom: 10px; color: #333; font-size: 14px;">üìç Posi√ß√£o - Pre√ßo Promocional</h3>
            <div class="control-group">
                <label>Top: <span class="value-display" id="preco-promocional-top-val">0</span>px</label>
                <input type="range" id="preco-promocional-top" min="-500" max="500" value="0" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Left: <span class="value-display" id="preco-promocional-left-val">0</span>px</label>
                <input type="range" id="preco-promocional-left" min="-100" max="100" value="0" oninput="updateCSS()">
            </div>
            
            <h2>üí¨ Frase de Impulsionamento</h2>
            <div class="control-group">
                <label>Frase de Impulsionamento:</label>
                <div class="text-editor-toolbar" style="margin-bottom: 5px;">
                    <button class="text-editor-btn" onclick="formatImpulsionamentoText('bold')" title="Negrito: *texto*">B</button>
                    <button class="text-editor-btn" onclick="formatImpulsionamentoText('italic')" title="It√°lico: _texto_">I</button>
                    <button class="text-editor-btn" onclick="applyImpulsionamentoColor()" title="Aplicar cor ao texto selecionado">üé®</button>
                    <div style="flex: 1;"></div>
                    <small style="color: #666; font-size: 11px; align-self: center;">Selecione o texto e clique em üé® para mudar a cor</small>
                </div>
                <div id="impulsionamento-text" contenteditable="true" style="min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: Arial, sans-serif; background: white; outline: none;" oninput="updateCSS()" onpaste="handleImpulsionamentoPaste(event)">
                    Digite sua frase de impulsionamento aqui...
                </div>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
                    Voc√™ pode selecionar partes do texto e aplicar formata√ß√£o individual (negrito, it√°lico, cor).
                </small>
            </div>
            
            <div class="control-group">
                <label>Fonte:</label>
                <select id="impulsionamento-font-family" onchange="handleFontFamilyChange('impulsionamento-font-family'); updateCSS();" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <optgroup label="üìç Fontes Locais - Goldplay">
                        <option value="'Goldplay', sans-serif">Goldplay (Regular)</option>
                        <option value="'Goldplay', sans-serif" data-weight="500">Goldplay (Medium)</option>
                        <option value="'Goldplay', sans-serif" data-weight="600">Goldplay (SemiBold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="700">Goldplay (Bold) ‚≠ê</option>
                        <option value="'Goldplay', sans-serif" data-weight="900">Goldplay (Black)</option>
                        <option value="'GoldplayAlt', sans-serif">GoldplayAlt (Regular)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="300">GoldplayAlt (Light)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="500">GoldplayAlt (Medium)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="600">GoldplayAlt (SemiBold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="700">GoldplayAlt (Bold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="900">GoldplayAlt (Black)</option>
                        <option value="'Goldplay Light', sans-serif">Goldplay Light (OTF)</option>
                    </optgroup>
                    <optgroup label="üåê Google Fonts">
                        <option value="'Bebas Neue', sans-serif">Bebas Neue (Estilo Banner)</option>
                        <option value="'Anton', sans-serif">Anton (Bold Impactante)</option>
                        <option value="'Impact', sans-serif">Impact (Cl√°ssica Bold)</option>
                        <option value="'Raleway', sans-serif">Raleway (Moderna)</option>
                        <option value="'Nunito', sans-serif">Nunito (Arredondada)</option>
                        <option value="'Montserrat', sans-serif">Montserrat</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="'Poppins', sans-serif">Poppins</option>
                        <option value="'Open Sans', sans-serif">Open Sans</option>
                        <option value="'Lato', sans-serif">Lato</option>
                        <option value="'Oswald', sans-serif">Oswald</option>
                        <option value="'Playfair Display', serif">Playfair Display</option>
                        <option value="'Arial Black', Arial, sans-serif">Arial Black</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="control-group">
                <label>Cor Padr√£o do Texto: <span class="value-display" id="impulsionamento-color-val">#FFFFFF</span></label>
                <input type="color" id="impulsionamento-color" value="#FFFFFF" oninput="updateImpulsionamentoColorDisplay(); updateCSS();">
            </div>
            
            <div class="control-group">
                <label>Tamanho da Fonte: <span class="value-display" id="impulsionamento-font-size-val">32</span>px</label>
                <input type="range" id="impulsionamento-font-size" min="10" max="100" value="32" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Top: <span class="value-display" id="impulsionamento-top-val">0</span>px</label>
                <input type="range" id="impulsionamento-top" min="0" max="1920" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0px = topo da tela. Aumente o valor para mover o texto para baixo.</small>
            </div>
            
            <div class="control-group">
                <label>Bottom: <span class="value-display" id="impulsionamento-bottom-val">auto</span></label>
                <input type="range" id="impulsionamento-bottom" min="0" max="1920" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (usa top). Defina um valor para posicionar a partir de baixo.</small>
            </div>
            
            <div class="control-group">
                <label>Left: <span class="value-display" id="impulsionamento-left-val">540</span>px</label>
                <input type="range" id="impulsionamento-left" min="0" max="1080" value="540" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = esquerda, 1080 = direita</small>
            </div>
            
            <div class="control-group">
                <label>Right: <span class="value-display" id="impulsionamento-right-val">auto</span></label>
                <input type="range" id="impulsionamento-right" min="0" max="1080" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (usa left), ou defina right em pixels</small>
            </div>
            
            <div class="control-group">
                <label>Width: <span class="value-display" id="impulsionamento-width-val">800</span>px</label>
                <input type="range" id="impulsionamento-width" min="100" max="1080" value="800" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="impulsionamento-height-val">auto</span></label>
                <input type="range" id="impulsionamento-height" min="0" max="500" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (ajusta ao conte√∫do)</small>
            </div>
            
            <h2>üìû Call Action</h2>
            <div class="control-group">
                <label>Top: <span class="value-display" id="call-action-top-val">auto</span></label>
                <input type="range" id="call-action-top" min="0" max="1920" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (usa bottom), ou defina top em pixels</small>
            </div>
            
            <div class="control-group">
                <label>Bottom: <span class="value-display" id="call-action-bottom-val">120</span>px</label>
                <input type="range" id="call-action-bottom" min="0" max="1920" value="120" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (usa top)</small>
            </div>
            
            <div class="control-group">
                <label>Left (ajuste horizontal): <span class="value-display" id="call-action-left-val">50</span>%</label>
                <input type="range" id="call-action-left" min="0" max="100" value="50" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Width: <span class="value-display" id="call-action-width-val">500</span>px</label>
                <input type="range" id="call-action-width" min="50" max="1080" value="500" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="call-action-height-val">100</span>px</label>
                <input type="range" id="call-action-height" min="20" max="1920" value="100" oninput="updateCSS()">
            </div>
            
            <h2>üñºÔ∏è Logo Inferior</h2>
            <div class="control-group">
                <label>Bottom: <span class="value-display" id="logo-inferior-bottom-val">20</span>px</label>
                <input type="range" id="logo-inferior-bottom" min="0" max="150" value="20" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Left (ajuste horizontal): <span class="value-display" id="logo-inferior-left-val">50</span>%</label>
                <input type="range" id="logo-inferior-left" min="0" max="100" value="50" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Width: <span class="value-display" id="logo-inferior-width-val">350</span>px</label>
                <input type="range" id="logo-inferior-width" min="100" max="1080" value="350" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="logo-inferior-height-val">80</span>px</label>
                <input type="range" id="logo-inferior-height" min="30" max="600" value="80" oninput="updateCSS()">
            </div>
            
            <h2>üè¢ Logo Superior</h2>
            <div class="control-group">
                <label>Top: <span class="value-display" id="logo-superior-top-val">20</span>px</label>
                <input type="range" id="logo-superior-top" min="0" max="300" value="20" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Right: <span class="value-display" id="logo-superior-right-val">20</span>px</label>
                <input type="range" id="logo-superior-right" min="0" max="200" value="20" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Width: <span class="value-display" id="logo-superior-width-val">150</span>px</label>
                <input type="range" id="logo-superior-width" min="50" max="500" value="150" oninput="updateCSS()">
            </div>
            
            <div class="control-group">
                <label>Height: <span class="value-display" id="logo-superior-height-val">auto</span></label>
                <input type="range" id="logo-superior-height" min="0" max="500" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (mant√©m propor√ß√£o)</small>
            </div>
            
            <h2>üìù Rodap√©</h2>
            <div class="control-group">
                <label>Tipo de Fonte:</label>
                <select id="footer-font-family" onchange="handleFontFamilyChange('footer-font-family'); updateCSS();" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <optgroup label="üìç Fontes Locais - Goldplay">
                        <option value="'Goldplay', sans-serif">Goldplay (Regular)</option>
                        <option value="'Goldplay', sans-serif" data-weight="500">Goldplay (Medium)</option>
                        <option value="'Goldplay', sans-serif" data-weight="600">Goldplay (SemiBold)</option>
                        <option value="'Goldplay', sans-serif" data-weight="700">Goldplay (Bold) ‚≠ê</option>
                        <option value="'Goldplay', sans-serif" data-weight="900">Goldplay (Black)</option>
                        <option value="'GoldplayAlt', sans-serif">GoldplayAlt (Regular)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="300">GoldplayAlt (Light)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="500">GoldplayAlt (Medium)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="600">GoldplayAlt (SemiBold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="700">GoldplayAlt (Bold)</option>
                        <option value="'GoldplayAlt', sans-serif" data-weight="900">GoldplayAlt (Black)</option>
                        <option value="'Goldplay Light', sans-serif">Goldplay Light (OTF)</option>
                    </optgroup>
                    <optgroup label="üåê Google Fonts">
                        <option value="'Bebas Neue', sans-serif">Bebas Neue (Estilo Banner)</option>
                        <option value="'Anton', sans-serif">Anton (Bold Impactante)</option>
                        <option value="'Impact', sans-serif">Impact (Cl√°ssica Bold)</option>
                        <option value="'Raleway', sans-serif">Raleway (Moderna)</option>
                        <option value="'Nunito', sans-serif">Nunito (Arredondada)</option>
                        <option value="'Montserrat', sans-serif" selected>Montserrat</option>
                        <option value="'Roboto', sans-serif">Roboto</option>
                        <option value="'Poppins', sans-serif">Poppins</option>
                        <option value="'Open Sans', sans-serif">Open Sans</option>
                        <option value="'Lato', sans-serif">Lato</option>
                        <option value="'Oswald', sans-serif">Oswald</option>
                        <option value="'Playfair Display', serif">Playfair Display</option>
                        <option value="'Arial Black', Arial, sans-serif">Arial Black</option>
                    </optgroup>
                </select>
            </div>
            <div class="control-group">
                <label>Tamanho da Fonte: <span class="value-display" id="footer-font-size-val">26</span>px</label>
                <input type="range" id="footer-font-size" min="12" max="100" value="26" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Cor do Texto:</label>
                <input type="color" id="footer-color" value="#FFFFFF" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Largura: <span class="value-display" id="footer-width-val">900</span>px</label>
                <input type="range" id="footer-width" min="200" max="1080" value="900" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Posi√ß√£o Horizontal (Left): <span class="value-display" id="footer-left-val">50</span>%</label>
                <input type="range" id="footer-left" min="0" max="100" value="50" oninput="updateCSS()">
            </div>
            <div class="control-group">
                <label>Top: <span class="value-display" id="footer-top-val">auto</span></label>
                <input type="range" id="footer-top" min="0" max="1920" value="0" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (usa bottom)</small>
            </div>
            <div class="control-group">
                <label>Bottom: <span class="value-display" id="footer-bottom-val">5</span>px</label>
                <input type="range" id="footer-bottom" min="0" max="1920" value="5" oninput="updateCSS()">
                <small style="color: #999; font-size: 11px;">0 = auto (usa top)</small>
            </div>
            <div class="control-group">
                <label>Orienta√ß√£o:</label>
                <select id="footer-rotation" onchange="updateCSS()" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ced4da;">
                    <option value="horizontal">Horizontal</option>
                    <option value="vertical">Vertical</option>
                </select>
            </div>
            
            <h2 style="margin-top: 30px;">üìù Legenda Padr√£o dos Banners</h2>
            <div class="control-group">
                <label>Texto/Legenda que ser√° enviada com os banners:</label>
                <div class="text-editor-toolbar">
                    <button class="text-editor-btn" onclick="formatBannerText('bold')" title="Negrito: *texto*">B</button>
                    <button class="text-editor-btn" onclick="formatBannerText('italic')" title="It√°lico: _texto_">I</button>
                    <button class="text-editor-btn" onclick="formatBannerText('strikethrough')" title="Tachado: ~texto~">S</button>
                    <button class="text-editor-btn" onclick="formatBannerText('monospace')" title="Monoespa√ßado: ```texto```">M</button>
                    <div class="emoji-picker-container">
                        <button type="button" class="emoji-btn" onclick="toggleBannerEmojiPicker()" title="Inserir emoji">üòÄ</button>
                        <div id="banner-emoji-picker" class="emoji-picker">
                            <div class="emoji-category">
                                <div class="emoji-category-title">Faces & Emo√ß√µes</div>
                                <div class="emoji-grid" id="banner-emoji-faces"></div>
                            </div>
                            <div class="emoji-category">
                                <div class="emoji-category-title">Gestos & Pessoas</div>
                                <div class="emoji-grid" id="banner-emoji-people"></div>
                            </div>
                            <div class="emoji-category">
                                <div class="emoji-category-title">Objetos & S√≠mbolos</div>
                                <div class="emoji-grid" id="banner-emoji-objects"></div>
                            </div>
                            <div class="emoji-category">
                                <div class="emoji-category-title">Natureza & Comida</div>
                                <div class="emoji-grid" id="banner-emoji-nature"></div>
                            </div>
                            <div class="emoji-category">
                                <div class="emoji-category-title">Atividades & Lugares</div>
                                <div class="emoji-grid" id="banner-emoji-activities"></div>
                            </div>
                            <div class="emoji-category">
                                <div class="emoji-category-title">S√≠mbolos & Sinais</div>
                                <div class="emoji-grid" id="banner-emoji-symbols"></div>
                            </div>
                        </div>
                    </div>
                    <div style="flex: 1;"></div>
                    <small style="color: #666; font-size: 11px; align-self: center;">WhatsApp: *negrito* _it√°lico_ ~tachado~ ```mono```</small>
                </div>
                <textarea id="banner-caption-text" placeholder="Digite a legenda padr√£o que ser√° enviada com os banners gerados..." style="border-radius: 0 0 5px 5px; border-top: none; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: Arial, sans-serif; resize: vertical; min-height: 100px;"></textarea>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
                    Esta legenda ser√° aplicada automaticamente a todos os banners gerados quando enviados via WhatsApp.
                </small>
            </div>
            
            <h2 style="margin-top: 30px;">üíæ Template</h2>
            <button class="export-btn" onclick="saveTemplate()" style="background: #ffc107; color: #1f2933; margin-top: 10px;">üíæ Salvar Template</button>
            <button class="export-btn" onclick="loadTemplate()" style="background: #343a40; margin-top: 10px;">üìÇ Carregar Template</button>
            <button class="reset-btn" onclick="resetValues()" style="margin-top: 10px;">‚Ü©Ô∏è Restaurar Padr√µes</button>
            
            <h2 style="margin-top: 30px;">üöÄ Executar Gerador</h2>
            <button class="export-btn" onclick="checkAndStartServer()" id="start-server-btn" style="background: #6c757d; margin-top: 10px;">üîå Verificar/Iniciar Servidor</button>
            <button class="export-btn" onclick="executeGenerator()" id="execute-btn" style="background: #17a2b8; margin-top: 10px;">‚ñ∂Ô∏è Executar Gerador</button>
            <button class="export-btn" onclick="stopGenerator()" id="stop-btn" style="background: #dc3545; margin-top: 10px; display: none;">‚èπÔ∏è Parar Execu√ß√£o</button>
            <button class="reset-btn" onclick="clearLogs()" style="margin-top: 10px;">üóëÔ∏è Limpar Logs</button>
            
            <div class="progress-container" style="margin-top: 20px; display: none;" id="progress-container">
                <label style="font-weight: bold; margin-bottom: 10px; display: block;">üìä Progresso da Gera√ß√£o:</label>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                    <div class="progress-text" id="progress-text" style="font-weight: bold; font-size: 14px;">0%</div>
                    <div id="progress-stats" style="font-size: 12px; color: #666; text-align: right;"></div>
                </div>
                <div class="current-task" id="current-task" style="margin-top: 8px; padding: 8px; background: #f0f0f0; border-radius: 5px; font-size: 13px; color: #333; min-height: 20px;"></div>
                <div id="progress-details" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 12px; color: #555; display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <div><strong>Unidade:</strong> <span id="stat-unidade">-</span></div>
                        <div><strong>Banner:</strong> <span id="stat-banner">-</span></div>
                        <div><strong>Banners Gerados:</strong> <span id="stat-banners-gerados">0</span></div>
                        <div><strong>Itens Processados:</strong> <span id="stat-itens-processados">0</span></div>
                    </div>
                </div>
            </div>
            
            <div class="logs-container" style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold;">üìã Logs de Execu√ß√£o:</label>
                <textarea id="logs-output" readonly></textarea>
            </div>
            </div>
            
            <!-- Conte√∫do da aba Mensager -->
            <div id="tab-messenger" class="tab-content">
                <h2>üì± Enviar Mensagem WhatsApp</h2>
                
                <!-- Se√ß√£o de Controle do Servidor WhatsApp -->
                <div class="control-group" style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #007bff;">
                    <h3 style="margin-bottom: 10px; color: #007bff;">üîå Controle do Servidor WhatsApp</h3>
                    
                    <div id="whatsapp-server-status" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong>Status do Servidor:</strong> 
                                <span id="whatsapp-server-status-text" style="color: #666;">Verificando...</span>
                            </div>
                            <button class="export-btn" onclick="checkWhatsAppServerStatus()" style="background: #17a2b8; padding: 6px 12px; font-size: 12px;">
                                üîÑ Atualizar Status
                            </button>
                        </div>
                        <div id="whatsapp-connection-status" style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                            <strong>Status do WhatsApp:</strong> 
                            <span id="whatsapp-ready-status" style="color: #666;">Verificando...</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="export-btn" onclick="startWhatsAppServer()" id="start-whatsapp-server-btn" style="background: #28a745;">
                            ‚ñ∂Ô∏è Iniciar Servidor
                        </button>
                        <button class="reset-btn" onclick="stopWhatsAppServer()" id="stop-whatsapp-server-btn" style="display: none;">
                            ‚èπÔ∏è Parar Servidor
                        </button>
                        <button class="export-btn" onclick="showQRCode()" id="show-qr-btn" style="background: #ffc107; color: #000; display: none;">
                            üì± Ver QR Code
                        </button>
                        <button class="reset-btn" onclick="logoutWhatsApp()" id="logout-whatsapp-btn" style="display: none;">
                            üö™ Logout
                        </button>
                    </div>
                    
                    <div id="whatsapp-qr-container" style="display: none; margin-top: 15px; padding: 15px; background: white; border-radius: 5px; border: 2px solid #ffc107; text-align: center;">
                        <h4 style="margin-bottom: 10px; color: #856404;">üì± Escaneie o QR Code</h4>
                        <div id="whatsapp-qr-code" style="margin: 10px auto; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 5px; display: inline-block;">
                            <p style="color: #666; font-size: 12px;">Carregando QR Code...</p>
                        </div>
                        <p style="font-size: 11px; color: #666; margin-top: 10px;">
                            1. Abra o WhatsApp no celular<br>
                            2. V√° em Menu ‚Üí Dispositivos conectados<br>
                            3. Toque em "Conectar um dispositivo"<br>
                            4. Escaneie o QR Code acima
                        </p>
                        <button class="reset-btn" onclick="hideQRCode()" style="margin-top: 10px;">‚úï Fechar</button>
                    </div>
                    
                    <div id="whatsapp-server-logs" style="margin-top: 15px; max-height: 150px; overflow-y: auto; padding: 10px; background: #1e1e1e; color: #d4d4d4; border-radius: 5px; font-family: 'Courier New', monospace; font-size: 11px; display: none;">
                        <div>üì± Logs do servidor WhatsApp...</div>
                    </div>
                </div>
                
                <!-- Toggle entre Envio Individual e Envio em Lote -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
                    <button id="mode-individual-btn" class="tab active" onclick="switchMessengerMode('individual')" style="flex: 1; padding: 12px; font-size: 14px; font-weight: bold;">
                        üì§ Envio Individual
                    </button>
                    <button id="mode-batch-btn" class="tab" onclick="switchMessengerMode('batch')" style="flex: 1; padding: 12px; font-size: 14px; font-weight: bold;">
                        üì¶ Envio em Lote
                    </button>
                </div>
                
                <!-- Se√ß√£o: Sele√ß√£o de Imagem (Individual) -->
                <div id="individual-image-section" class="messenger-mode-section">
                    <div class="control-group">
                        <label>Imagem (opcional):</label>
                        <div id="image-upload-container">
                            <div class="file-input-wrapper">
                                <input type="file" id="image-upload" accept="image/*" onchange="handleImageUpload(event)">
                                <label for="image-upload" class="file-input-label">üì∑ Escolher Imagem</label>
                            </div>
                        </div>
                        <div id="image-preview-container" style="display: none;">
                            <div style="position: relative; margin-top: 10px; border: 2px solid #ddd; border-radius: 8px; padding: 5px; background: #f9f9f9;">
                                <img id="image-preview" class="image-preview" alt="Preview" style="max-width: 100%; border-radius: 5px;">
                                <button class="reset-btn" onclick="removeImage()" style="position: absolute; top: 10px; right: 10px; background: #dc3545; color: white; border: 2px solid white; padding: 8px 14px; border-radius: 50%; cursor: pointer; font-weight: bold; box-shadow: 0 3px 6px rgba(0,0,0,0.3); font-size: 16px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.transform='scale(1.1)'; this.style.background='#c82333';" onmouseout="this.style.transform='scale(1)'; this.style.background='#dc3545';" title="Remover imagem">üóëÔ∏è</button>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 5px; font-size: 12px; color: #0066cc; display: flex; justify-content: space-between; align-items: center;">
                                <span>‚úì Imagem carregada com sucesso</span>
                                <button onclick="removeImage()" style="background: transparent; border: 1px solid #0066cc; color: #0066cc; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">Remover</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o: Sele√ß√£o de Pasta (Lote) -->
                <div id="batch-folder-section" class="messenger-mode-section" style="display: none;">
                    <div class="control-group">
                        <label>Selecionar Pasta de Imagens:</label>
                        <div class="file-input-wrapper">
                            <input type="file" id="batch-folder-input" webkitdirectory directory multiple accept="image/*" onchange="handleBatchFolderSelect(event)">
                            <label for="batch-folder-input" class="file-input-label">üìÅ Selecionar Pasta</label>
                        </div>
                        <div id="batch-files-info" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                            <div style="font-size: 12px; color: #666;">
                                <strong>Arquivos selecionados:</strong> <span id="batch-files-count">0</span>
                            </div>
                            <div id="batch-files-list" style="max-height: 150px; overflow-y: auto; margin-top: 5px; font-size: 11px; color: #555;"></div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <label>Modo de Envio:</label>
                        <select id="batch-mode" onchange="toggleBatchMode()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <option value="all">Enviar para Todos (grupos/contatos selecionados)</option>
                            <option value="specific">Espec√≠fico (por unidade no nome do arquivo)</option>
                        </select>
                        <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
                            <strong>Modo Espec√≠fico:</strong> Extrai a unidade do nome do arquivo (ex: W_16_11_BAU_1.jpg ‚Üí BAU) e envia para o grupo correspondente no arquivo Unidades.xlsx
                        </small>
                    </div>
                    
                    <div id="batch-specific-info" style="display: none; margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 5px; border: 1px solid #ffc107;">
                        <div style="font-size: 12px; color: #856404;">
                            <strong>‚ÑπÔ∏è Modo Espec√≠fico Ativo:</strong><br>
                            ‚Ä¢ O sistema ir√° extrair a unidade do nome de cada arquivo<br>
                            ‚Ä¢ Buscar√° o grupo correspondente no arquivo Unidades.xlsx<br>
                            ‚Ä¢ Enviar√° cada imagem para o grupo correto automaticamente
                        </div>
                    </div>
                    
                    <div id="batch-progress" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #ddd;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>Progresso:</strong>
                            <span id="batch-progress-text">0 / 0</span>
                        </div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar" id="batch-progress-bar" style="width: 0%;"></div>
                        </div>
                        <div id="batch-current-file" style="margin-top: 10px; font-size: 12px; color: #666; font-style: italic;"></div>
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Texto/Legenda (opcional):</label>
                    <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                        <button class="text-editor-btn" onclick="saveCaption()" style="background: #28a745; color: white; padding: 6px 12px; font-size: 12px;" title="Salvar esta legenda">üíæ Salvar Legenda</button>
                        <button class="text-editor-btn" onclick="toggleSavedCaptions()" style="background: #17a2b8; color: white; padding: 6px 12px; font-size: 12px;" title="Ver legendas salvas">üìö Legendas Salvas</button>
                    </div>
                    <div class="text-editor-toolbar">
                        <button class="text-editor-btn" onclick="formatText('bold')" title="Negrito: *texto*">B</button>
                        <button class="text-editor-btn" onclick="formatText('italic')" title="It√°lico: _texto_">I</button>
                        <button class="text-editor-btn" onclick="formatText('strikethrough')" title="Tachado: ~texto~">S</button>
                        <button class="text-editor-btn" onclick="formatText('monospace')" title="Monoespa√ßado: ```texto```">M</button>
                        <div class="emoji-picker-container">
                            <button type="button" class="emoji-btn" onclick="toggleEmojiPicker()" title="Inserir emoji">üòÄ</button>
                            <div id="emoji-picker" class="emoji-picker">
                                <div class="emoji-category">
                                    <div class="emoji-category-title">Faces & Emo√ß√µes</div>
                                    <div class="emoji-grid" id="emoji-faces"></div>
                                </div>
                                <div class="emoji-category">
                                    <div class="emoji-category-title">Gestos & Pessoas</div>
                                    <div class="emoji-grid" id="emoji-people"></div>
                                </div>
                                <div class="emoji-category">
                                    <div class="emoji-category-title">Objetos & S√≠mbolos</div>
                                    <div class="emoji-grid" id="emoji-objects"></div>
                                </div>
                                <div class="emoji-category">
                                    <div class="emoji-category-title">Natureza & Comida</div>
                                    <div class="emoji-grid" id="emoji-nature"></div>
                                </div>
                                <div class="emoji-category">
                                    <div class="emoji-category-title">Atividades & Lugares</div>
                                    <div class="emoji-grid" id="emoji-activities"></div>
                                </div>
                                <div class="emoji-category">
                                    <div class="emoji-category-title">S√≠mbolos & Sinais</div>
                                    <div class="emoji-grid" id="emoji-symbols"></div>
                                </div>
                            </div>
                        </div>
                        <div style="flex: 1;"></div>
                        <small style="color: #666; font-size: 11px; align-self: center;">WhatsApp: *negrito* _it√°lico_ ~tachado~ ```mono```</small>
                    </div>
                    <textarea id="message-text" placeholder="Digite sua mensagem ou legenda aqui..." oninput="updateMessengerPreview()" style="border-radius: 0 0 5px 5px; border-top: none;"></textarea>
                </div>
                
                <!-- Painel de Legendas Salvas -->
                <div id="saved-captions-panel" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #ddd;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="font-size: 14px; margin: 0; color: #333;">üìö Legendas Salvas</h3>
                        <button class="reset-btn" onclick="toggleSavedCaptions()" style="padding: 5px 10px; font-size: 12px; margin: 0; width: auto;">‚úï Fechar</button>
                    </div>
                    <input type="text" id="search-captions" class="search-input" placeholder="üîç Pesquisar legendas..." oninput="filterSavedCaptions(this.value)" style="margin-bottom: 10px;">
                    <div id="saved-captions-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: white;">
                        <!-- Legendas ser√£o carregadas aqui -->
                    </div>
                    <div id="no-captions-message" style="text-align: center; padding: 20px; color: #999; font-style: italic; display: none;">
                        Nenhuma legenda salva ainda. Crie uma legenda e clique em "Salvar Legenda" para come√ßar.
                    </div>
                </div>
                
                <div class="control-group">
                    <label>Destinat√°rios:</label>
                    <button class="export-btn" onclick="loadGroups()" style="background: #28a745; margin-bottom: 10px;">üîÑ Carregar Grupos</button>
                    <button class="export-btn" onclick="loadContacts()" style="background: #17a2b8; margin-bottom: 10px;">üîÑ Carregar Contatos</button>
                    <button class="export-btn" onclick="document.getElementById('excel-file-input').click()" style="background: #6c757d; margin-bottom: 10px;">üìä Carregar Planilha de Contatos</button>
                    <input type="file" id="excel-file-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleExcelFile(event)">
                    
                    <div class="recipients-list" id="groups-list" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="font-size: 14px; margin: 0;">Grupos:</h3>
                            <button class="reset-btn" onclick="selectAllGroups()" style="padding: 5px 10px; font-size: 12px; margin: 0;">‚úì Selecionar Todos</button>
                        </div>
                        <input type="text" id="search-groups" class="search-input" placeholder="üîç Pesquisar grupos..." oninput="filterGroups(this.value)">
                        <div id="groups-container"></div>
                    </div>
                    
                    <div class="recipients-list" id="contacts-list" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 style="font-size: 14px; margin: 0;">Contatos:</h3>
                            <button class="reset-btn" onclick="selectAllContacts()" style="padding: 5px 10px; font-size: 12px; margin: 0;">‚úì Selecionar Todos</button>
                        </div>
                        <input type="text" id="search-contacts" class="search-input" placeholder="üîç Pesquisar contatos..." oninput="filterContacts(this.value)">
                        <div id="contacts-container"></div>
                    </div>
                    
                    <div class="control-group" style="margin-top: 10px;">
                        <label>Adicionar Contato Manual:</label>
                        <input type="text" id="manual-contact" placeholder="N√∫mero: 5511999999999" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        <button class="reset-btn" onclick="addManualContact()" style="margin-top: 5px;">‚ûï Adicionar</button>
                    </div>
                    
                    <div class="control-group" style="margin-top: 15px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 5px;">
                        <label style="font-weight: bold; color: #856404;">üß™ Teste de Envio:</label>
                        <p style="font-size: 12px; color: #856404; margin: 5px 0;">Envie uma mensagem de teste "oi" para um n√∫mero espec√≠fico:</p>
                        <input type="text" id="test-number" placeholder="N√∫mero: 5534997804675" value="5534997804675" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px;">
                        <button class="export-btn" onclick="testSendMessage()" style="background: #ffc107; color: #000; width: 100%;">üì§ Enviar "oi" de Teste</button>
                    </div>
                </div>
                
                <div class="selected-recipients" id="selected-recipients" style="display: none;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Destinat√°rios Selecionados:</label>
                    <div id="selected-list"></div>
                </div>
                
                <div class="control-group">
                    <label>Configura√ß√µes de Envio (Simula√ß√£o Humana):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label style="font-size: 12px; display: block; margin-bottom: 5px; font-weight: bold;">Primeira Mensagem:</label>
                            <div style="display: flex; gap: 5px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; display: block; margin-bottom: 3px; color: #666;">M√≠n (seg):</label>
                                    <input type="number" id="delay-first-min" value="25" min="20" max="50" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; display: block; margin-bottom: 3px; color: #666;">M√°x (seg):</label>
                                    <input type="number" id="delay-first-max" value="35" min="25" max="60" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 12px; display: block; margin-bottom: 5px; font-weight: bold;">Mensagens Subsequentes:</label>
                            <div style="display: flex; gap: 5px;">
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; display: block; margin-bottom: 3px; color: #666;">M√≠n (seg):</label>
                                    <input type="number" id="delay-subsequent-min" value="30" min="25" max="50" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 11px; display: block; margin-bottom: 3px; color: #666;">M√°x (seg):</label>
                                    <input type="number" id="delay-subsequent-max" value="45" min="30" max="70" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;">
                                </div>
                            </div>
                        </div>
                    </div>
                    <small style="color: #666; font-size: 11px; display: block; margin-bottom: 10px; line-height: 1.4;">
                        ‚è±Ô∏è Baseado em testes reais: humanos levam 25-35s para a primeira mensagem e 30-45s para mensagens subsequentes.<br>
                        üé≤ O sistema usa aleatoriedade m√°xima para parecer mais humano e evitar bloqueios.
                    </small>
                </div>
                
                <!-- Bot√µes de a√ß√£o (mudam conforme o modo) -->
                <div class="control-group" style="margin-top: 20px;">
                    <button class="export-btn" onclick="sendMessages()" id="send-btn" style="background: #dc3545; margin-top: 10px; display: block;">üöÄ Disparar Mensagens</button>
                    <button class="export-btn" onclick="startBatchSend()" id="batch-send-btn" style="background: #28a745; margin-top: 10px; display: none;">üöÄ Iniciar Envio em Lote</button>
                    <button class="reset-btn" onclick="clearSelection()" id="clear-individual-btn" style="margin-top: 10px; display: block;">üóëÔ∏è Limpar Sele√ß√£o</button>
                    <button class="reset-btn" onclick="clearBatchSelection()" id="clear-batch-btn" style="margin-top: 10px; display: none;">üóëÔ∏è Limpar Sele√ß√£o</button>
                </div>
                
                <div class="logs-container" style="margin-top: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold;">üìã Logs de Envio:</label>
                    <textarea id="messenger-logs" readonly style="height: 150px;"></textarea>
                </div>
            </div>
            
            <!-- Conte√∫do da aba Gmail Monitor -->
            <div id="tab-gmail" class="tab-content">
                <h2>üìß Monitor de E-mails Gmail</h2>
                
                <!-- Status de Conex√£o -->
                <div class="control-group" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px;">üîê Autentica√ß√£o</h3>
                    <div id="gmail-status" style="margin-bottom: 10px;">
                        <span id="gmail-status-text">‚ùå N√£o conectado</span>
                        <span id="gmail-email" style="margin-left: 10px; color: #666;"></span>
                    </div>
                    <button class="export-btn" onclick="connectGmail()" id="connect-gmail-btn">
                        üîê Conectar Gmail
                    </button>
                    <button class="reset-btn" onclick="disconnectGmail()" id="disconnect-gmail-btn" style="display: none; margin-left: 10px;">
                        Desconectar
                    </button>
                </div>
                
                <!-- Configura√ß√µes -->
                <h2>‚öôÔ∏è Configura√ß√µes</h2>
                <div class="control-group">
                    <label>Intervalo de Verifica√ß√£o (minutos):</label>
                    <input type="number" id="check-interval" min="1" max="60" value="5" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                </div>
                
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="auto-monitor" onchange="toggleAutoMonitor()">
                        Monitoramento Autom√°tico
                    </label>
                </div>
                
                <!-- Status do Monitor -->
                <h2>üìä Status</h2>
                <div id="monitor-status" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>Status:</strong> <span id="monitor-status-text">‚è∏Ô∏è Pausado</span></p>
                    <p><strong>√öltima Verifica√ß√£o:</strong> <span id="last-check">Nunca</span></p>
                    <p><strong>E-mails Processados:</strong> <span id="emails-processed">0</span></p>
                    <p><strong>E-mails Pendentes:</strong> <span id="emails-pending">0</span></p>
                </div>
                
                <!-- Bot√µes de Controle -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="export-btn" onclick="startGmailMonitor()" id="start-monitor-btn">
                        ‚ñ∂Ô∏è Iniciar Monitoramento
                    </button>
                    <button class="reset-btn" onclick="stopGmailMonitor()" id="stop-monitor-btn" style="display: none;">
                        ‚è∏Ô∏è Pausar Monitoramento
                    </button>
                    <button class="export-btn" onclick="processPendingEmails()" style="background: #ffc107; color: #000;">
                        üîÑ Processar Pendentes
                    </button>
                    <button class="export-btn" onclick="refreshGmailStatus()" style="background: #17a2b8;">
                        üîÑ Atualizar Status
                    </button>
                </div>
                
                <!-- Logs -->
                <h2>üìù Logs</h2>
                <div id="gmail-logs" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.5;">
                    <div>üìß Sistema de monitoramento Gmail iniciado...</div>
                </div>
                <button class="reset-btn" onclick="clearGmailLogs()" style="margin-top: 10px;">
                    üóëÔ∏è Limpar Logs
                </button>
                
                <!-- E-mails Pendentes -->
                <h2 style="margin-top: 30px;">üì¨ E-mails Pendentes</h2>
                <div id="pending-emails-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                    <p style="color: #666; text-align: center; padding: 20px;">Carregando e-mails pendentes...</p>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button class="export-btn" onclick="loadPendingEmails()" style="background: #6c757d;">
                        üîÑ Atualizar Lista
                    </button>
                    <button class="reset-btn" onclick="cleanPendingEmails()" style="background: #dc3545; color: white;">
                        üóëÔ∏è Limpar E-mails Inexistentes
                    </button>
                </div>
                <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
                    üí° "Limpar E-mails Inexistentes" remove do banco de dados os e-mails pendentes que n√£o existem mais no Gmail (deletados ou arquivados).
                </small>
                
                <!-- Hist√≥rico -->
                <h2 style="margin-top: 30px;">üìö Hist√≥rico</h2>
                <div id="emails-history" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                    <p style="color: #666; text-align: center; padding: 20px;">Carregando hist√≥rico...</p>
                </div>
                <button class="export-btn" onclick="loadEmailHistory()" style="margin-top: 10px; background: #6c757d;">
                    üîÑ Atualizar Hist√≥rico
                </button>
            </div>
            
        </div>
        
        <div class="preview-panel">
            <h1 id="preview-title">Preview do Banner</h1>
            <div class="preview-container" id="preview">
                <!-- Preview ser√° gerado aqui -->
            </div>
        </div>
    </div>
    
    <!-- Modal para selecionar coluna da planilha -->
    <div id="excel-column-modal" class="excel-column-modal">
        <div class="excel-column-modal-content">
            <div class="excel-column-modal-header">
                <h3>üìä Selecionar Coluna de Telefone</h3>
                <button class="excel-column-modal-close" onclick="closeExcelColumnModal()">√ó</button>
            </div>
            <p style="color: #666; margin-bottom: 15px;">Selecione qual coluna cont√©m os n√∫meros de telefone que ser√£o usados para envio:</p>
            <div id="excel-column-list" class="excel-column-list">
                <!-- Colunas ser√£o listadas aqui -->
            </div>
            <div id="excel-preview-container" style="margin-top: 20px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f8f9fa;">
                <strong style="font-size: 12px; color: #666;">Preview dos dados (primeiras 5 linhas):</strong>
                <table id="excel-preview-table" class="excel-preview-table">
                    <!-- Preview ser√° gerado aqui -->
                </table>
            </div>
            <div class="excel-column-modal-actions">
                <button class="reset-btn" onclick="closeExcelColumnModal()">Cancelar</button>
                <button class="export-btn" id="confirm-column-btn" onclick="confirmExcelColumn()" style="background: #28a745; opacity: 0.5; cursor: not-allowed;" disabled>Confirmar e Carregar</button>
            </div>
        </div>
    </div>
    
    <script>
        // Detectar URL do backend automaticamente
        function getBackendUrl() {
            // Se estiver definido via vari√°vel de ambiente ou meta tag
            const metaBackend = document.querySelector('meta[name="backend-url"]');
            if (metaBackend && metaBackend.content) {
                return metaBackend.content;
            }
            
            // Se estiver em produ√ß√£o (n√£o localhost), usar a mesma origem
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                return window.location.origin;
            }
            
            // Fallback para desenvolvimento local
            return 'http://localhost:5000';
        }
        
        // Fun√ß√£o para obter URL do servi√ßo WhatsApp
        function getWhatsAppUrl() {
            const metaWhatsApp = document.querySelector('meta[name="whatsapp-url"]');
            if (metaWhatsApp && metaWhatsApp.content) {
                return metaWhatsApp.content;
            }
            // Em produ√ß√£o, assumir que est√° na mesma origem (se integrado)
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                return window.location.origin;
            }
            return 'http://localhost:3001';
        }
        
        // Fun√ß√£o para obter URL do servi√ßo Gmail
        function getGmailUrl() {
            const metaGmail = document.querySelector('meta[name="gmail-url"]');
            if (metaGmail && metaGmail.content) {
                return metaGmail.content;
            }
            // Em produ√ß√£o, assumir que est√° na mesma origem (se integrado)
            if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                return window.location.origin;
            }
            return 'http://localhost:5001';
        }
        
        const BACKEND_URL = getBackendUrl();
        console.log('üîó Backend URL:', BACKEND_URL);
        
        const defaultValues = {
            'logo-ofertas-top': 50, 'logo-ofertas-left': 50, 'logo-ofertas-width': 450, 'logo-ofertas-height': 450, 'produtos-container-top': 650, 'produtos-container-gap': 20,
            'produto-container-padding': 15, 'produto-container-bg-color': '#FFFFFF', 'produto-container-bg-opacity': 90,
            'produto-container-border-radius': 15, 'produto-item-max-width': 320,
            'produto-imagem-container-height': 420, 'produto-imagem-container-margin-bottom': 30, 'produto-imagem-container-bg-color': '#FFFFFF', 'produto-imagem-container-bg-opacity': 80, 'produto-imagem-top': 20, 'produto-imagem-left': 50,
            'produto-imagem-width': 80, 'produto-imagem-max-width': 200, 'produto-imagem-height': 0,
            'produto-imagem-max-height': 240, 'base-produto-bottom': -100, 'base-produto-left': 50,
            'base-produto-width': 200, 'base-produto-max-width': 500, 'base-produto-height': 0,
            'base-produto-opacity': 90, 'desconto-badge-top': 8, 'desconto-badge-right': 8,
            'desconto-badge-bottom': 0, 'desconto-badge-left': 0, 'desconto-badge-width': 0,
            'desconto-badge-height': 0, 'desconto-badge-font-size': 16, 'desconto-badge-border-width': 0,
            'desconto-badge-border-color': '#FFFFFF', 'desconto-badge-shape': 'pill',
            'desconto-badge-color': '#FFFFFF', 'desconto-badge-bg-color': '#FF0000',
            'produto-nome-font-size': 16, 'produto-nome-color': '#1a1a1a',
            'produto-nome-font-family': "'Montserrat', sans-serif",
            'produto-nome-font-weight': 'bold',
            'produto-nome-font-style': 'normal',
            'produto-nome-top': 0, 'produto-nome-left': 0,
            'produto-codigo-font-size': 14, 'produto-codigo-color': '#666666',
            'produto-codigo-font-family': "'Roboto', sans-serif",
            'produto-codigo-font-weight': 'normal',
            'produto-codigo-font-style': 'normal',
            'produto-codigo-top': 0, 'produto-codigo-left': 0,
            'preco-comercial-font-size': 14, 'preco-comercial-color': '#e53935',
            'preco-comercial-font-family': "'Roboto', sans-serif",
            'preco-comercial-font-weight': 'normal',
            'preco-comercial-font-style': 'normal',
            'preco-de-top': 0, 'preco-de-left': 0, 'preco-de-font-size': 16,
            'preco-comercial-top': 0, 'preco-comercial-left': 0,
            'preco-por-top': 0, 'preco-por-left': 0, 'preco-por-font-size': 16,
            'preco-por-unidade-top': 0, 'preco-por-unidade-left': 0, 'preco-por-unidade-font-size': 16,
            'bandeira-top': 'auto', 'bandeira-right': 'auto', 'bandeira-bottom': 0, 'bandeira-left': 'auto',
            'bandeira-width': 0, 'bandeira-height': 0,
            'preco-promocional-font-size': 28, 'preco-promocional-color': '#FF6B00',
            'preco-promocional-font-family': "'Montserrat', sans-serif",
            'preco-promocional-font-weight': 'bold',
            'preco-promocional-font-style': 'normal',
            'preco-promocional-top': 0, 'preco-promocional-left': 0,
            'preco-rs-color': '#FF6B00', 'preco-rs-font-size': 0.5, 'preco-rs-vertical-align': 'center',
            'preco-decimal-color': '#FF6B00', 'preco-decimal-font-size': 0.65, 'preco-decimal-vertical-align': 'top',
            'call-action-top': 0,
            'call-action-bottom': 120, 'call-action-left': 50, 'call-action-width': 500, 'call-action-height': 100,
            'logo-inferior-bottom': 20, 'logo-inferior-left': 50, 'logo-inferior-width': 350,
            'logo-inferior-height': 80, 'logo-superior-top': 20, 'logo-superior-right': 20,
            'logo-superior-width': 150, 'logo-superior-height': 0, 'footer-font-size': 26,
            'footer-font-family': "'Montserrat', sans-serif",
            'footer-color': '#FFFFFF', 'footer-width': 900, 'footer-left': 50, 'footer-top': 0,
            'footer-bottom': 5, 'footer-rotation': 'horizontal',
            'impulsionamento-text': 'Digite sua frase de impulsionamento aqui...',
            'impulsionamento-font-family': "'Bebas Neue', sans-serif",
            'impulsionamento-color': '#FFFFFF', 'impulsionamento-font-size': 32,
            'impulsionamento-top': 0, 'impulsionamento-bottom': 0, 'impulsionamento-left': 540,
            'impulsionamento-right': 0, 'impulsionamento-width': 800, 'impulsionamento-height': 0,
            'separador-color': '#FF0000', 'separador-width': 3, 'separador-height': 200,
            'separador-top': 0, 'separador-left': 0
        };
        
        function getValue(id) {
            const el = document.getElementById(id);
            if (!el) {
                // Se o elemento n√£o existe, tentar usar valor padr√£o
                if (defaultValues.hasOwnProperty(id)) {
                    return defaultValues[id];
                }
                return '';
            }
            if (id === 'base-produto-opacity' || id === 'produto-container-bg-opacity' || id === 'produto-imagem-container-bg-opacity') return el.value / 100;
            if (id.includes('color')) return el.value;

            const rawValueIds = [
                'produto-nome-font-family', 'produto-nome-font-weight', 'produto-nome-font-style',
                'produto-codigo-font-family', 'produto-codigo-font-weight', 'produto-codigo-font-style',
                'preco-comercial-font-family', 'preco-comercial-font-weight', 'preco-comercial-font-style',
                'preco-promocional-font-family', 'preco-promocional-font-weight', 'preco-promocional-font-style',
                'desconto-badge-shape', 'footer-rotation', 'footer-font-family', 'impulsionamento-font-family', 'impulsionamento-text',
                'preco-rs-vertical-align', 'preco-decimal-vertical-align'
            ];
            if (rawValueIds.includes(id)) return el.value;
            
            // Valores em em (para font-size do R$ e decimal)
            if (id === 'preco-rs-font-size' || id === 'preco-decimal-font-size') {
                return el.value + 'em';
            }
            
            // Valores que retornam apenas o n√∫mero (sem px) - s√£o usados com px no HTML inline
            const numberOnlyIds = ['preco-de-font-size', 'preco-por-font-size', 'preco-por-unidade-font-size', 'preco-de-top', 'preco-de-left', 'preco-por-top', 'preco-por-left', 'preco-por-unidade-top', 'preco-por-unidade-left'];
            if (numberOnlyIds.includes(id)) {
                return el.value; // Retorna apenas o n√∫mero, sem unidade
            }
            
            const percentLeftIds = ['produto-imagem-left', 'base-produto-left', 'call-action-left', 'logo-inferior-left', 'logo-ofertas-left', 'footer-left'];
            if (percentLeftIds.includes(id)) return el.value + '%';
            
            if (id === 'base-produto-width' || id === 'produto-imagem-width') return el.value + '%';
            
            const autoPxIds = ['produto-imagem-height', 'base-produto-height', 'desconto-badge-width', 'desconto-badge-height', 'bandeira-width', 'bandeira-height', 'logo-superior-height', 'call-action-top', 'footer-top', 'impulsionamento-height'];
            if (autoPxIds.includes(id)) {
                return el.value == 0 ? 'auto' : el.value + 'px';
            }
            
            // impulsionamento-top: 0px √© v√°lido (topo), n√£o deve ser 'auto'
            if (id === 'impulsionamento-top') {
                return el.value + 'px';
            }
            
            if (id === 'desconto-badge-left' || id === 'desconto-badge-bottom' || id === 'footer-bottom' || id === 'call-action-bottom' || id === 'impulsionamento-bottom' || id === 'impulsionamento-right' || id === 'bandeira-left' || id === 'bandeira-bottom' || id === 'bandeira-right' || id === 'bandeira-top') {
                return el.value == 0 ? 'auto' : el.value + 'px';
            }
            
            return el.value + 'px';
        }
        
        function getContainerBgColor() {
            const colorEl = document.getElementById('produto-container-bg-color');
            const opacityEl = document.getElementById('produto-container-bg-opacity');
            if (!colorEl || !opacityEl) return 'rgba(255, 255, 255, 0.9)';
            const color = colorEl.value;
            const opacity = opacityEl.value / 100;
            
            // Se a opacidade for 0, retornar transparente para que o fundo n√£o seja vis√≠vel
            if (opacity === 0) {
                return 'transparent';
            }
            
            const r = parseInt(color.substr(1, 2), 16);
            const g = parseInt(color.substr(3, 2), 16);
            const b = parseInt(color.substr(5, 2), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        
        function getImagemContainerBgColor() {
            const colorEl = document.getElementById('produto-imagem-container-bg-color');
            const opacityEl = document.getElementById('produto-imagem-container-bg-opacity');
            if (!colorEl || !opacityEl) return 'rgba(255, 240, 240, 0.8)';
            const color = colorEl.value;
            const opacity = opacityEl.value / 100;
            
            // Se a opacidade for 0, retornar transparente para que o fundo n√£o seja vis√≠vel
            if (opacity === 0) {
                return 'transparent';
            }
            
            const r = parseInt(color.substr(1, 2), 16);
            const g = parseInt(color.substr(3, 2), 16);
            const b = parseInt(color.substr(5, 2), 16);
            return `rgba(${r}, ${g}, ${b}, ${opacity})`;
        }
        
        function getBadgeShape() {
            const el = document.getElementById('desconto-badge-shape');
            return el ? el.value : 'pill';
        }
        
        // Fun√ß√£o para gerar clip-path de c√≠rculo serrilhado com c√°lculo matem√°tico
        function generateStarburstClipPath() {
            const numRays = 24; // N√∫mero de raios
            const outerRadius = 50; // Raio externo em % (50% = borda do elemento)
            const innerRadius = 44; // Raio interno em % (cria os vales entre os raios)
            const centerX = 50; // Centro X em %
            const centerY = 50; // Centro Y em %
            const angleStep = (360 / numRays) * (Math.PI / 180); // Passo angular em radianos
            
            const points = [];
            
            // Calcular pontos alternando entre raio externo e interno
            for (let i = 0; i < numRays * 2; i++) {
                const angle = i * angleStep / 2; // Cada raio tem 2 pontos (externo e interno)
                const isOuterPoint = i % 2 === 0; // Pontos pares s√£o externos, √≠mpares s√£o internos
                const radius = isOuterPoint ? outerRadius : innerRadius;
                
                // Calcular coordenadas usando trigonometria
                // Cos e Sin no SVG s√£o medidos a partir do topo (0¬∞ = topo)
                const x = centerX + radius * Math.sin(angle);
                const y = centerY - radius * Math.cos(angle);
                
                points.push(`${x.toFixed(2)}% ${y.toFixed(2)}%`);
            }
            
            return `polygon(${points.join(', ')})`;
        }
        
        // Fun√ß√£o para aplicar font-weight automaticamente quando uma fonte Goldplay com data-weight √© selecionada
        function handleFontFamilyChange(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const selectedOption = select.options[select.selectedIndex];
            const dataWeight = selectedOption.getAttribute('data-weight');
            
            // Se a op√ß√£o selecionada tem data-weight, atualizar o font-weight correspondente
            if (dataWeight) {
                // Mapear font-family IDs para seus font-weight IDs correspondentes
                const fontWeightMap = {
                    'produto-nome-font-family': 'produto-nome-font-weight',
                    'produto-codigo-font-family': 'produto-codigo-font-weight',
                    'preco-comercial-font-family': 'preco-comercial-font-weight',
                    'preco-promocional-font-family': 'preco-promocional-font-weight',
                    'impulsionamento-font-family': null // impulsionamento n√£o tem controle separado de font-weight
                };
                
                const fontWeightId = fontWeightMap[selectId];
                if (fontWeightId) {
                    const fontWeightSelect = document.getElementById(fontWeightId);
                    if (fontWeightSelect) {
                        // Converter peso num√©rico para valor do select
                        // data-weight: 300, 400, 500, 600, 700, 900
                        // select options: normal (400), bold (700)
                        const weightValue = parseInt(dataWeight);
                        if (weightValue >= 700) {
                            fontWeightSelect.value = 'bold';
                        } else if (weightValue >= 500) {
                            fontWeightSelect.value = 'normal'; // Para Medium e SemiBold, usar normal como base
                        } else {
                            fontWeightSelect.value = 'normal';
                        }
                    }
                }
            }
        }
        
        function updateCSS() {
            // Salvar estado do modo drag antes de atualizar (para preservar ap√≥s regenera√ß√£o)
            const wasDragModeActive = dragMode;
            
            const keys = Object.keys(defaultValues);
            keys.forEach(key => {
                const valEl = document.getElementById(key + '-val');
                if (valEl) {
                    const el = document.getElementById(key);
                    if (el) {
                        if (key === 'base-produto-opacity' || key === 'produto-container-bg-opacity' || key === 'produto-imagem-container-bg-opacity') {
                            valEl.textContent = (el.value / 100).toFixed(2);
                        } else if (key.includes('color')) {
                            valEl.textContent = el.value;
                        } else if (key === 'preco-rs-font-size' || key === 'preco-decimal-font-size') {
                            valEl.textContent = el.value + 'em';
                        } else if (key === 'preco-de-font-size' || key === 'preco-por-font-size' || key === 'preco-por-unidade-font-size' || key === 'footer-font-size') {
                            valEl.textContent = el.value + 'px';
                        } else if (key === 'preco-de-top' || key === 'preco-de-left' || key === 'preco-por-top' || key === 'preco-por-left' || key === 'preco-por-unidade-top' || key === 'preco-por-unidade-left') {
                            valEl.textContent = el.value + 'px';
                        } else if (key === 'produto-imagem-height' || key === 'base-produto-height' || key === 'desconto-badge-width' || key === 'desconto-badge-height' || key === 'bandeira-width' || key === 'bandeira-height' || key === 'logo-superior-height' || key === 'call-action-top' || key === 'footer-top') {
                            valEl.textContent = el.value == 0 ? 'auto' : el.value + 'px';
                        } else if (key === 'desconto-badge-left' || key === 'desconto-badge-bottom' || key === 'footer-bottom' || key === 'call-action-bottom' || key === 'bandeira-left' || key === 'bandeira-bottom' || key === 'bandeira-right' || key === 'bandeira-top') {
                            valEl.textContent = el.value == 0 ? 'auto' : el.value + 'px';
                        } else if (['produto-imagem-left', 'base-produto-left', 'call-action-left', 'logo-inferior-left', 'logo-ofertas-left', 'footer-left'].includes(key)) {
                            valEl.textContent = el.value + '%';
                        } else if (key === 'base-produto-width' || key === 'produto-imagem-width') {
                            valEl.textContent = el.value + '%';
                        } else if (key === 'desconto-badge-border-width') {
                            valEl.textContent = el.value + 'px';
                        } else if (key.includes('left')) {
                            valEl.textContent = el.value + 'px';
                        } else {
                            valEl.textContent = el.value + 'px';
                        }
                    }
                }
            });
            updatePreview().then(() => {
                // Configurar drag AP√ìS o preview ser atualizado, preservando o estado do modo
                // Se o modo estava ativo, garantir que permanece ativo
                if (wasDragModeActive) {
                    dragMode = true; // Garantir que o modo est√° ativo
                    setupUniversalDrag();
                }
            });
        }
        
        function updatePreview() {
            const previewDiv = document.getElementById('preview');
            const previewTitle = document.getElementById('preview-title');
            if (!previewDiv) return Promise.resolve();
            
            // Verificar qual aba est√° ativa
            const editorTab = document.getElementById('tab-editor');
            const messengerTab = document.getElementById('tab-messenger');
            
            if (editorTab && editorTab.classList.contains('active')) {
                // Mostrar preview do banner
                if (previewTitle) previewTitle.textContent = 'Preview do Banner';
                return generatePreviewHTML().then(html => {
                    previewDiv.innerHTML = html;
                    return Promise.resolve();
                }).catch(error => {
                    console.error('Erro ao gerar preview:', error);
                    previewDiv.innerHTML = '<div style="padding: 20px; color: red;">Erro ao carregar preview. Verifique se o servidor est√° rodando.</div>';
                    return Promise.resolve();
                });
            } else if (messengerTab && messengerTab.classList.contains('active')) {
                // Mostrar preview da imagem do Mensager
                if (previewTitle) previewTitle.textContent = 'Preview da Imagem';
                updateMessengerPreview();
                return Promise.resolve();
            }
            return Promise.resolve();
        }
        
        function updateMessengerPreview() {
            const previewDiv = document.getElementById('preview');
            const imagePreview = document.getElementById('image-preview');
            const messageText = document.getElementById('message-text');
            
            if (!previewDiv) return;
            
            let html = '<div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">';
            
            if (imagePreview && imagePreview.src && imagePreview.src !== '') {
                html += `<img src="${imagePreview.src}" style="max-width: 100%; max-height: 70%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 20px;" alt="Preview da imagem">`;
            } else {
                html += '<div style="width: 100%; height: 400px; background: #f0f0f0; border: 2px dashed #ccc; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #999; margin-bottom: 20px;">üì∑ Nenhuma imagem carregada</div>';
            }
            
            if (messageText && messageText.value.trim()) {
                // Converter formata√ß√£o WhatsApp para HTML para preview
                let formattedText = messageText.value;
                
                // Escapar HTML para seguran√ßa
                formattedText = formattedText.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                // Primeiro, proteger blocos de c√≥digo (monospace) com placeholders
                const codeBlocks = [];
                let codeIndex = 0;
                formattedText = formattedText.replace(/```([\s\S]*?)```/g, (match, content) => {
                    const placeholder = `__CODE_BLOCK_${codeIndex}__`;
                    // Escapar HTML no conte√∫do do c√≥digo
                    const escapedContent = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    codeBlocks[codeIndex] = `<code style="background: #f4f4f4; padding: 4px 8px; border-radius: 3px; font-family: 'Courier New', monospace; display: block; white-space: pre-wrap; margin: 5px 0; border-left: 3px solid #007bff;">${escapedContent}</code>`;
                    codeIndex++;
                    return placeholder;
                });
                
                // Processar negrito: *texto* (um asterisco)
                // Regex mais simples e compat√≠vel
                formattedText = formattedText.replace(/\*([^\*\n]+?)\*/g, '<strong>$1</strong>');
                
                // Processar it√°lico: _texto_ (underscore)
                formattedText = formattedText.replace(/_([^_\n]+?)_/g, '<em>$1</em>');
                
                // Processar tachado: ~texto~ (til)
                formattedText = formattedText.replace(/~([^~\n]+?)~/g, '<s style="text-decoration: line-through;">$1</s>');
                
                // Restaurar blocos de c√≥digo
                codeBlocks.forEach((codeHtml, idx) => {
                    formattedText = formattedText.replace(`__CODE_BLOCK_${idx}__`, codeHtml);
                });
                
                // Quebras de linha
                formattedText = formattedText.replace(/\n/g, '<br>');
                
                html += `<div style="width: 100%; max-width: 600px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-family: Arial, sans-serif; line-height: 1.6; color: #333;">${formattedText}</div>`;
            } else {
                html += '<div style="width: 100%; max-width: 600px; background: #f9f9f9; padding: 20px; border-radius: 10px; color: #999; text-align: center; border: 2px dashed #ddd;">üí¨ Nenhum texto adicionado</div>';
            }
            
            html += '</div>';
            previewDiv.innerHTML = html;
        }
        
        function generateCSS() {
            const badgeShape = getBadgeShape();
            let badgeRadius = '18px';
            let badgeClipPath = 'none';
            
            if (badgeShape === 'circle') {
                badgeRadius = '50%';
            } else if (badgeShape === 'starburst') {
                // Formato c√≠rculo com bordas serrilhadas - calculado matematicamente
                badgeRadius = '0';
                // Usar fun√ß√£o matem√°tica para gerar clip-path preciso
                badgeClipPath = generateStarburstClipPath();
            }
            
            const borderWidthControl = document.getElementById('desconto-badge-border-width');
            const badgeBorderWidthValue = borderWidthControl ? (parseInt(borderWidthControl.value, 10) || 0) : 0;
            const badgeBorderColor = getValue('desconto-badge-border-color');
            const badgeBorder = badgeBorderWidthValue > 0 ? `${badgeBorderWidthValue}px solid ${badgeBorderColor}` : 'none';
            const badgeTop = getValue('desconto-badge-top');
            const badgeRight = getValue('desconto-badge-right');
            const badgeBottom = getValue('desconto-badge-bottom');
            const badgeLeft = getValue('desconto-badge-left');
            const badgePositionParts = [];
            if (badgeBottom === 'auto' && badgeTop !== 'auto') {
                badgePositionParts.push(`top: ${badgeTop};`);
            }
            if (badgeLeft === 'auto' && badgeRight !== 'auto') {
                badgePositionParts.push(`right: ${badgeRight};`);
            }
            if (badgeBottom !== 'auto') {
                badgePositionParts.push(`bottom: ${badgeBottom};`);
            }
            if (badgeLeft !== 'auto') {
                badgePositionParts.push(`left: ${badgeLeft};`);
            }
            const badgePosition = badgePositionParts.join(' ');

            const footerTop = getValue('footer-top');
            const footerBottom = getValue('footer-bottom');
            const footerPositionParts = [];
            if (footerBottom !== 'auto') footerPositionParts.push(`bottom: ${footerBottom};`);
            if (footerTop !== 'auto') footerPositionParts.push(`top: ${footerTop};`);
            let footerPosition = footerPositionParts.length ? footerPositionParts.join(' ') : 'bottom: 0px;';
            if (!footerPosition.endsWith(' ')) footerPosition += ' ';
            const footerRotationValue = document.getElementById('footer-rotation') ? document.getElementById('footer-rotation').value : 'horizontal';
            const footerTransform = footerRotationValue === 'vertical'
                ? 'translate(-50%, 0) rotate(-90deg)'
                : 'translateX(-50%)';

            const impulsionamentoTop = getValue('impulsionamento-top');
            const impulsionamentoBottom = getValue('impulsionamento-bottom');
            const impulsionamentoLeft = getValue('impulsionamento-left');
            const impulsionamentoRight = getValue('impulsionamento-right');
            
            // Simplificar: sempre usar top (como logo-ofertas-top funciona)
            // Se bottom tiver valor, usar bottom; sen√£o, usar top
            const bottomControl = document.getElementById('impulsionamento-bottom');
            const bottomValue = bottomControl ? parseInt(bottomControl.value) : 0;
            const topControl = document.getElementById('impulsionamento-top');
            const topValue = topControl ? parseInt(topControl.value) : 0;
            
            let impulsionamentoPosition = '';
            if (bottomValue > 0) {
                impulsionamentoPosition = `bottom: ${impulsionamentoBottom};`;
            } else {
                // Sempre usar top quando bottom for 0 (mesmo que top seja 0px)
                impulsionamentoPosition = `top: ${topValue}px;`;
            }
            
            // Left/Right: sempre usar left se tiver valor, sen√£o right, sen√£o centralizar
            const leftControl = document.getElementById('impulsionamento-left');
            const leftValue = leftControl ? parseInt(leftControl.value) : 540;
            const rightControl = document.getElementById('impulsionamento-right');
            const rightValue = rightControl ? parseInt(rightControl.value) : 0;
            
            if (rightValue > 0) {
                impulsionamentoPosition += ` right: ${rightValue}px;`;
            } else {
                impulsionamentoPosition += ` left: ${leftValue}px;`;
            }
            const impulsionamentoWidth = getValue('impulsionamento-width');
            const impulsionamentoHeight = getValue('impulsionamento-height');
            const impulsionamentoText = getImpulsionamentoText();

            return `
                .logo-ofertas { top: ${getValue('logo-ofertas-top')}; width: ${getValue('logo-ofertas-width')}; height: ${getValue('logo-ofertas-height')}; }
                .produtos-container { top: ${getValue('produtos-container-top')}; gap: ${getValue('produtos-container-gap')}; }
                .produto-container { padding: ${getValue('produto-container-padding')}; background: ${getContainerBgColor()}; border-radius: ${getValue('produto-container-border-radius')}; }
                .produto-imagem-container { height: ${getValue('produto-imagem-container-height')}; margin-bottom: ${getValue('produto-imagem-container-margin-bottom')}; }
                .produto-imagem { top: ${getValue('produto-imagem-top')}; left: ${getValue('produto-imagem-left')}; width: ${getValue('produto-imagem-width')}; max-width: ${getValue('produto-imagem-max-width')}; height: ${getValue('produto-imagem-height')}; max-height: ${getValue('produto-imagem-max-height')}; }
                .base-produto { bottom: ${getValue('base-produto-bottom')}; left: ${getValue('base-produto-left')}; width: ${getValue('base-produto-width')}; max-width: ${getValue('base-produto-max-width')}; height: ${getValue('base-produto-height')}; opacity: ${getValue('base-produto-opacity')}; }
                .desconto-badge { ${badgePosition} width: ${getValue('desconto-badge-width')}; height: ${getValue('desconto-badge-height')}; font-size: ${getValue('desconto-badge-font-size')}; color: ${getValue('desconto-badge-color')}; background-color: ${getValue('desconto-badge-bg-color')}; border-radius: ${badgeRadius}; ${badgeClipPath !== 'none' ? `clip-path: ${badgeClipPath};` : ''} border: ${badgeBorder}; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; box-sizing: border-box; white-space: normal; min-width: fit-content; z-index: 60; padding: 8px 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
                .produto-nome { font-size: ${getValue('produto-nome-font-size')}; color: ${getValue('produto-nome-color')}; font-family: ${getValue('produto-nome-font-family')}; font-weight: ${getValue('produto-nome-font-weight')}; font-style: ${getValue('produto-nome-font-style')}; }
                .produto-codigo { font-size: ${getValue('produto-codigo-font-size')}; color: ${getValue('produto-codigo-color')}; font-family: ${getValue('produto-codigo-font-family')}; font-weight: ${getValue('produto-codigo-font-weight')}; font-style: ${getValue('produto-codigo-font-style')}; }
                .precos { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 6px; }
                .preco-linhas { display: flex; gap: 16px; align-items: baseline; justify-content: center; flex-wrap: wrap; }
                .preco-label { font-family: ${getValue('produto-nome-font-family')}; font-weight: ${getValue('produto-nome-font-weight')}; font-style: ${getValue('produto-nome-font-style')}; color: ${getValue('produto-nome-color')}; font-size: ${getValue('produto-nome-font-size')}; }
                .preco-comercial-valor { font-family: ${getValue('preco-comercial-font-family')}; font-weight: ${getValue('preco-comercial-font-weight')}; font-style: ${getValue('preco-comercial-font-style')}; font-size: ${getValue('preco-comercial-font-size')}; color: ${getValue('preco-comercial-color')}; display: inline-flex; align-items: baseline; }
                .preco-comercial-rs { font-size: 0.6em; vertical-align: baseline; }
                .preco-comercial-valor-num { }
                .preco-promocional { font-family: ${getValue('preco-promocional-font-family')}; font-weight: ${getValue('preco-promocional-font-weight')}; font-style: ${getValue('preco-promocional-font-style')}; color: ${getValue('preco-promocional-color')}; display: inline-flex; align-items: flex-start; line-height: 1; }
                .preco-rs { font-size: ${getValue('preco-rs-font-size')}; margin-right: 5px; color: ${getValue('preco-rs-color')}; align-self: ${getValue('preco-rs-vertical-align')}; }
                .preco-inteiro { font-size: 1em; vertical-align: baseline; }
                .preco-virgula { font-size: ${getValue('preco-decimal-font-size')}; color: ${getValue('preco-decimal-color')}; vertical-align: ${getValue('preco-decimal-vertical-align')}; }
                .preco-decimal { font-size: ${getValue('preco-decimal-font-size')}; color: ${getValue('preco-decimal-color')}; vertical-align: ${getValue('preco-decimal-vertical-align')}; }
                .call-action { top: ${getValue('call-action-top')}; bottom: ${getValue('call-action-bottom')}; left: ${getValue('call-action-left')}; width: ${getValue('call-action-width')}; height: ${getValue('call-action-height')}; }
                .logo-inferior { position: absolute; left: 50%; transform: translateX(-50%); z-index: 10; object-fit: contain; }
                .logo-superior { position: absolute; z-index: 10; object-fit: contain; }
                .footer-text { position: absolute; left: ${getValue('footer-left')}; width: ${getValue('footer-width')}; ${footerPosition} color: ${getValue('footer-color')}; font-size: ${getValue('footer-font-size')}px; transform: ${footerTransform}; transform-origin: center; font-family: ${getValue('footer-font-family')}; z-index: 25; line-height: 1.2; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.6); white-space: normal; font-weight: 500; }
                .footer-line1 { font-size: ${getValue('footer-font-size')}px; font-weight: 600; margin: 0; }
                .footer-line2 { font-size: calc(${getValue('footer-font-size')} * 0.85)px; font-weight: 400; margin: 0; }
                .unidade-text { position: absolute; top: 30px; left: 40px; color: #FFFFFF; font-size: 42px; font-family: 'Montserrat', sans-serif; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 3px 6px rgba(0,0,0,0.45); z-index: 30; }
                .impulsionamento-text { position: absolute; ${impulsionamentoPosition} width: ${impulsionamentoWidth}; ${impulsionamentoHeight !== 'auto' ? `height: ${impulsionamentoHeight};` : ''} font-family: ${getValue('impulsionamento-font-family')}; font-size: ${getValue('impulsionamento-font-size')}; color: ${getValue('impulsionamento-color')}; z-index: 40; text-align: center; white-space: normal; word-wrap: break-word; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
                .separador-produto { position: absolute; width: ${getValue('separador-width')}; height: ${getValue('separador-height')}; background-color: ${getValue('separador-color')}; top: ${getValue('separador-top')}; z-index: 15; }
            `;
        }
        
                                 // Cache de imagens carregadas
        const imageCache = {};
        
        // Fun√ß√£o para carregar imagem do servidor
        async function loadImageFromServer(imageName) {
            if (imageCache[imageName]) {
                return imageCache[imageName];
            }
            
            try {
                const response = await fetch(`${BACKEND_URL}/get-image/${imageName}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        imageCache[imageName] = data.data;
                        return data.data;
                    }
                }
            } catch (err) {
                console.warn(`N√£o foi poss√≠vel carregar imagem ${imageName} do servidor:`, err);
            }
            
            return null;
        }
        
        // Carregar todas as imagens do servidor
        async function loadAllImages() {
            const imageNames = ['base-produto', 'call-action', 'fundo', 'logo-inferior', 'logo-ofertas', 'logo-superior'];
            const promises = imageNames.map(name => loadImageFromServer(name));
            await Promise.all(promises);
            // Atualizar preview ap√≥s carregar imagens
            updateCSS();
        }
        
        // Mapear n√∫mero do produto para c√≥digo real
        function getProductCode(productNum) {
            const codes = { 1: 300, 2: 2, 3: 1026 };
            return codes[productNum] || 300;
        }
        
        // Cache de imagens de produtos
        const productImageCache = {};
        
        // Obter URL da imagem do produto (processada do cache ou URL direta)
        async function getProductImageUrl(productNum) {
            const codigo = getProductCode(productNum);
            
            // Verificar cache primeiro
            if (productImageCache[codigo]) {
                return productImageCache[codigo];
            }
            
            // Tentar carregar do servidor (retorna imagem processada do cache se tiver, sen√£o URL original)
            try {
                const response = await fetch(`${BACKEND_URL}/get-product-image/${codigo}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success' && data.data) {
                        const imageUrl = data.data;
                        // Armazenar no cache (pode ser base64 PNG processada ou URL JPG original)
                        productImageCache[codigo] = imageUrl;
                        return imageUrl;
                    }
                }
            } catch (error) {
                console.warn(`[PREVIEW] Erro ao carregar imagem para c√≥digo ${codigo}:`, error);
            }
            
            // Fallback: usar URL original diretamente
            const fallbackUrl = `https://fdvmtz.jbs.com.br/static/erp/img/${codigo}.jpg`;
            productImageCache[codigo] = fallbackUrl;
            return fallbackUrl;
        }
        
        // Obter imagem carregada ou placeholder
        function getImage(imageName, placeholder) {
            return imageCache[imageName] || placeholder;
        }
        
        async function generateProductCard(productNum) {
            const codigo = getProductCode(productNum);
            const imageUrl = await getProductImageUrl(productNum);
            const placeholderSvg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='180'%3E%3Crect fill='%23ddd' width='200' height='180'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999'%3EProduto ${productNum}%3C/text%3E%3C/svg%3E`;
            const baseProdutoPlaceholder = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='80' viewBox='0 0 500 80'%3E%3Cdefs%3E%3ClinearGradient id='woodGrad' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23d4a574;stop-opacity:1' /%3E%3Cstop offset='50%25' style='stop-color:%23b88652;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23966b3d;stop-opacity:1' /%3E%3C/linearGradient%3E%3Cfilter id='woodShadow'%3E%3CfeGaussianBlur in='SourceAlpha' stdDeviation='2'/%3E%3CfeOffset dx='0' dy='3' result='offsetblur'/%3E%3CfeComponentTransfer%3E%3CfeFuncA type='linear' slope='0.4'/%3E%3C/feComponentTransfer%3E%3CfeMerge%3E%3CfeMergeNode/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Cellipse cx='250' cy='40' rx='240' ry='30' fill='url(%23woodGrad)' filter='url(%23woodShadow)'/%3E%3Cellipse cx='250' cy='35' rx='235' ry='28' fill='url(%23woodGrad)' opacity='0.8'/%3E%3Cpath d='M 50 35 Q 125 30 200 35 Q 275 40 350 35 Q 425 30 500 35' stroke='%23855e2f' stroke-width='1' fill='none' opacity='0.3'/%3E%3Cpath d='M 60 45 Q 150 40 250 45 Q 350 50 440 45' stroke='%23855e2f' stroke-width='1' fill='none' opacity='0.2'/%3E%3C/svg%3E`;
            const baseProdutoImg = getImage('base-produto', baseProdutoPlaceholder);
            const badgeShape = getBadgeShape();
            let badgeRadius = '18px';
            let badgeClipPath = 'none';
            
            if (badgeShape === 'circle') {
                badgeRadius = '50%';
            } else if (badgeShape === 'starburst') {
                // Formato c√≠rculo com bordas serrilhadas - calculado matematicamente
                badgeRadius = '0';
                // Usar fun√ß√£o matem√°tica para gerar clip-path preciso
                badgeClipPath = generateStarburstClipPath();
            }
            
            const borderWidthControl = document.getElementById('desconto-badge-border-width');
            const badgeBorderWidthValue = borderWidthControl ? (parseInt(borderWidthControl.value, 10) || 0) : 0;
            const badgeBorderColor = getValue('desconto-badge-border-color');
            const badgeBorder = badgeBorderWidthValue > 0 ? `${badgeBorderWidthValue}px solid ${badgeBorderColor}` : 'none';
            const badgeTop = getValue('desconto-badge-top');
            const badgeRight = getValue('desconto-badge-right');
            const badgeBottom = getValue('desconto-badge-bottom');
            const badgeLeft = getValue('desconto-badge-left');
            const badgePositionParts = [];
            if (badgeBottom === 'auto' && badgeTop !== 'auto') {
                badgePositionParts.push(`top: ${badgeTop}`);
            }
            if (badgeLeft === 'auto' && badgeRight !== 'auto') {
                badgePositionParts.push(`right: ${badgeRight}`);
            }
            if (badgeBottom !== 'auto') {
                badgePositionParts.push(`bottom: ${badgeBottom}`);
            }
            if (badgeLeft !== 'auto') {
                badgePositionParts.push(`left: ${badgeLeft}`);
            }
            const badgeStyleParts = [
                'position: absolute',
                ...badgePositionParts,
                `background-color: ${getValue('desconto-badge-bg-color')}`,
                `color: ${getValue('desconto-badge-color')}`,
                'padding: 8px 16px',
                `border-radius: ${badgeRadius}`,
                ...(badgeClipPath !== 'none' ? [`clip-path: ${badgeClipPath}`] : []),
                `font-size: ${getValue('desconto-badge-font-size')}`,
                'font-weight: bold',
                `width: ${getValue('desconto-badge-width')}`,
                `height: ${getValue('desconto-badge-height')}`,
                'display: flex',
                'flex-direction: column',
                'align-items: center',
                'justify-content: center',
                'text-align: center',
                'white-space: normal',
                'pointer-events: none',
                'box-sizing: border-box',
                'min-width: fit-content',
                'box-shadow: 0 4px 12px rgba(0,0,0,0.25)',
                'z-index: 60'
            ];
            badgeStyleParts.push(`border: ${badgeBorder}`);
            const badgeStyle = badgeStyleParts.join('; ') + ';';
            
            const containerBg = getContainerBgColor();
            const imagemContainerBg = getImagemContainerBgColor();
            const containerShadow = (containerBg === 'transparent') ? 'none' : '0 2px 8px rgba(0,0,0,0.1)';
            const imagemContainerShadow = (imagemContainerBg === 'transparent') ? 'none' : 'none';
            
            return `
                <div class="produto-item" style="padding: 15px 12px 35px 12px; overflow: visible; max-width: ${getValue('produto-item-max-width')};">
                    <div class="produto-container" style="padding: ${getValue('produto-container-padding')}; background: ${containerBg}; border-radius: ${getValue('produto-container-border-radius')}; box-shadow: ${containerShadow}; border: none;">    
                        <div class="produto-imagem-container" style="position: relative; background: ${imagemContainerBg}; border-radius: 15px; padding: 25px 20px; margin-bottom: ${getValue('produto-imagem-container-margin-bottom')}; height: ${getValue('produto-imagem-container-height')}; display: flex; align-items: flex-start; justify-content: center; box-shadow: ${imagemContainerShadow}; border: none;">
                            <img class="produto-imagem" src="${imageUrl}" alt="Produto ${productNum}" onerror="this.src='${placeholderSvg}'" style="position: absolute; top: ${getValue('produto-imagem-top')}; left: ${getValue('produto-imagem-left')}; transform: translateX(-50%); width: ${getValue('produto-imagem-width')}; max-width: ${getValue('produto-imagem-max-width')}; height: ${getValue('produto-imagem-height')}; max-height: ${getValue('produto-imagem-max-height')}; object-fit: contain;">
                            <div class="desconto-badge" style="${badgeStyle}">
                                <div style="line-height: 1; font-weight: bold;">30%</div>
                                <div style="line-height: 1; font-size: 0.65em; font-weight: normal; margin-top: 2px;">OFF</div>
                            </div>
                            ${(() => {
                                // Obter valores dos controles da bandeira - EXATAMENTE como o badge faz
                                let bandeiraTop = getValue('bandeira-top');
                                let bandeiraRight = getValue('bandeira-right');
                                let bandeiraBottom = getValue('bandeira-bottom');
                                let bandeiraLeft = getValue('bandeira-left');
                                let bandeiraWidth = getValue('bandeira-width');
                                let bandeiraHeight = getValue('bandeira-height');
                                
                                // Se valores s√£o auto/0, usar valores do badge como padr√£o
                                const badgeWidth = getValue('desconto-badge-width');
                                const badgeHeight = getValue('desconto-badge-height');
                                const badgeRight = getValue('desconto-badge-right');
                                const badgeLeft = getValue('desconto-badge-left');
                                
                                if (bandeiraWidth === 'auto' || bandeiraWidth === '0px') {
                                    bandeiraWidth = badgeWidth !== 'auto' ? badgeWidth : '60px';
                                }
                                if (bandeiraHeight === 'auto' || bandeiraHeight === '0px') {
                                    bandeiraHeight = badgeHeight !== 'auto' ? badgeHeight : '60px';
                                }
                                
                                // Se posicionamento n√£o est√° definido, usar do badge e calcular abaixo
                                if (bandeiraRight === 'auto' || bandeiraRight === '0px') {
                                    bandeiraRight = badgeRight;
                                }
                                if (bandeiraLeft === 'auto' || bandeiraLeft === '0px') {
                                    bandeiraLeft = badgeLeft;
                                }
                                
                                // Se top/bottom n√£o est√£o definidos, calcular baseado no badge para ficar ABAIXO
                                if ((bandeiraTop === 'auto' || bandeiraTop === '0px') && (bandeiraBottom === 'auto' || bandeiraBottom === '0px')) {
                                    const badgeTop = getValue('desconto-badge-top');
                                    const badgeBottom = getValue('desconto-badge-bottom');
                                    const badgeTopValue = badgeTop !== 'auto' ? parseInt(badgeTop) || 8 : 8;
                                    const badgeHeightValue = parseInt(bandeiraHeight) || 60;
                                    
                                    if (badgeBottom === 'auto' && badgeTop !== 'auto') {
                                        // Badge est√° no TOP, bandeira vai ABAIXO (top maior)
                                        bandeiraTop = (badgeTopValue + badgeHeightValue + 5) + 'px';
                                        bandeiraBottom = 'auto';
                                    } else if (badgeBottom !== 'auto') {
                                        // Badge est√° no BOTTOM, calcular top da bandeira para ficar ABAIXO
                                        const badgeBottomValue = parseInt(badgeBottom) || 0;
                                        // Estimar altura do container (420px √© padr√£o do container de imagem)
                                        const containerHeight = parseInt(getValue('produto-imagem-container-height')) || 420;
                                        // Top do badge = altura_container - bottom_badge - altura_badge
                                        // Top da bandeira = top_badge + altura_badge + espa√ßamento
                                        const bandeiraHeightValue = parseInt(bandeiraHeight) || 60;
                                        const badgeTopFromBottom = containerHeight - badgeBottomValue - badgeHeightValue;
                                        const calculatedTop = badgeTopFromBottom + badgeHeightValue + 5;
                                        if (calculatedTop > 0 && calculatedTop < containerHeight) {
                                            bandeiraTop = calculatedTop + 'px';
                                            bandeiraBottom = 'auto';
                                        } else {
                                            // Se deu fora do container, usar top simples baseado no badge
                                            bandeiraTop = (badgeTopValue + badgeHeightValue + 5) + 'px';
                                            bandeiraBottom = 'auto';
                                        }
                                    } else {
                                        // Fallback: calcular por top
                                        bandeiraTop = (badgeTopValue + badgeHeightValue + 5) + 'px';
                                        bandeiraBottom = 'auto';
                                    }
                                }
                                
                                // Construir posicionamento - EXATAMENTE como o badge faz
                                const bandeiraPositionParts = [];
                                if (bandeiraBottom === 'auto' && bandeiraTop !== 'auto') {
                                    bandeiraPositionParts.push(`top: ${bandeiraTop}`);
                                }
                                if (bandeiraLeft === 'auto' && bandeiraRight !== 'auto') {
                                    bandeiraPositionParts.push(`right: ${bandeiraRight}`);
                                }
                                if (bandeiraBottom !== 'auto') {
                                    bandeiraPositionParts.push(`bottom: ${bandeiraBottom}`);
                                }
                                if (bandeiraLeft !== 'auto') {
                                    bandeiraPositionParts.push(`left: ${bandeiraLeft}`);
                                }
                                
                                // Construir estilo - EXATAMENTE como o badge faz
                                const bandeiraStyleParts = [
                                    'position: absolute',
                                    ...bandeiraPositionParts,
                                    `width: ${bandeiraWidth}`,
                                    `height: ${bandeiraHeight}`,
                                    'object-fit: cover',
                                    'object-position: center',
                                    'z-index: 59'
                                ];
                                
                                const bandeiraStyle = bandeiraStyleParts.join('; ') + ';';
                                
                                // Usar uma bandeira de exemplo para o preview
                                return `<img id="draggable-bandeira" class="bandeira-imagem" src="Bandeira/ARGENTINA.png" alt="Bandeira" style="${bandeiraStyle}" onerror="this.style.display='none';" />`;
                            })()}
                            <img id="draggable-base-produto" class="base-produto" src="${baseProdutoImg}" alt="Base" style="position: absolute; bottom: ${getValue('base-produto-bottom')}; left: ${getValue('base-produto-left')}; transform: translateX(-50%); width: ${getValue('base-produto-width')}; max-width: ${getValue('base-produto-max-width')}; height: ${getValue('base-produto-height')}; opacity: ${getValue('base-produto-opacity')};">
                        </div>
                        <div class="produto-info" style="padding: 10px 5px;">
                            <div id="draggable-produto-nome" class="produto-nome" style="font-size: ${getValue('produto-nome-font-size')}; color: ${getValue('produto-nome-color')}; font-family: ${getValue('produto-nome-font-family')}; font-weight: ${getValue('produto-nome-font-weight')}; font-style: ${getValue('produto-nome-font-style')}; margin-bottom: 6px; position: relative; top: ${getValue('produto-nome-top')}; left: ${getValue('produto-nome-left')}; text-align: center; padding: 0 5px; display: inline-block;">Produto ${productNum} Exemplo</div>
                            <div id="draggable-produto-codigo" class="produto-codigo" style="font-size: ${getValue('produto-codigo-font-size')}; color: ${getValue('produto-codigo-color')}; font-family: ${getValue('produto-codigo-font-family')}; font-weight: ${getValue('produto-codigo-font-weight')}; font-style: ${getValue('produto-codigo-font-style')}; margin-bottom: 8px; position: relative; top: ${getValue('produto-codigo-top')}; left: ${getValue('produto-codigo-left')}; text-align: center; display: inline-block;">COD. ${codigo}</div>
                            <div class="precos" style="text-align: center; margin-bottom: 8px; display: flex; flex-direction: column; align-items: center; gap: 6px;">
                                <div class="preco-linhas" style="display: flex; gap: 16px; align-items: baseline; justify-content: center; flex-wrap: wrap; position: relative;">
                                    <span id="draggable-preco-de" class="preco-label preco-label-de" style="font-family: ${getValue('produto-nome-font-family')}; font-weight: ${getValue('produto-nome-font-weight')}; font-style: ${getValue('produto-nome-font-style')}; color: ${getValue('produto-nome-color')}; font-size: ${getValue('preco-de-font-size')}px; position: relative; top: ${getValue('preco-de-top')}px; left: ${getValue('preco-de-left')}px; display: inline-block;">DE</span>
                                    <span id="draggable-preco-comercial" class="preco-comercial-valor" style="font-family: ${getValue('preco-comercial-font-family')}; font-weight: ${getValue('preco-comercial-font-weight')}; font-style: ${getValue('preco-comercial-font-style')}; font-size: ${getValue('preco-comercial-font-size')}; color: ${getValue('preco-comercial-color')}; display: inline-flex; align-items: baseline; position: relative; top: ${getValue('preco-comercial-top')}; left: ${getValue('preco-comercial-left')};">
                                        <span class="preco-comercial-rs">R$</span><span class="preco-comercial-valor-num">${(99.90 + productNum).toFixed(2).replace('.', ',')}</span>
                                    </span>
                                    <span id="draggable-preco-por" class="preco-label preco-label-por" style="font-family: ${getValue('produto-nome-font-family')}; font-weight: ${getValue('produto-nome-font-weight')}; font-style: ${getValue('produto-nome-font-style')}; color: ${getValue('produto-nome-color')}; font-size: ${getValue('preco-por-font-size')}px; position: relative; top: ${getValue('preco-por-top')}px; left: ${getValue('preco-por-left')}px; display: inline-block;">POR</span>
                                    <span id="draggable-preco-promocional" class="preco-promocional" style="font-size: ${getValue('preco-promocional-font-size')}; color: ${getValue('preco-promocional-color')}; font-family: ${getValue('preco-promocional-font-family')}; font-weight: ${getValue('preco-promocional-font-weight')}; font-style: ${getValue('preco-promocional-font-style')}; display: inline-flex; align-items: flex-start; line-height: 1; position: relative; top: ${getValue('preco-promocional-top')}; left: ${getValue('preco-promocional-left')};">
                                        <span class="preco-rs" style="font-size: ${getValue('preco-rs-font-size')}; color: ${getValue('preco-rs-color')}; align-self: ${getValue('preco-rs-vertical-align')}; margin-right: 5px;">R$</span><span class="preco-inteiro">${Math.floor(69.90 + productNum)}</span><span class="preco-virgula" style="font-size: ${getValue('preco-decimal-font-size')}; color: ${getValue('preco-decimal-color')}; vertical-align: ${getValue('preco-decimal-vertical-align')};">,</span><span class="preco-decimal" style="font-size: ${getValue('preco-decimal-font-size')}; color: ${getValue('preco-decimal-color')}; vertical-align: ${getValue('preco-decimal-vertical-align')};">${String((69.90 + productNum).toFixed(2).split('.')[1])}</span>
                                    </span>
                                    <span id="draggable-preco-por-unidade" class="preco-label preco-label-por-unidade" style="font-family: ${getValue('produto-nome-font-family')}; font-weight: ${getValue('produto-nome-font-weight')}; font-style: ${getValue('produto-nome-font-style')}; color: ${getValue('produto-nome-color')}; font-size: ${getValue('preco-por-unidade-font-size')}px; position: relative; top: ${getValue('preco-por-unidade-top')}px; left: ${getValue('preco-por-unidade-left')}px; display: inline-block; margin-left: 8px;">POR KG</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function generatePreviewHTML() {
            // Obter imagens reais ou placeholders
            const fundoPlaceholder = 'linear-gradient(180deg, #0a1628 0%, #1a3a5a 50%, #2d5a7a 100%)';
            const fundoImg = getImage('fundo', null);
            const backgroundStyle = fundoImg ? `background-image: url(${fundoImg}); background-size: cover; background-position: center; background-repeat: no-repeat;` : `background: ${fundoPlaceholder};`;
            
            const logoSuperiorPlaceholder = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Ccircle cx='75' cy='75' r='70' fill='%231a3a5a'/%3E%3Ctext x='75' y='90' text-anchor='middle' fill='%23fff' font-size='60' font-weight='bold'%3EF%3C/text%3E%3C/svg%3E`;
            const logoSuperiorImg = getImage('logo-superior', logoSuperiorPlaceholder);
            
            const logoOfertasPlaceholder = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='450' height='450'%3E%3Ccircle cx='225' cy='225' r='210' fill='%231a3a5a'/%3E%3Ctext x='225' y='250' text-anchor='middle' fill='%23FFD700' font-size='40' font-weight='bold'%3EOfertas%3C/text%3E%3C/svg%3E`;
            const logoOfertasImg = getImage('logo-ofertas', logoOfertasPlaceholder);
            
            const callActionPlaceholder = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='100'%3E%3Crect fill='%2300796B' width='500' height='100' rx='20'/%3E%3Ctext x='250' y='55' text-anchor='middle' fill='%23FFD700' font-size='18' font-weight='bold'%3ECall Action%3C/text%3E%3C/svg%3E`;
            const callActionImg = getImage('call-action', callActionPlaceholder);
            
            const logoInferiorPlaceholder = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='350' height='80'%3E%3Crect fill='%23fff' width='350' height='80'/%3E%3Ctext x='175' y='45' text-anchor='middle' fill='%23333'%3ELogo Inferior%3C/text%3E%3C/svg%3E`;
            const logoInferiorImg = getImage('logo-inferior', logoInferiorPlaceholder);

            const footerTop = getValue('footer-top');
            const footerBottom = getValue('footer-bottom');
            const footerPositionParts = [];
            if (footerBottom !== 'auto') footerPositionParts.push(`bottom: ${footerBottom};`);
            if (footerTop !== 'auto') footerPositionParts.push(`top: ${footerTop};`);
            let footerPosition = footerPositionParts.length ? footerPositionParts.join(' ') : 'bottom: 0px;';
            if (!footerPosition.endsWith(' ')) footerPosition += ' ';
            const footerRotationValue = document.getElementById('footer-rotation') ? document.getElementById('footer-rotation').value : 'horizontal';
            const footerTransform = footerRotationValue === 'vertical'
                ? 'translate(-50%, 0) rotate(-90deg)'
                : 'translateX(-50%)';
            
            return `
                <div class="preview-wrapper" style="width: 1080px; height: 1920px; position: relative; ${backgroundStyle} overflow: hidden;">
                    <style>
                        ${generateCSS()}
                        .logo-ofertas { position: absolute; left: ${getValue('logo-ofertas-left')}; transform: translateX(-50%); width: ${getValue('logo-ofertas-width')}; height: ${getValue('logo-ofertas-height')}; z-index: 10; }
                        .produtos-container { position: absolute; left: 50%; transform: translateX(-50%); width: 100%; display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: ${getValue('produtos-container-gap')}; padding: 0 20px; }
                        .separador-produto { position: absolute; width: ${getValue('separador-width')}; height: ${getValue('separador-height')}; background-color: ${getValue('separador-color')}; top: ${getValue('separador-top')}; z-index: 15; pointer-events: none; box-sizing: border-box; }
                        .produto-item { flex: 1; max-width: ${getValue('produto-item-max-width')}; }
                        .produto-container { box-shadow: ${(getContainerBgColor() === 'transparent') ? 'none' : '0 4px 12px rgba(0,0,0,0.2)'}; border: none; }
                        .produto-imagem-container { position: relative; background: ${getImagemContainerBgColor()}; border-radius: 15px; box-shadow: none; border: none; }
                        .produto-imagem { position: absolute; object-fit: contain; z-index: 2; }
                        .base-produto { position: absolute; object-fit: contain; z-index: 1; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
                        .desconto-badge { position: absolute; z-index: 60; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; box-sizing: border-box; white-space: normal; }
                        .produto-nome { text-align: center; }
                        .produto-codigo { text-align: center; }
                .precos { text-align: center; display: flex; flex-direction: column; align-items: center; gap: 6px; }
                .preco-linhas { display: flex; gap: 16px; align-items: baseline; justify-content: center; flex-wrap: wrap; }
                        .call-action { position: absolute; left: 50%; transform: translateX(-50%); z-index: 20; border-radius: 20px; box-shadow: none; border: none; object-fit: contain; }
                        .logo-inferior { position: absolute; left: 50%; transform: translateX(-50%); z-index: 10; object-fit: contain; }
                        .logo-superior { position: absolute; z-index: 10; object-fit: contain; }
                        .footer-text { position: absolute; left: ${getValue('footer-left')}; width: ${getValue('footer-width')}; ${footerPosition} color: ${getValue('footer-color')}; font-size: ${getValue('footer-font-size')}; transform: ${footerTransform}; transform-origin: center; font-family: 'Montserrat', sans-serif; z-index: 25; line-height: 1.2; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.6); white-space: normal; font-weight: 500; }
                        .footer-line1 { font-size: ${getValue('footer-font-size')}; font-weight: 600; margin: 0; }
                        .footer-line2 { font-size: calc(${getValue('footer-font-size')} * 0.85); font-weight: 400; margin: 0; }
                        .unidade-text { position: absolute; top: 30px; left: 40px; color: #FFFFFF; font-size: 42px; font-family: 'Montserrat', sans-serif; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; text-shadow: 0 3px 6px rgba(0,0,0,0.45); z-index: 30; }
                    </style>
                    <!-- Logo Superior -->
                    <img id="draggable-logo-superior" class="logo-superior" src="${logoSuperiorImg}" alt="Logo Superior" style="top: ${getValue('logo-superior-top')}; right: ${getValue('logo-superior-right')}; width: ${getValue('logo-superior-width')}; height: ${getValue('logo-superior-height')};">
                    <!-- Logo Ofertas da Semana -->
                    <img id="draggable-logo-ofertas" class="logo-ofertas" src="${logoOfertasImg}" alt="Ofertas da Semana" style="top: ${getValue('logo-ofertas-top')}; width: ${getValue('logo-ofertas-width')}; height: ${getValue('logo-ofertas-height')};">
                    <div class="produtos-container" style="top: ${getValue('produtos-container-top')}; position: relative;">
                        ${await generateProductCard(1)}
                        ${(() => {
                            // Sempre mostrar separador ap√≥s produto 1 (para 2 ou 3 produtos)
                            const separadorWidth = getValue('separador-width');
                            const separadorHeight = getValue('separador-height');
                            const separadorColor = getValue('separador-color');
                            const separadorTop = getValue('separador-top');
                            const separadorLeft = getValue('separador-left');
                            // Para 3 produtos: 33.333%, para 2 produtos: 50%
                            const positionPercent = 33.333;
                            return `<div class="separador-produto" style="position: absolute; width: ${separadorWidth}; height: ${separadorHeight}; background-color: ${separadorColor}; top: ${separadorTop}; left: calc(${positionPercent}% + ${separadorLeft}px); transform: translateX(-50%); z-index: 15;"></div>`;
                        })()}
                        ${await generateProductCard(2)}
                        ${(() => {
                            // Mostrar separador ap√≥s produto 2 apenas se houver 3 produtos
                            const separadorWidth = getValue('separador-width');
                            const separadorHeight = getValue('separador-height');
                            const separadorColor = getValue('separador-color');
                            const separadorTop = getValue('separador-top');
                            const separadorLeft = getValue('separador-left');
                            // Para 3 produtos: 66.666%
                            const positionPercent = 66.666;
                            return `<div class="separador-produto" style="position: absolute; width: ${separadorWidth}; height: ${separadorHeight}; background-color: ${separadorColor}; top: ${separadorTop}; left: calc(${positionPercent}% + ${separadorLeft}px); transform: translateX(-50%); z-index: 15;"></div>`;
                        })()}
                        ${await generateProductCard(3)}
                    </div>
                    <div class="unidade-text">DSP</div>
                    <!-- Frase de Impulsionamento -->
                    ${(() => {
                        const impulsionamentoTop = getValue('impulsionamento-top');
                        const impulsionamentoBottom = getValue('impulsionamento-bottom');
                        const impulsionamentoLeft = getValue('impulsionamento-left');
                        const impulsionamentoRight = getValue('impulsionamento-right');
                        const impulsionamentoWidth = getValue('impulsionamento-width');
                        const impulsionamentoHeight = getValue('impulsionamento-height');
                        const impulsionamentoText = getImpulsionamentoText();
                        // Simplificar: sempre usar top (como logo-ofertas-top funciona)
                        // Se bottom tiver valor, usar bottom; sen√£o, usar top
                        const bottomControl = document.getElementById('impulsionamento-bottom');
                        const bottomValue = bottomControl ? parseInt(bottomControl.value) : 0;
                        const topControl = document.getElementById('impulsionamento-top');
                        const topValue = topControl ? parseInt(topControl.value) : 0;
                        
                        let impulsionamentoPosition = '';
                        if (bottomValue > 0) {
                            impulsionamentoPosition = `bottom: ${impulsionamentoBottom};`;
                        } else {
                            // Sempre usar top quando bottom for 0 (mesmo que top seja 0px)
                            impulsionamentoPosition = `top: ${topValue}px;`;
                        }
                        
                        // Left/Right: sempre usar left se tiver valor, sen√£o right, sen√£o centralizar
                        const leftControl = document.getElementById('impulsionamento-left');
                        const leftValue = leftControl ? parseInt(leftControl.value) : 540;
                        const rightControl = document.getElementById('impulsionamento-right');
                        const rightValue = rightControl ? parseInt(rightControl.value) : 0;
                        
                        if (rightValue > 0) {
                            impulsionamentoPosition += ` right: ${rightValue}px;`;
                        } else {
                            impulsionamentoPosition += ` left: ${leftValue}px;`;
                        }
                        const heightStyle = impulsionamentoHeight !== 'auto' ? `height: ${impulsionamentoHeight};` : '';
                        if (!impulsionamentoText || impulsionamentoText.trim() === '' || impulsionamentoText.includes('Digite sua frase')) {
                            return '';
                        }
                        return `<div class="impulsionamento-text draggable-impulsionamento" id="preview-impulsionamento-text" style="position: absolute; ${impulsionamentoPosition} width: ${impulsionamentoWidth}; ${heightStyle} cursor: move; border: 2px dashed rgba(255,255,255,0.5); padding: 5px; box-sizing: border-box;" draggable="false">${impulsionamentoText}</div>`;
                    })()}
                    <!-- Call Action -->
                    <img id="draggable-call-action" class="call-action" src="${callActionImg}" alt="Call Action" style="${getValue('call-action-top') !== 'auto' ? 'top: ' + getValue('call-action-top') + ';' : ''} ${getValue('call-action-bottom') !== 'auto' ? 'bottom: ' + getValue('call-action-bottom') + ';' : ''} left: ${getValue('call-action-left')}; transform: translateX(-50%); width: ${getValue('call-action-width')}; height: ${getValue('call-action-height')}; box-shadow: none; border: none;">
                    <!-- Logo Inferior -->
                    <img id="draggable-logo-inferior" class="logo-inferior" src="${logoInferiorImg}" alt="Logo Inferior" style="bottom: ${getValue('logo-inferior-bottom')}; left: ${getValue('logo-inferior-left')}; transform: translateX(-50%); width: ${getValue('logo-inferior-width')}; height: ${getValue('logo-inferior-height')};">
                    <div class="footer-text">
                        Promo√ß√£o v√°lida apenas para a unidade de Unidade Exemplo, de 01/05/2024 a 07/05/2024 ou enquanto durarem os estoques. *Promo√ß√£o n√£o acumulativa com outros itens promocionais. Condi√ß√µes n√£o estendidas a clientes com acordos comerciais.
                    </div>
                </div>
            `;
        }
        
        function resetValues() {
            const keys = Object.keys(defaultValues);
            keys.forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    el.value = defaultValues[key];
                }
            });
            updateCSS();
        }
        
        async function saveTemplate() {
            const template = {};
            const keys = Object.keys(defaultValues);
            keys.forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    if (key === 'base-produto-opacity' || key === 'produto-container-bg-opacity' || key === 'produto-imagem-container-bg-opacity') {
                        template[key] = el.value / 100;
                    } else if (key.includes('color')) {
                        template[key] = el.value;
                    } else if (key === 'preco-rs-font-size' || key === 'preco-decimal-font-size' || key === 'preco-de-font-size' || key === 'preco-por-font-size' || key === 'footer-font-size') {
                        template[key] = parseFloat(el.value) || el.value;
                    } else if (key.includes('font-family')) {
                        template[key] = el.value;
                    } else {
                        template[key] = parseInt(el.value) || el.value;
                    }
                }
            });
            
            // Adicionar legenda padr√£o do banner
            const bannerCaptionEl = document.getElementById('banner-caption-text');
            if (bannerCaptionEl) {
                template['banner-caption'] = bannerCaptionEl.value.trim();
            }
            
            // Adicionar texto de impulsionamento
            const impulsionamentoTextEl = document.getElementById('impulsionamento-text');
            if (impulsionamentoTextEl) {
                template['impulsionamento-text'] = impulsionamentoTextEl.innerHTML || impulsionamentoTextEl.innerText || '';
            }
            
            const jsonStr = JSON.stringify(template, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            
            // Tentar usar File System Access API (Chrome/Edge modernos)
            if ('showSaveFilePicker' in window) {
                try {
                    const fileHandle = await window.showSaveFilePicker({
                        suggestedName: 'banner-template.json',
                        types: [{
                            description: 'JSON Files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    const writable = await fileHandle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    localStorage.setItem('bannerTemplate', jsonStr);
                    addLog('Template salvo com sucesso!');
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        addLog('Erro ao salvar: ' + err.message);
                    } else {
                        addLog('Salvamento cancelado.');
                        return;
                    }
                }
            }
            
            // Fallback para download tradicional (permite escolher local)
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'banner-template.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            localStorage.setItem('bannerTemplate', jsonStr);
            addLog('Template preparado para download. Use "Salvar Como" no seu navegador.');
        }
        
        function loadTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const template = JSON.parse(event.target.result);
                        const keys = Object.keys(defaultValues);
                        keys.forEach(key => {
                            if (template.hasOwnProperty(key)) {
                                const el = document.getElementById(key);
                                if (el) {
                                if (key === 'base-produto-opacity' || key === 'produto-container-bg-opacity' || key === 'produto-imagem-container-bg-opacity') {
                                        el.value = Math.round(template[key] * 100);
                                } else if (key === 'preco-rs-font-size' || key === 'preco-decimal-font-size' || key === 'preco-de-font-size' || key === 'preco-por-font-size' || key === 'footer-font-size') {
                                    el.value = parseFloat(template[key]) || template[key];
                                    } else if (key.includes('font-family')) {
                                        el.value = template[key];
                                    } else {
                                        el.value = template[key];
                                    }
                                }
                            }
                        });
                        
                        // Carregar legenda padr√£o do banner
                        if (template.hasOwnProperty('banner-caption')) {
                            const bannerCaptionEl = document.getElementById('banner-caption-text');
                            if (bannerCaptionEl) {
                                bannerCaptionEl.value = template['banner-caption'] || '';
                            }
                        }
                        
                        // Carregar texto de impulsionamento
                        if (template.hasOwnProperty('impulsionamento-text')) {
                            const impulsionamentoTextEl = document.getElementById('impulsionamento-text');
                            if (impulsionamentoTextEl) {
                                impulsionamentoTextEl.innerHTML = template['impulsionamento-text'] || '';
                            }
                        }
                        updateCSS();
                        localStorage.setItem('bannerTemplate', JSON.stringify(template));
                        addLog('Template carregado com sucesso!');
                    } catch (error) {
                        addLog('Erro ao carregar template: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('bannerTemplate');
            if (saved) {
                try {
                    const template = JSON.parse(saved);
                    const keys = Object.keys(defaultValues);
                    keys.forEach(key => {
                        if (template.hasOwnProperty(key)) {
                            const el = document.getElementById(key);
                            if (el) {
                                if (key === 'base-produto-opacity' || key === 'produto-container-bg-opacity') {
                                    el.value = Math.round(template[key] * 100);
                                } else if (key === 'preco-rs-font-size' || key === 'preco-decimal-font-size' || key === 'preco-de-font-size' || key === 'preco-por-font-size' || key === 'footer-font-size') {
                                    el.value = parseFloat(template[key]) || template[key];
                                } else if (key.includes('font-family')) {
                                    el.value = template[key];
                                } else {
                                    el.value = template[key];
                                }
                            }
                        }
                    });
                    
                    // Carregar legenda padr√£o do banner
                    if (template.hasOwnProperty('banner-caption')) {
                        const bannerCaptionEl = document.getElementById('banner-caption-text');
                        if (bannerCaptionEl) {
                            bannerCaptionEl.value = template['banner-caption'] || '';
                        }
                    }
                    
                    // Carregar texto de impulsionamento
                    if (template.hasOwnProperty('impulsionamento-text')) {
                        const impulsionamentoTextEl = document.getElementById('impulsionamento-text');
                        if (impulsionamentoTextEl) {
                            impulsionamentoTextEl.innerHTML = template['impulsionamento-text'] || '';
                        }
                    }
                    
                    updateCSS();
                } catch (error) {
                    console.error('Erro ao carregar do localStorage:', error);
                }
            }
        }
        
        let statusCheckInterval = null;
        let isExecuting = false;
        
        function addLog(message) {
            const logsOutput = document.getElementById('logs-output');
            if (logsOutput) {
                const timestamp = new Date().toLocaleTimeString('pt-BR');
                logsOutput.value += `[${timestamp}] ${message}\n`;
                logsOutput.scrollTop = logsOutput.scrollHeight;
            }
        }
        
        function clearLogs() {
            const logsOutput = document.getElementById('logs-output');
            if (logsOutput) {
                logsOutput.value = '';
            }
        }
        
        function saveTemplateSilently() {
            const template = {};
            const keys = Object.keys(defaultValues);
            keys.forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    if (key === 'base-produto-opacity' || key === 'produto-container-bg-opacity' || key === 'produto-imagem-container-bg-opacity') {
                        template[key] = el.value / 100;
                    } else if (key.includes('color')) {
                        template[key] = el.value;
                    } else if (key === 'preco-rs-font-size' || key === 'preco-decimal-font-size') {
                        template[key] = parseFloat(el.value) || el.value;
                    } else {
                        template[key] = parseInt(el.value) || el.value;
                    }
                }
            });
            
            // Adicionar legenda padr√£o do banner
            const bannerCaptionEl = document.getElementById('banner-caption-text');
            if (bannerCaptionEl) {
                template['banner-caption'] = bannerCaptionEl.value.trim();
            }
            
            const jsonStr = JSON.stringify(template, null, 2);
            localStorage.setItem('bannerTemplate', jsonStr);
            
            fetch(`${BACKEND_URL}/save-template`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: jsonStr
            }).catch(err => {
                console.warn('Servidor n√£o dispon√≠vel para salvar template:', err);
            });
        }
        
        async function checkServerHealth() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(`${BACKEND_URL}/health`, {
                    method: 'GET',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (response.ok) {
                    const data = await response.json();
                    return data.status === 'ok';
                }
                return false;
            } catch (err) {
                return false;
            }
        }
        
        async function checkAndStartServer() {
            const startBtn = document.getElementById('start-server-btn');
            const originalText = startBtn.textContent;
            startBtn.disabled = true;
            startBtn.textContent = '‚è≥ Verificando...';
            
            addLog('üîç Verificando status do servidor...');
            const serverRunning = await checkServerHealth();
            
            if (serverRunning) {
                addLog('‚úÖ Servidor est√° rodando e respondendo!');
                startBtn.textContent = '‚úÖ Servidor Online';
                startBtn.style.background = '#28a745';
                // Carregar imagens do servidor
                addLog('üì∏ Carregando imagens do servidor...');
                await loadAllImages();
                addLog('‚úÖ Imagens carregadas com sucesso!');
                setTimeout(() => {
                    startBtn.textContent = originalText;
                    startBtn.style.background = '#6c757d';
                    startBtn.disabled = false;
                }, 2000);
            } else {
                addLog('‚ö† Servidor n√£o est√° rodando!');
                addLog('');
                addLog('üìã Para iniciar o servidor manualmente:');
                addLog('   1. Abra um terminal/PowerShell nesta pasta do projeto');
                addLog('   2. Execute o comando: python server.py');
                addLog(`   3. Aguarde a mensagem "Servidor dispon√≠vel em: ${BACKEND_URL}"`);
                addLog('   4. Clique novamente em "Verificar/Iniciar Servidor"');
                addLog('');
                addLog('üí° Dica: Voc√™ tamb√©m pode executar o arquivo "iniciar-servidor.bat" (Windows)');
                addLog('   ou criar um script similar para seu sistema operacional.');
                addLog('');
                
                const useBat = confirm('Servidor n√£o est√° rodando!\n\n' +
                    'Op√ß√µes:\n' +
                    '‚Ä¢ OK: Tentar iniciar automaticamente (pode abrir uma janela de terminal)\n' +
                    '‚Ä¢ Cancelar: Instru√ß√µes para iniciar manualmente\n\n' +
                    'Nota: O navegador pode bloquear a execu√ß√£o autom√°tica por seguran√ßa.');
                
                if (useBat) {
                    // Tentar iniciar o servidor via protocolo personalizado ou download
                    try {
                        // Criar um link tempor√°rio para iniciar o servidor
                        // Nota: Isso requer configura√ß√£o adicional no sistema
                        addLog('üîÑ Tentando iniciar servidor...');
                        addLog('‚ö† Se uma janela n√£o abrir automaticamente, inicie manualmente.');
                        
                        // Tentar abrir o arquivo .bat se existir
                        window.location.href = 'iniciar-servidor.bat';
                    } catch (e) {
                        addLog('‚ùå N√£o foi poss√≠vel iniciar automaticamente.');
                        addLog('Por favor, inicie o servidor manualmente seguindo as instru√ß√µes acima.');
                    }
                    
                    // Aguardar alguns segundos e verificar novamente
                    setTimeout(async () => {
                        addLog('üîÑ Verificando novamente em 5 segundos...');
                        await new Promise(resolve => setTimeout(resolve, 5000));
                        const stillRunning = await checkServerHealth();
                        if (stillRunning) {
                            addLog('‚úÖ Servidor iniciado com sucesso!');
                            addLog('üì∏ Carregando imagens...');
                            await loadAllImages();
                            addLog('‚úÖ Imagens carregadas!');
                        } else {
                            await checkAndStartServer();
                        }
                    }, 1000);
                }
                
                startBtn.textContent = originalText;
                startBtn.disabled = false;
            }
        }
        
        async function executeGenerator() {
            if (isExecuting) return;
            
            // Verificar se o servidor est√° rodando
            addLog('üîç Verificando se o servidor est√° rodando...');
            const serverRunning = await checkServerHealth();
            
            if (!serverRunning) {
                addLog('‚ö† Servidor n√£o est√° rodando!');
                addLog('');
                addLog('üìã Para iniciar o servidor:');
                addLog('   1. Clique no bot√£o "Verificar/Iniciar Servidor" acima, OU');
                addLog('   2. Execute o arquivo "iniciar-servidor.bat" (Windows), OU');
                addLog('   3. Abra um terminal e execute: python server.py');
                addLog('');
                
                const retry = confirm('Servidor n√£o est√° rodando!\n\n' +
                    'Voc√™ pode:\n' +
                    '‚Ä¢ Usar o bot√£o "Verificar/Iniciar Servidor"\n' +
                    '‚Ä¢ Executar "iniciar-servidor.bat"\n' +
                    '‚Ä¢ Ou iniciar manualmente: python server.py\n\n' +
                    'Deseja tentar conectar novamente em 3 segundos?');
                
                if (retry) {
                    setTimeout(async () => {
                        addLog('üîÑ Tentando conectar novamente...');
                        await executeGenerator();
                    }, 3000);
                }
                return;
            }
            
            addLog('‚úÖ Servidor est√° rodando!');
            saveTemplateSilently();
            isExecuting = true;
            document.getElementById('execute-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'block';
            document.getElementById('progress-container').style.display = 'block';
            addLog('üöÄ Iniciando gera√ß√£o de banners...');
            
            fetch(`${BACKEND_URL}/execute`, {
                method: 'POST'
            }).then(res => res.json())
            .then(data => {
                if (data.status === 'started') {
                    addLog('‚úÖ Execu√ß√£o iniciada no servidor.');
                    statusCheckInterval = setInterval(checkStatus, 1000);
                } else {
                    addLog('‚ùå Erro: ' + (data.error || 'Resposta inv√°lida do servidor'));
                    stopGenerator();
                }
            }).catch(err => {
                addLog('‚ùå Erro ao iniciar execu√ß√£o: ' + err.message);
                addLog('üí° Certifique-se de que o servidor est√° rodando corretamente');
                stopGenerator();
            });
        }
        
        function checkStatus() {
            fetch(`${BACKEND_URL}/status`)
            .then(res => res.json())
            .then(data => {
                if (data.progress !== undefined) {
                    const progressBar = document.getElementById('progress-bar');
                    const progressText = document.getElementById('progress-text');
                    const currentTask = document.getElementById('current-task');
                    const progressStats = document.getElementById('progress-stats');
                    const progressDetails = document.getElementById('progress-details');
                    
                    if (progressBar) progressBar.style.width = data.progress + '%';
                    if (progressText) progressText.textContent = data.progress + '%';
                    if (currentTask && data.task) {
                        currentTask.textContent = 'üîÑ ' + data.task;
                    }
                    
                    // Atualizar estat√≠sticas
                    if (data.stats) {
                        const stats = data.stats;
                        let statsText = '';
                        if (stats.total_unidades > 0) {
                            statsText = `Unidade ${stats.unidade_atual || 0}/${stats.total_unidades}`;
                            if (stats.banner_atual > 0) {
                                statsText += ` ‚Ä¢ Banner ${stats.banner_atual}`;
                            }
                        }
                        if (progressStats) progressStats.textContent = statsText;
                        
                        // Mostrar detalhes se houver informa√ß√µes
                        if (stats.unidade_nome || stats.banners_gerados > 0) {
                            if (progressDetails) progressDetails.style.display = 'block';
                            const statUnidade = document.getElementById('stat-unidade');
                            const statBanner = document.getElementById('stat-banner');
                            const statBannersGerados = document.getElementById('stat-banners-gerados');
                            const statItensProcessados = document.getElementById('stat-itens-processados');
                            
                            if (statUnidade) statUnidade.textContent = stats.unidade_nome || '-';
                            if (statBanner) statBanner.textContent = stats.banner_atual > 0 ? `#${stats.banner_atual}` : '-';
                            if (statBannersGerados) statBannersGerados.textContent = stats.banners_gerados || 0;
                            if (statItensProcessados) statItensProcessados.textContent = stats.itens_processados || 0;
                        }
                    }
                }
                
                if (data.logs && Array.isArray(data.logs)) {
                    const lastLogCount = parseInt(localStorage.getItem('lastLogCount') || '0');
                    const newLogs = data.logs.slice(lastLogCount);
                    newLogs.forEach(log => addLog(log));
                    localStorage.setItem('lastLogCount', data.logs.length.toString());
                }
                
                if (data.status === 'completed' || data.status === 'error' || data.status === 'stopped') {
                    stopGenerator();
                    if (data.status === 'completed') {
                        addLog('‚úì Gera√ß√£o conclu√≠da com sucesso!');
                        if (data.stats) {
                            addLog(`üìä Estat√≠sticas finais:`);
                            addLog(`   ‚Ä¢ Total de banners gerados: ${data.stats.total_banners || 0}`);
                            addLog(`   ‚Ä¢ Itens processados: ${data.stats.itens_processados || 0}`);
                            addLog(`   ‚Ä¢ Itens restantes: ${(data.stats.itens_total || 0) - (data.stats.itens_processados || 0)}`);
                        }
                    } else if (data.status === 'error') {
                        addLog('‚úó Erro na gera√ß√£o: ' + (data.error || 'Erro desconhecido'));
                    } else if (data.status === 'stopped') {
                        addLog('‚ö† Execu√ß√£o interrompida pelo usu√°rio.');
                    }
                    localStorage.removeItem('lastLogCount');
                }
            }).catch(err => {
                console.error('Erro ao verificar status:', err);
            });
        }
        
        function stopGenerator() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
            isExecuting = false;
            document.getElementById('execute-btn').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'none';
            
            fetch(`${BACKEND_URL}/stop`, {
                method: 'POST'
            }).catch(err => {
                console.warn('Erro ao parar execu√ß√£o:', err);
            });
        }
        
        window.addEventListener('DOMContentLoaded', async () => {
            loadFromLocalStorage();
            updateCSS();
            
            // Inicializar emoji picker
            initializeEmojiPicker();
            setupEmojiPickerClose();
            
            // Inicializar fechamento do modal de planilha Excel
            const excelModal = document.getElementById('excel-column-modal');
            if (excelModal) {
                excelModal.addEventListener('click', function(event) {
                    // Se clicar no backdrop (fora do conte√∫do), fechar
                    if (event.target === excelModal) {
                        closeExcelColumnModal();
                    }
                });
            }
            
            // Inicializar value displays dos controles de impulsionamento
            const impulsionamentoControls = [
                'impulsionamento-top', 'impulsionamento-bottom', 'impulsionamento-left', 
                'impulsionamento-right', 'impulsionamento-width', 'impulsionamento-height',
                'impulsionamento-font-size'
            ];
            impulsionamentoControls.forEach(id => {
                const el = document.getElementById(id);
                const valEl = document.getElementById(id + '-val');
                if (el && valEl) {
                    const updateDisplay = () => {
                        if (id === 'impulsionamento-top' || id === 'impulsionamento-left' || id === 'impulsionamento-right') {
                            // top, left, right: 0px √© v√°lido, mostrar como 0px
                            valEl.textContent = el.value + 'px';
                        } else if (id === 'impulsionamento-bottom' || id === 'impulsionamento-height') {
                            // bottom, height: 0 = auto
                            valEl.textContent = el.value == 0 ? 'auto' : el.value + 'px';
                        } else {
                            valEl.textContent = el.value + 'px';
                        }
                    };
                    updateDisplay();
                    el.addEventListener('input', updateDisplay);
                }
            });
            
            // Inicializar display de cor
            updateImpulsionamentoColorDisplay();
            
            // Inicializar value displays dos controles de separador
            const separadorControls = ['separador-width', 'separador-height', 'separador-top', 'separador-left'];
            separadorControls.forEach(id => {
                const el = document.getElementById(id);
                const valEl = document.getElementById(id + '-val');
                if (el && valEl) {
                    const updateDisplay = () => {
                        valEl.textContent = el.value + 'px';
                    };
                    updateDisplay();
                    el.addEventListener('input', updateDisplay);
                }
            });
            
            // Inicializar value displays dos controles de posi√ß√£o dos produtos
            const positionControls = [
                'produto-nome-top', 'produto-nome-left',
                'produto-codigo-top', 'produto-codigo-left',
                'preco-de-top', 'preco-de-left',
                'preco-comercial-top', 'preco-comercial-left',
                'preco-por-top', 'preco-por-left',
                'preco-por-unidade-top', 'preco-por-unidade-left',
                'preco-promocional-top', 'preco-promocional-left'
            ];
            positionControls.forEach(id => {
                const el = document.getElementById(id);
                const valEl = document.getElementById(id + '-val');
                if (el && valEl) {
                    const updateDisplay = () => {
                        valEl.textContent = el.value + 'px';
                    };
                    updateDisplay();
                    el.addEventListener('input', updateDisplay);
                }
            });
            
            // Inicializar display de cor do separador
            const separadorColorEl = document.getElementById('separador-color');
            const separadorColorValEl = document.getElementById('separador-color-val');
            if (separadorColorEl && separadorColorValEl) {
                separadorColorValEl.textContent = separadorColorEl.value;
                separadorColorEl.addEventListener('input', () => {
                    separadorColorValEl.textContent = separadorColorEl.value;
                });
            }
            
            // Configurar drag do texto de impulsionamento ap√≥s preview ser carregado
            setTimeout(() => {
                setupUniversalDrag();
            }, 500);
            
            // Verificar status do servidor ao carregar a p√°gina e carregar imagens
            setTimeout(async () => {
                const serverRunning = await checkServerHealth();
                if (serverRunning) {
                    const startBtn = document.getElementById('start-server-btn');
                    startBtn.textContent = '‚úÖ Servidor Online';
                    startBtn.style.background = '#28a745';
                    // Carregar imagens do servidor
                    addLog('üì∏ Carregando imagens do servidor...');
                    await loadAllImages();
                    addLog('‚úÖ Imagens carregadas com sucesso!');
                } else {
                    addLog('üí° Dica: Use o bot√£o "Verificar/Iniciar Servidor" para iniciar o servidor Flask e carregar as imagens.');
                }
            }, 1000);
        });
        
        // ========== FUN√á√ïES DO MENSAGER ==========
        
        let uploadedImagePath = null;
        let selectedRecipients = [];
        let groupsList = [];
        let contactsList = [];
        let allContactsList = [];
        let allGroupsList = [];
        
        // Vari√°veis para processar planilha Excel
        let excelData = null;
        let excelColumns = [];
        let selectedColumnIndex = -1;
        
        function switchMessengerMode(mode) {
            // Alternar bot√µes
            const individualBtn = document.getElementById('mode-individual-btn');
            const batchBtn = document.getElementById('mode-batch-btn');
            
            // Mostrar/ocultar se√ß√µes
            const individualSection = document.getElementById('individual-image-section');
            const batchSection = document.getElementById('batch-folder-section');
            
            // Mostrar/ocultar bot√µes de a√ß√£o
            const sendBtn = document.getElementById('send-btn');
            const batchSendBtn = document.getElementById('batch-send-btn');
            const clearIndividualBtn = document.getElementById('clear-individual-btn');
            const clearBatchBtn = document.getElementById('clear-batch-btn');
            
            if (mode === 'individual') {
                // Ativar modo individual
                individualBtn.classList.add('active');
                batchBtn.classList.remove('active');
                
                individualSection.style.display = 'block';
                batchSection.style.display = 'none';
                
                sendBtn.style.display = 'block';
                batchSendBtn.style.display = 'none';
                clearIndividualBtn.style.display = 'block';
                clearBatchBtn.style.display = 'none';
            } else {
                // Ativar modo lote
                individualBtn.classList.remove('active');
                batchBtn.classList.add('active');
                
                individualSection.style.display = 'none';
                batchSection.style.display = 'block';
                
                sendBtn.style.display = 'none';
                batchSendBtn.style.display = 'block';
                clearIndividualBtn.style.display = 'none';
                clearBatchBtn.style.display = 'block';
            }
        }
        
        function switchTab(tabName) {
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            const targetTab = document.getElementById(`tab-${tabName}`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Ativar bot√£o da aba
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                if (tab.textContent.includes(tabName === 'editor' ? 'Editor' : 'Mensager')) {
                    tab.classList.add('active');
                }
            });
            
            if (tabName === 'editor') {
                stopMessengerTabPolling();
                updatePreview();
            } else if (tabName === 'messenger') {
                startMessengerTabPolling();
            } else {
                stopMessengerTabPolling();
            }
        }
        
        function formatText(formatType) {
            const textarea = document.getElementById('message-text');
            if (!textarea) return;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            
            let formattedText = '';
            let newCursorPos = start;
            
            switch(formatType) {
                case 'bold':
                    // WhatsApp: *texto* (um asterisco)
                    formattedText = selectedText ? `*${selectedText}*` : '**';
                    newCursorPos = selectedText ? end + 2 : start + 1;
                    break;
                case 'italic':
                    // WhatsApp: _texto_ (underscore)
                    formattedText = selectedText ? `_${selectedText}_` : '__';
                    newCursorPos = selectedText ? end + 2 : start + 1;
                    break;
                case 'underline':
                    // WhatsApp n√£o suporta sublinhado nativamente, mas podemos usar ~texto~ para tachado
                    formattedText = selectedText ? `~${selectedText}~` : '~~';
                    newCursorPos = selectedText ? end + 2 : start + 1;
                    break;
                case 'strikethrough':
                    // WhatsApp: ~texto~ (til para tachado)
                    formattedText = selectedText ? `~${selectedText}~` : '~~';
                    newCursorPos = selectedText ? end + 2 : start + 1;
                    break;
                case 'monospace':
                    // WhatsApp: ```texto``` (tr√™s crases)
                    formattedText = selectedText ? `\`\`\`${selectedText}\`\`\`` : '``````';
                    newCursorPos = selectedText ? end + 6 : start + 3;
                    break;
            }
            
            textarea.value = before + formattedText + after;
            textarea.focus();
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            updateMessengerPreview();
        }
        
        function formatBannerText(formatType) {
            const textarea = document.getElementById('banner-caption-text');
            if (!textarea) return;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            
            let formattedText = '';
            let newCursorPos = start;
            
            switch(formatType) {
                case 'bold':
                    formattedText = selectedText ? `*${selectedText}*` : '**';
                    newCursorPos = selectedText ? end + 2 : start + 1;
                    break;
                case 'italic':
                    formattedText = selectedText ? `_${selectedText}_` : '__';
                    newCursorPos = selectedText ? end + 2 : start + 1;
                    break;
                case 'strikethrough':
                    formattedText = selectedText ? `~${selectedText}~` : '~~';
                    newCursorPos = selectedText ? end + 2 : start + 1;
                    break;
                case 'monospace':
                    formattedText = selectedText ? `\`\`\`${selectedText}\`\`\`` : '``````';
                    newCursorPos = selectedText ? end + 6 : start + 3;
                    break;
            }
            
            textarea.value = before + formattedText + after;
            textarea.focus();
            textarea.setSelectionRange(newCursorPos, newCursorPos);
        }
        
        // ========== FUN√á√ïES DE LEGENDAS SALVAS ==========
        
        function loadSavedCaptions() {
            try {
                const saved = localStorage.getItem('savedCaptions');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Erro ao carregar legendas salvas:', e);
            }
            return [];
        }
        
        function saveSavedCaptions(captions) {
            try {
                localStorage.setItem('savedCaptions', JSON.stringify(captions));
            } catch (e) {
                console.warn('Erro ao salvar legendas:', e);
                addMessengerLog('‚ö†Ô∏è Erro ao salvar legenda. Verifique o espa√ßo dispon√≠vel no navegador.');
            }
        }
        
        function saveCaption() {
            const textarea = document.getElementById('message-text');
            if (!textarea) return;
            
            const captionText = textarea.value.trim();
            
            if (!captionText) {
                addMessengerLog('‚ùå Por favor, digite uma legenda antes de salvar');
                return;
            }
            
            // Solicitar nome para a legenda
            const captionName = prompt('Digite um nome para esta legenda:', 
                captionText.substring(0, 30) + (captionText.length > 30 ? '...' : ''));
            
            if (!captionName || !captionName.trim()) {
                addMessengerLog('‚ö†Ô∏è Salvamento cancelado');
                return;
            }
            
            const captions = loadSavedCaptions();
            
            // Verificar se j√° existe uma legenda com o mesmo nome
            const existingIndex = captions.findIndex(c => c.name.toLowerCase() === captionName.trim().toLowerCase());
            
            const newCaption = {
                id: existingIndex >= 0 ? captions[existingIndex].id : Date.now().toString(),
                name: captionName.trim(),
                text: captionText,
                createdAt: existingIndex >= 0 ? captions[existingIndex].createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (existingIndex >= 0) {
                captions[existingIndex] = newCaption;
                addMessengerLog(`‚úÖ Legenda "${captionName}" atualizada com sucesso!`);
            } else {
                captions.unshift(newCaption); // Adicionar no in√≠cio
                addMessengerLog(`‚úÖ Legenda "${captionName}" salva com sucesso!`);
            }
            
            saveSavedCaptions(captions);
            displaySavedCaptions(captions);
        }
        
        function displaySavedCaptions(captions = null) {
            if (captions === null) {
                captions = loadSavedCaptions();
            }
            
            const listContainer = document.getElementById('saved-captions-list');
            const noMessage = document.getElementById('no-captions-message');
            
            if (!listContainer) return;
            
            if (captions.length === 0) {
                listContainer.style.display = 'none';
                if (noMessage) noMessage.style.display = 'block';
                return;
            }
            
            listContainer.style.display = 'block';
            if (noMessage) noMessage.style.display = 'none';
            
            listContainer.innerHTML = '';
            
            captions.forEach(caption => {
                const div = document.createElement('div');
                div.style.cssText = 'padding: 10px; margin: 5px 0; background: white; border: 1px solid #ddd; border-radius: 5px; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;';
                
                const contentDiv = document.createElement('div');
                contentDiv.style.cssText = 'flex: 1; min-width: 0;';
                
                const nameDiv = document.createElement('div');
                nameDiv.style.cssText = 'font-weight: bold; color: #333; margin-bottom: 5px; font-size: 13px;';
                nameDiv.textContent = caption.name;
                
                const textDiv = document.createElement('div');
                textDiv.style.cssText = 'color: #666; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;';
                textDiv.textContent = caption.text;
                textDiv.title = caption.text; // Tooltip com texto completo
                
                const dateDiv = document.createElement('div');
                dateDiv.style.cssText = 'color: #999; font-size: 10px; margin-top: 3px;';
                const date = new Date(caption.updatedAt || caption.createdAt);
                dateDiv.textContent = date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                contentDiv.appendChild(nameDiv);
                contentDiv.appendChild(textDiv);
                contentDiv.appendChild(dateDiv);
                
                const actionsDiv = document.createElement('div');
                actionsDiv.style.cssText = 'display: flex; gap: 5px; flex-shrink: 0;';
                
                const useBtn = document.createElement('button');
                useBtn.textContent = 'üìù Usar';
                useBtn.style.cssText = 'padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;';
                useBtn.onclick = () => loadCaption(caption.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.style.cssText = 'padding: 5px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;';
                deleteBtn.onclick = () => deleteCaption(caption.id);
                deleteBtn.title = 'Deletar legenda';
                
                actionsDiv.appendChild(useBtn);
                actionsDiv.appendChild(deleteBtn);
                
                div.appendChild(contentDiv);
                div.appendChild(actionsDiv);
                
                listContainer.appendChild(div);
            });
        }
        
        function loadCaption(captionId) {
            const captions = loadSavedCaptions();
            const caption = captions.find(c => c.id === captionId);
            
            if (!caption) {
                addMessengerLog('‚ùå Legenda n√£o encontrada');
                return;
            }
            
            const textarea = document.getElementById('message-text');
            if (textarea) {
                textarea.value = caption.text;
                textarea.focus();
                updateMessengerPreview();
                addMessengerLog(`‚úÖ Legenda "${caption.name}" carregada!`);
            }
        }
        
        function deleteCaption(captionId) {
            if (!confirm('Tem certeza que deseja deletar esta legenda?')) {
                return;
            }
            
            const captions = loadSavedCaptions();
            const filtered = captions.filter(c => c.id !== captionId);
            
            if (filtered.length === captions.length) {
                addMessengerLog('‚ùå Legenda n√£o encontrada');
                return;
            }
            
            saveSavedCaptions(filtered);
            displaySavedCaptions(filtered);
            addMessengerLog('‚úÖ Legenda deletada com sucesso!');
        }
        
        function toggleSavedCaptions() {
            const panel = document.getElementById('saved-captions-panel');
            if (!panel) return;
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                displaySavedCaptions();
            } else {
                panel.style.display = 'none';
            }
        }
        
        function filterSavedCaptions(searchTerm) {
            const captions = loadSavedCaptions();
            const term = searchTerm.toLowerCase().trim();
            
            if (!term) {
                displaySavedCaptions(captions);
                return;
            }
            
            const filtered = captions.filter(caption => 
                caption.name.toLowerCase().includes(term) || 
                caption.text.toLowerCase().includes(term)
            );
            
            displaySavedCaptions(filtered);
        }
        
        function filterGroups(searchTerm) {
            // Usar allGroupsList se dispon√≠vel, sen√£o usar groupsList
            const sourceList = allGroupsList.length > 0 ? allGroupsList : groupsList;
            if (!sourceList || sourceList.length === 0) return;
            
            const term = searchTerm.toLowerCase().trim();
            
            if (!term) {
                // Sem filtro - mostrar todos
                displayGroups(sourceList);
                return;
            }
            
            // Aplicar filtro
            const filtered = sourceList.filter(group => 
                group.name.toLowerCase().includes(term) || 
                group.id.toLowerCase().includes(term)
            );
            
            displayGroups(filtered);
        }
        
        function filterContacts(searchTerm) {
            // Usar allContactsList se dispon√≠vel, sen√£o usar contactsList
            const sourceList = allContactsList.length > 0 ? allContactsList : contactsList;
            if (!sourceList || sourceList.length === 0) return;
            
            const term = searchTerm.toLowerCase().trim();
            
            if (!term) {
                // Sem filtro - mostrar todos
                displayContacts(sourceList);
                return;
            }
            
            // Aplicar filtro
            const filtered = sourceList.filter(contact => {
                const name = (contact.name || '').toLowerCase();
                const number = (contact.number || '').toLowerCase();
                const id = (contact.id || '').toLowerCase();
                return name.includes(term) || number.includes(term) || id.includes(term);
            });
            
            displayContacts(filtered);
        }
        
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                addMessengerLog('‚ùå Por favor, selecione um arquivo de imagem.');
                return;
            }
            
            // Mostrar preview
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').style.display = 'block';
                updateMessengerPreview();
            };
            reader.readAsDataURL(file);
            
            // Fazer upload para o servidor
            addMessengerLog('üì§ Fazendo upload da imagem...');
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch(`${BACKEND_URL}/upload-image`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    uploadedImagePath = data.path;
                    addMessengerLog(`‚úÖ Imagem enviada: ${data.filename}`);
                } else {
                    addMessengerLog(`‚ùå Erro ao enviar imagem: ${data.error}`);
                }
            } catch (error) {
                addMessengerLog(`‚ùå Erro ao fazer upload: ${error.message}`);
            }
        }
        
        function removeImage() {
            if (!confirm('Tem certeza que deseja remover a imagem?')) {
                return;
            }
            
            uploadedImagePath = null;
            document.getElementById('image-upload').value = '';
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('image-preview').src = '';
            updateMessengerPreview();
            addMessengerLog('üóëÔ∏è Imagem removida');
            
            // Tentar deletar o arquivo do servidor se poss√≠vel
            // (O servidor pode n√£o ter endpoint para deletar, mas tentamos limpar a refer√™ncia)
        }
        
        async function loadGroups() {
            addMessengerLog('üîÑ Carregando grupos do WhatsApp...');
            
            try {
                // Primeiro verificar se o servidor est√° acess√≠vel
                const healthCheck = await fetch(`${WHATSAPP_API_URL}/health`);
                if (!healthCheck.ok) {
                    throw new Error(`Servidor retornou status ${healthCheck.status}`);
                }
                
                const response = await fetch(`${WHATSAPP_API_URL}/list-groups`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    groupsList = data.groups;
                    allGroupsList = data.groups; // Backup da lista completa
                    displayGroups(groupsList);
                    document.getElementById('groups-list').style.display = 'block';
                    // Limpar campo de pesquisa
                    document.getElementById('search-groups').value = '';
                    addMessengerLog(`‚úÖ ${data.count} grupo(s) carregado(s)`);
                } else {
                    addMessengerLog(`‚ùå Erro ao carregar grupos: ${data.error}`);
                }
            } catch (error) {
                addMessengerLog(`‚ùå Erro ao conectar com servidor WhatsApp: ${error.message}`);
                addMessengerLog('üí° Verifique se:');
                addMessengerLog('   1. O servidor WhatsApp est√° rodando (porta 3001)');
                addMessengerLog('   2. O servidor foi reiniciado ap√≥s as atualiza√ß√µes');
                addMessengerLog('   3. N√£o h√° firewall bloqueando a conex√£o');
                console.error('Erro detalhado:', error);
            }
        }
        
        function displayGroups(groups) {
            const container = document.getElementById('groups-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (groups.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nenhum grupo encontrado</div>';
                return;
            }
            
            groups.forEach(group => {
                const div = document.createElement('div');
                div.className = 'recipient-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `group-${group.id.replace(/[^a-zA-Z0-9]/g, '_')}`;
                checkbox.value = group.id;
                // Verificar se j√° est√° selecionado
                const isSelected = selectedRecipients.find(r => r.id === group.id);
                checkbox.checked = !!isSelected;
                checkbox.onchange = () => toggleRecipient(group.id, group.name, 'group');
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = `${group.name} (${group.participants || 0} participantes)`;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }
        
        async function loadContacts() {
            addMessengerLog('üîÑ Carregando contatos do WhatsApp...');
            
            try {
                // Primeiro verificar se o servidor est√° acess√≠vel
                const healthCheck = await fetch(`${WHATSAPP_API_URL}/health`);
                if (!healthCheck.ok) {
                    throw new Error(`Servidor retornou status ${healthCheck.status}`);
                }
                
                const response = await fetch(`${WHATSAPP_API_URL}/list-contacts`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    contactsList = data.contacts;
                    allContactsList = data.contacts; // Backup da lista completa
                    displayContacts(contactsList);
                    document.getElementById('contacts-list').style.display = 'block';
                    // Limpar campo de pesquisa
                    document.getElementById('search-contacts').value = '';
                    addMessengerLog(`‚úÖ ${data.count} contato(s) carregado(s)`);
                } else {
                    addMessengerLog(`‚ùå Erro ao carregar contatos: ${data.error}`);
                }
            } catch (error) {
                addMessengerLog(`‚ùå Erro ao conectar com servidor WhatsApp: ${error.message}`);
                addMessengerLog('üí° Verifique se:');
                addMessengerLog('   1. O servidor WhatsApp est√° rodando (porta 3001)');
                addMessengerLog('   2. O servidor foi reiniciado ap√≥s as atualiza√ß√µes');
                addMessengerLog('   3. N√£o h√° firewall bloqueando a conex√£o');
                console.error('Erro detalhado:', error);
            }
        }
        
        function displayContacts(contacts) {
            const container = document.getElementById('contacts-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (contacts.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nenhum contato encontrado</div>';
                return;
            }
            
            contacts.forEach(contact => {
                const div = document.createElement('div');
                div.className = 'recipient-item';
                const displayName = contact.name || contact.number || contact.id;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `contact-${contact.id.replace(/[^a-zA-Z0-9]/g, '_')}`;
                checkbox.value = contact.id;
                // Verificar se j√° est√° selecionado
                const isSelected = selectedRecipients.find(r => r.id === contact.id);
                checkbox.checked = !!isSelected;
                checkbox.onchange = () => toggleRecipient(contact.id, displayName, 'contact');
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = displayName;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }
        
        function toggleRecipient(id, name, type) {
            const checkbox = document.querySelector(`input[value="${id}"]`);
            const index = selectedRecipients.findIndex(r => r.id === id);
            
            if (checkbox.checked) {
                if (index === -1) {
                    selectedRecipients.push({ id, name, type });
                }
            } else {
                if (index !== -1) {
                    selectedRecipients.splice(index, 1);
                }
            }
            
            updateSelectedRecipients();
        }
        
        function updateSelectedRecipients() {
            const container = document.getElementById('selected-list');
            const selectedContainer = document.getElementById('selected-recipients');
            
            if (selectedRecipients.length === 0) {
                selectedContainer.style.display = 'none';
                return;
            }
            
            selectedContainer.style.display = 'block';
            container.innerHTML = '';
            
            selectedRecipients.forEach(recipient => {
                const span = document.createElement('span');
                span.className = 'selected-recipient';
                span.innerHTML = `${recipient.name} (${recipient.type === 'group' ? 'Grupo' : 'Contato'}) <span class="remove" onclick="removeRecipient('${recipient.id}')">√ó</span>`;
                container.appendChild(span);
            });
        }
        
        function removeRecipient(id) {
            selectedRecipients = selectedRecipients.filter(r => r.id !== id);
            const checkbox = document.querySelector(`input[value="${id}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            updateSelectedRecipients();
        }
        
        function addManualContact() {
            const input = document.getElementById('manual-contact');
            const number = input.value.trim().replace(/\D/g, ''); // Remove n√£o-d√≠gitos
            
            if (!number) {
                addMessengerLog('‚ùå Por favor, digite um n√∫mero v√°lido');
                return;
            }
            
            // Verificar se j√° existe
            if (selectedRecipients.find(r => r.id === number)) {
                addMessengerLog('‚ö†Ô∏è Contato j√° adicionado');
                return;
            }
            
            selectedRecipients.push({
                id: number,
                name: number,
                type: 'contact'
            });
            
            input.value = '';
            updateSelectedRecipients();
            addMessengerLog(`‚úÖ Contato ${number} adicionado`);
        }
        
        // ========== FUN√á√ïES PARA CARREGAR PLANILHA EXCEL ==========
        
        async function handleExcelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Limpar input para permitir selecionar o mesmo arquivo novamente
            event.target.value = '';
            
            addMessengerLog(`üìä Carregando planilha: ${file.name}...`);
            
            try {
                const data = await readExcelFile(file);
                excelData = data;
                
                if (!data || data.length === 0) {
                    addMessengerLog('‚ùå Planilha est√° vazia ou n√£o foi poss√≠vel ler os dados');
                    return;
                }
                
                // Extrair nomes das colunas da primeira linha
                excelColumns = Object.keys(data[0]);
                
                if (excelColumns.length === 0) {
                    addMessengerLog('‚ùå Nenhuma coluna encontrada na planilha');
                    return;
                }
                
                addMessengerLog(`‚úÖ Planilha carregada: ${data.length} linha(s), ${excelColumns.length} coluna(s)`);
                openExcelColumnModal();
                
            } catch (error) {
                console.error('Erro ao ler arquivo Excel:', error);
                addMessengerLog(`‚ùå Erro ao ler planilha: ${error.message}`);
                addMessengerLog('üí° Certifique-se de que o arquivo √© um Excel v√°lido (.xlsx, .xls) ou CSV');
            }
        }
        
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // Pegar a primeira aba
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        // Converter para JSON (array de objetos)
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
                        
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = function() {
                    reject(new Error('Erro ao ler arquivo'));
                };
                
                reader.readAsArrayBuffer(file);
            });
        }
        
        function openExcelColumnModal() {
            const modal = document.getElementById('excel-column-modal');
            const columnList = document.getElementById('excel-column-list');
            const previewTable = document.getElementById('excel-preview-table');
            
            if (!modal || !columnList) return;
            
            // Limpar sele√ß√£o anterior
            selectedColumnIndex = -1;
            document.getElementById('confirm-column-btn').disabled = true;
            document.getElementById('confirm-column-btn').style.opacity = '0.5';
            document.getElementById('confirm-column-btn').style.cursor = 'not-allowed';
            
            // Listar colunas
            columnList.innerHTML = '';
            excelColumns.forEach((col, index) => {
                const div = document.createElement('div');
                div.className = 'excel-column-item';
                div.dataset.columnIndex = index;
                
                // Pegar primeiros valores dessa coluna para preview
                const previewValues = excelData.slice(0, 5).map(row => row[col] || '(vazio)').join(', ');
                
                div.innerHTML = `
                    <div class="excel-column-item-header">${col}</div>
                    <div class="excel-column-item-preview">Preview: ${previewValues}</div>
                `;
                
                div.onclick = () => selectExcelColumn(index);
                columnList.appendChild(div);
            });
            
            // Criar preview da tabela
            if (previewTable && excelData.length > 0) {
                previewTable.innerHTML = '';
                
                // Cabe√ßalho
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                excelColumns.forEach(col => {
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                previewTable.appendChild(thead);
                
                // Primeiras 5 linhas
                const tbody = document.createElement('tbody');
                excelData.slice(0, 5).forEach(row => {
                    const tr = document.createElement('tr');
                    excelColumns.forEach(col => {
                        const td = document.createElement('td');
                        td.textContent = row[col] || '';
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                previewTable.appendChild(tbody);
            }
            
            modal.classList.add('active');
        }
        
        function selectExcelColumn(index) {
            selectedColumnIndex = index;
            
            // Remover sele√ß√£o anterior
            document.querySelectorAll('.excel-column-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Adicionar sele√ß√£o atual
            const selectedItem = document.querySelector(`[data-column-index="${index}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // Habilitar bot√£o de confirmar
            const confirmBtn = document.getElementById('confirm-column-btn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.style.opacity = '1';
                confirmBtn.style.cursor = 'pointer';
            }
        }
        
        function confirmExcelColumn() {
            if (selectedColumnIndex === -1 || !excelData) {
                addMessengerLog('‚ùå Por favor, selecione uma coluna');
                return;
            }
            
            const columnName = excelColumns[selectedColumnIndex];
            const contactsFromExcel = [];
            
            // Extrair n√∫meros √∫nicos da coluna selecionada
            const seenNumbers = new Set();
            excelData.forEach((row, index) => {
                let phoneNumber = String(row[columnName] || '').trim();
                
                // Remover caracteres n√£o num√©ricos
                phoneNumber = phoneNumber.replace(/\D/g, '');
                
                // Se estiver vazio, pular
                if (!phoneNumber) return;
                
                // Normalizar n√∫mero brasileiro
                // Se come√ßar com 0, remover (pode ser 0 + DDD)
                if (phoneNumber.startsWith('0')) {
                    phoneNumber = phoneNumber.substring(1);
                }
                
                // Verificar se j√° tem c√≥digo do pa√≠s (55)
                const hasCountryCode = phoneNumber.startsWith('55');
                
                // Se n√£o tem c√≥digo do pa√≠s e tem 10-11 d√≠gitos (formato nacional), adicionar 55
                if (!hasCountryCode && phoneNumber.length >= 10 && phoneNumber.length <= 11) {
                    phoneNumber = '55' + phoneNumber;
                }
                // Se j√° tem c√≥digo do pa√≠s, garantir que tem pelo menos 12 d√≠gitos (55 + DDD + n√∫mero)
                // N√∫meros brasileiros com c√≥digo do pa√≠s devem ter 12-13 d√≠gitos
                else if (hasCountryCode && phoneNumber.length < 12) {
                    // N√∫mero muito curto mesmo com c√≥digo do pa√≠s, pular
                    console.warn(`N√∫mero muito curto ignorado: ${phoneNumber}`);
                    return;
                }
                
                // Validar n√∫mero final
                // N√∫meros brasileiros v√°lidos: 12-13 d√≠gitos (55 + DDD + n√∫mero de 8-9 d√≠gitos)
                // Ou n√∫meros internacionais v√°lidos (mais de 10 d√≠gitos)
                const isValidLength = (hasCountryCode && phoneNumber.length >= 12 && phoneNumber.length <= 13) ||
                                     (!hasCountryCode && phoneNumber.length >= 10);
                
                if (isValidLength && !seenNumbers.has(phoneNumber)) {
                    seenNumbers.add(phoneNumber);
                    contactsFromExcel.push({
                        id: phoneNumber,
                        name: `${phoneNumber} (Planilha)`,
                        type: 'contact',
                        source: 'excel'
                    });
                } else if (!isValidLength) {
                    console.warn(`N√∫mero inv√°lido ignorado: ${phoneNumber} (tamanho: ${phoneNumber.length})`);
                }
            });
            
            if (contactsFromExcel.length === 0) {
                addMessengerLog('‚ùå Nenhum n√∫mero v√°lido encontrado na coluna selecionada');
                closeExcelColumnModal();
                return;
            }
            
            // Adicionar aos contatos
            contactsList = contactsFromExcel;
            allContactsList = contactsFromExcel;
            
            // Mostrar na interface
            displayContacts(contactsList);
            document.getElementById('contacts-list').style.display = 'block';
            document.getElementById('search-contacts').value = '';
            
            addMessengerLog(`‚úÖ ${contactsFromExcel.length} contato(s) carregado(s) da planilha (coluna: ${columnName})`);
            
            // Preparar contatos no WhatsApp (for√ßa cria√ß√£o do LID)
            addMessengerLog(`üîÑ Preparando contatos no WhatsApp (isso pode levar alguns segundos)...`);
            prepareExcelContacts(contactsFromExcel.map(c => c.id));
            
            closeExcelColumnModal();
        }
        
        function closeExcelColumnModal() {
            const modal = document.getElementById('excel-column-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            // Limpar dados tempor√°rios
            selectedColumnIndex = -1;
            excelData = null;
            excelColumns = [];
        }
        
        // Fun√ß√£o para testar envio de mensagem simples
        async function testSendMessage() {
            const testNumber = document.getElementById('test-number').value.trim();
            if (!testNumber) {
                addMessengerLog('‚ùå Por favor, digite um n√∫mero para teste');
                return;
            }
            
            addMessengerLog(`üß™ TESTE: Enviando "oi" para ${testNumber}...`);
            
            try {
                // Verificar se servidor est√° pronto
                const healthResponse = await fetch('http://localhost:3001/health');
                if (!healthResponse.ok) {
                    addMessengerLog('‚ùå Servidor WhatsApp n√£o est√° acess√≠vel');
                    return;
                }
                
                const healthData = await healthResponse.json();
                if (healthData.status !== 'ready') {
                    addMessengerLog(`‚ùå Servidor WhatsApp n√£o est√° pronto. Status: ${healthData.status}`);
                    return;
                }
                
                // Enviar mensagem de teste
                const response = await fetch(`${WHATSAPP_API_URL}/test-send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        number: testNumber,
                        message: 'oi'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addMessengerLog(`‚úÖ TESTE: Mensagem enviada com sucesso!`);
                    addMessengerLog(`   Chat ID: ${data.chatId}`);
                    addMessengerLog(`   N√∫mero formatado: ${data.formattedNumber}`);
                    if (data.attempts && data.attempts.length > 0) {
                        addMessengerLog(`   Tentativas:`);
                        data.attempts.forEach((attempt, index) => {
                            if (attempt.success) {
                                addMessengerLog(`     ${index + 1}. ‚úÖ ${attempt.method} - Sucesso`);
                            } else {
                                addMessengerLog(`     ${index + 1}. ‚ùå ${attempt.method} - ${attempt.error}`);
                            }
                        });
                    }
                } else {
                    addMessengerLog(`‚ùå TESTE: Falhou - ${data.error}`);
                    if (data.attempts && data.attempts.length > 0) {
                        addMessengerLog(`   Tentativas realizadas:`);
                        data.attempts.forEach((attempt, index) => {
                            if (attempt.success) {
                                addMessengerLog(`     ${index + 1}. ‚úÖ ${attempt.method} - Sucesso`);
                            } else {
                                addMessengerLog(`     ${index + 1}. ‚ùå ${attempt.method} - ${attempt.error}`);
                            }
                        });
                    }
                    if (data.info) {
                        addMessengerLog(`   üí° ${data.info}`);
                    }
                }
            } catch (error) {
                addMessengerLog(`‚ùå TESTE: Erro ao enviar - ${error.message}`);
                console.error('Erro detalhado:', error);
            }
        }
        
        // Preparar contatos da planilha no WhatsApp (for√ßa cria√ß√£o do LID)
        async function prepareExcelContacts(numbers) {
            try {
                // Verificar se servidor est√° pronto
                const healthResponse = await fetch('http://localhost:3001/health');
                if (!healthResponse.ok) {
                    addMessengerLog('‚ö†Ô∏è Servidor WhatsApp n√£o est√° acess√≠vel. Pulando prepara√ß√£o de contatos.');
                    return;
                }
                
                const healthData = await healthResponse.json();
                if (healthData.status !== 'ready') {
                    addMessengerLog('‚ö†Ô∏è Servidor WhatsApp n√£o est√° pronto. Pulando prepara√ß√£o de contatos.');
                    return;
                }
                
                // Preparar contatos em lotes (para n√£o sobrecarregar)
                const batchSize = 10; // Preparar 10 contatos por vez
                let processed = 0;
                let prepared = 0;
                let failed = 0;
                
                for (let i = 0; i < numbers.length; i += batchSize) {
                    const batch = numbers.slice(i, i + batchSize);
                    
                    try {
                        const response = await fetch(`${WHATSAPP_API_URL}/prepare-contacts`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ numbers: batch })
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                prepared += data.results.prepared.length;
                                failed += data.results.failed.length;
                                processed += batch.length;
                                
                                addMessengerLog(`   üìä Progresso: ${processed}/${numbers.length} processados (${prepared} preparados, ${failed} falharam)`);
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao preparar lote de contatos:', error);
                    }
                    
                    // Pequeno delay entre lotes
                    if (i + batchSize < numbers.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                if (prepared > 0) {
                    addMessengerLog(`‚úÖ ${prepared} contato(s) preparado(s) com sucesso no WhatsApp`);
                }
                if (failed > 0) {
                    addMessengerLog(`‚ö†Ô∏è ${failed} contato(s) falharam na prepara√ß√£o (podem n√£o estar registrados no WhatsApp)`);
                }
                
            } catch (error) {
                console.error('Erro ao preparar contatos:', error);
                addMessengerLog(`‚ö†Ô∏è Erro ao preparar contatos: ${error.message}`);
                addMessengerLog(`   Os contatos foram carregados, mas pode ser necess√°rio prepar√°-los manualmente`);
            }
        }
        
        
        function clearSelection() {
            selectedRecipients = [];
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateSelectedRecipients();
            addMessengerLog('üóëÔ∏è Sele√ß√£o limpa');
        }
        
        function selectAllGroups() {
            // Usar allGroupsList se dispon√≠vel (lista completa), sen√£o usar groupsList (pode estar filtrada)
            const sourceList = allGroupsList.length > 0 ? allGroupsList : groupsList;
            if (!sourceList || sourceList.length === 0) return;
            
            const checkboxes = document.querySelectorAll('#groups-container input[type="checkbox"]');
            const visibleIds = Array.from(checkboxes).map(cb => cb.value);
            const allVisibleSelected = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                const shouldSelect = !allVisibleSelected;
                checkbox.checked = shouldSelect;
                
                // Buscar o grupo na lista completa
                const group = sourceList.find(g => g.id === checkbox.value);
                if (group) {
                    if (shouldSelect) {
                        // Adicionar se n√£o estiver na lista
                        if (!selectedRecipients.find(r => r.id === checkbox.value)) {
                            selectedRecipients.push({ id: checkbox.value, name: group.name, type: 'group' });
                        }
                    } else {
                        // Remover da lista
                        selectedRecipients = selectedRecipients.filter(r => r.id !== checkbox.value);
                    }
                }
            });
            
            updateSelectedRecipients();
            addMessengerLog(allVisibleSelected ? 'üóëÔ∏è Grupos vis√≠veis desmarcados' : `‚úÖ ${checkboxes.length} grupo(s) selecionado(s)`);
        }
        
        function selectAllContacts() {
            // Usar allContactsList se dispon√≠vel (lista completa), sen√£o usar contactsList (pode estar filtrada)
            const sourceList = allContactsList.length > 0 ? allContactsList : contactsList;
            if (!sourceList || sourceList.length === 0) return;
            
            const checkboxes = document.querySelectorAll('#contacts-container input[type="checkbox"]');
            const allVisibleSelected = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(checkbox => {
                const shouldSelect = !allVisibleSelected;
                checkbox.checked = shouldSelect;
                
                // Buscar o contato na lista completa
                const contact = sourceList.find(c => c.id === checkbox.value);
                if (contact) {
                    const displayName = contact.name || contact.number || contact.id;
                    if (shouldSelect) {
                        // Adicionar se n√£o estiver na lista
                        if (!selectedRecipients.find(r => r.id === checkbox.value)) {
                            selectedRecipients.push({ id: checkbox.value, name: displayName, type: 'contact' });
                        }
                    } else {
                        // Remover da lista
                        selectedRecipients = selectedRecipients.filter(r => r.id !== checkbox.value);
                    }
                }
            });
            
            updateSelectedRecipients();
            addMessengerLog(allVisibleSelected ? 'üóëÔ∏è Contatos vis√≠veis desmarcados' : `‚úÖ ${checkboxes.length} contato(s) selecionado(s)`);
        }
        
        async function sendMessages() {
            if (selectedRecipients.length === 0) {
                addMessengerLog('‚ùå Por favor, selecione pelo menos um destinat√°rio');
                return;
            }
            
            const text = document.getElementById('message-text').value.trim();
            
            if (!uploadedImagePath && !text) {
                addMessengerLog('‚ùå Por favor, adicione uma imagem ou texto');
                return;
            }
            
            // Verificar se servidor WhatsApp est√° pronto
            try {
                const healthResponse = await fetch(`${WHATSAPP_API_URL}/health`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!healthResponse.ok) {
                    throw new Error(`Servidor retornou status ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                
                if (healthData.status !== 'ready') {
                    addMessengerLog('‚ùå Servidor WhatsApp n√£o est√° pronto. Aguarde a autentica√ß√£o.');
                    addMessengerLog(`   Status atual: ${healthData.status}`);
                    addMessengerLog(`   Mensagem: ${healthData.message || 'N/A'}`);
                    return;
                }
            } catch (error) {
                addMessengerLog('‚ùå N√£o foi poss√≠vel conectar ao servidor WhatsApp');
                addMessengerLog(`   Erro: ${error.message}`);
                addMessengerLog('üí° Verifique se:');
                addMessengerLog('   1. O servidor WhatsApp est√° rodando (porta 3001)');
                addMessengerLog('   2. O servidor foi reiniciado ap√≥s as atualiza√ß√µes');
                addMessengerLog('   3. N√£o h√° firewall bloqueando a conex√£o');
                console.error('Erro detalhado:', error);
                return;
            }
            
            // Desabilitar bot√£o
            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥ Enviando...';
            
            // Obter delays configurados
            const delayFirstMin = parseInt(document.getElementById('delay-first-min').value) || 25;
            const delayFirstMax = parseInt(document.getElementById('delay-first-max').value) || 35;
            const delaySubsequentMin = parseInt(document.getElementById('delay-subsequent-min').value) || 30;
            const delaySubsequentMax = parseInt(document.getElementById('delay-subsequent-max').value) || 45;
            
            // Validar delays
            if (delayFirstMin < 1 || delayFirstMax < delayFirstMin) {
                addMessengerLog('‚ùå Delay da primeira mensagem inv√°lido. O m√°ximo deve ser maior que o m√≠nimo.');
                sendBtn.disabled = false;
                sendBtn.textContent = 'üöÄ Disparar Mensagens';
                return;
            }
            
            if (delaySubsequentMin < 1 || delaySubsequentMax < delaySubsequentMin) {
                addMessengerLog('‚ùå Delay das mensagens subsequentes inv√°lido. O m√°ximo deve ser maior que o m√≠nimo.');
                sendBtn.disabled = false;
                sendBtn.textContent = 'üöÄ Disparar Mensagens';
                return;
            }
            
            addMessengerLog(`üöÄ Iniciando envio para ${selectedRecipients.length} destinat√°rio(s)...`);
            addMessengerLog(`‚è±Ô∏è Delay configurado (simula√ß√£o humana):`);
            addMessengerLog(`   ‚Ä¢ Primeira mensagem: ${delayFirstMin}-${delayFirstMax} segundos`);
            addMessengerLog(`   ‚Ä¢ Mensagens subsequentes: ${delaySubsequentMin}-${delaySubsequentMax} segundos`);
            addMessengerLog(`üé≤ Usando aleatoriedade m√°xima para parecer mais humano`);
            
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/send-batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipients: selectedRecipients,
                        imagePath: uploadedImagePath || null,
                        text: text || null,
                        delayFirstMin: delayFirstMin * 1000, // Converter para milissegundos
                        delayFirstMax: delayFirstMax * 1000, // Converter para milissegundos
                        delaySubsequentMin: delaySubsequentMin * 1000, // Converter para milissegundos
                        delaySubsequentMax: delaySubsequentMax * 1000  // Converter para milissegundos
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addMessengerLog(`‚úÖ Envio conclu√≠do!`);
                    addMessengerLog(`   ‚úì Sucesso: ${data.results.success.length}`);
                    addMessengerLog(`   ‚úó Falhas: ${data.results.failed.length}`);
                    
                    if (data.results.failed.length > 0) {
                        addMessengerLog('‚ùå Falhas:');
                        data.results.failed.forEach(failed => {
                            addMessengerLog(`   - ${failed.name}: ${failed.error}`);
                        });
                    }
                } else {
                    addMessengerLog(`‚ùå Erro: ${data.error}`);
                }
            } catch (error) {
                addMessengerLog(`‚ùå Erro ao enviar: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'üöÄ Disparar Mensagens';
            }
        }
        
        const WHATSAPP_API_URL = getWhatsAppUrl();
        console.log('üì± WhatsApp API URL:', WHATSAPP_API_URL);
        let whatsappStatusInterval = null;
        let whatsappLogsInterval = null;
        let whatsappQrInterval = null;
        
        function escapeHtml(text = '') {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function setWhatsAppButtonsState({ running, ready, hasQR }) {
            const startBtn = document.getElementById('start-whatsapp-server-btn');
            const stopBtn = document.getElementById('stop-whatsapp-server-btn');
            const qrBtn = document.getElementById('show-qr-btn');
            const logoutBtn = document.getElementById('logout-whatsapp-btn');
            
            if (startBtn) startBtn.style.display = running ? 'none' : 'inline-block';
            if (stopBtn) stopBtn.style.display = running ? 'inline-block' : 'none';
            
            if (logoutBtn) {
                logoutBtn.style.display = running && ready ? 'inline-block' : 'none';
            }
            
            if (qrBtn) {
                const shouldShowQR = running && !ready;
                qrBtn.style.display = shouldShowQR ? 'inline-block' : 'none';
                qrBtn.disabled = shouldShowQR && !hasQR;
                qrBtn.textContent = hasQR ? 'üì± Ler QR Code' : 'üì± Aguardando QR...';
                qrBtn.style.opacity = qrBtn.disabled ? '0.7' : '1';
            }
        }
        
        async function checkWhatsAppServerStatus() {
            const statusText = document.getElementById('whatsapp-server-status-text');
            const readyStatus = document.getElementById('whatsapp-ready-status');
            
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/server-status`);
                if (!response.ok) throw new Error('Servidor indispon√≠vel');
                
                const data = await response.json();
                const running = Boolean(data.running);
                const ready = Boolean(data.ready);
                const hasQR = Boolean(data.hasQR);
                
                setWhatsAppButtonsState({ running, ready, hasQR });
                
                if (running) {
                    const statusMessage = ready ? 'üü¢ Servidor Online' : 'üü° Servidor aguardando login';
                    statusText.textContent = statusMessage;
                    statusText.style.color = ready ? '#28a745' : '#ff9800';
                    
                    readyStatus.textContent = ready
                        ? `‚úÖ Conectado${data.number ? ` (${data.number})` : ''}`
                        : 'üì± Escaneie o QR Code para conectar';
                    readyStatus.style.color = ready ? '#28a745' : '#ff9800';
                    
                    if (hasQR && !ready) {
                        showQRCode(true);
                    } else if (ready) {
                        hideQRCode(true);
                    }
                } else {
                    statusText.textContent = '‚è∏Ô∏è Servidor parado';
                    statusText.style.color = '#6c757d';
                    readyStatus.textContent = 'Servidor inativo';
                    readyStatus.style.color = '#6c757d';
                    hideQRCode(true);
                }
            } catch (error) {
                statusText.textContent = '‚ùå Erro ao consultar servidor';
                statusText.style.color = '#dc3545';
                readyStatus.textContent = error.message;
                readyStatus.style.color = '#dc3545';
                setWhatsAppButtonsState({ running: false, ready: false, hasQR: false });
                hideQRCode(true);
            }
        }
        
        async function startWhatsAppServer() {
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/server-control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'start' })
                });
                
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'N√£o foi poss√≠vel iniciar o servidor');
                }
                
                alert(data.message || 'Servidor iniciado! Aguarde o QR Code para conectar.');
                checkWhatsAppServerStatus();
                refreshWhatsAppServerLogs();
            } catch (error) {
                alert(`Erro ao iniciar servidor: ${error.message}`);
            }
        }
        
        async function stopWhatsAppServer() {
            if (!confirm('Deseja realmente parar o servidor WhatsApp?')) {
                return;
            }
            
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/server-control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'stop' })
                });
                
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'N√£o foi poss√≠vel parar o servidor');
                }
                
                alert(data.message || 'Servidor parado.');
                checkWhatsAppServerStatus();
                refreshWhatsAppServerLogs();
            } catch (error) {
                alert(`Erro ao parar servidor: ${error.message}`);
            }
        }
        
        async function logoutWhatsApp() {
            if (!confirm('Tem certeza que deseja deslogar? Voc√™ precisar√° escanear um novo QR Code.')) {
                return;
            }
            
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'N√£o foi poss√≠vel realizar o logout.');
                }
                
                alert(data.message || 'Logout realizado! Aguarde o novo QR Code.');
                showQRCode(true);
                checkWhatsAppServerStatus();
                refreshWhatsAppServerLogs();
            } catch (error) {
                alert(`Erro ao fazer logout: ${error.message}`);
            }
        }
        
        function showQRCode(autoOpen = false) {
            const qrContainer = document.getElementById('whatsapp-qr-container');
            if (!qrContainer) return;
            
            qrContainer.style.display = 'block';
            fetchWhatsAppQRCode();
            
            if (whatsappQrInterval) clearInterval(whatsappQrInterval);
            whatsappQrInterval = setInterval(fetchWhatsAppQRCode, 5000);
            
            if (!autoOpen) {
                qrContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        
        function hideQRCode(silent = false) {
            const qrContainer = document.getElementById('whatsapp-qr-container');
            if (!qrContainer) return;
            
            qrContainer.style.display = 'none';
            const qrCodeDiv = document.getElementById('whatsapp-qr-code');
            if (qrCodeDiv && !silent) {
                qrCodeDiv.innerHTML = '<p style="color: #666; font-size: 12px;">QR Code oculto.</p>';
            }
            
            if (whatsappQrInterval) {
                clearInterval(whatsappQrInterval);
                whatsappQrInterval = null;
            }
        }
        
        async function fetchWhatsAppQRCode() {
            const qrCodeDiv = document.getElementById('whatsapp-qr-code');
            if (!qrCodeDiv) return;
            
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/qr-code`);
                if (!response.ok) throw new Error('Servidor indispon√≠vel');
                
                const data = await response.json();
                if (data.success && data.hasQR && data.qr) {
                    qrCodeDiv.innerHTML = '';
                    if (typeof QRCode !== 'undefined') {
                        const canvas = document.createElement('canvas');
                        qrCodeDiv.appendChild(canvas);
                        QRCode.toCanvas(canvas, data.qr, { width: 240, margin: 2 }, (error) => {
                            if (error) {
                                console.error('Erro ao renderizar QR:', error);
                                qrCodeDiv.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(data.qr)}" alt="QR Code" style="max-width: 100%;">`;
                            }
                        });
                    } else {
                        qrCodeDiv.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(data.qr)}" alt="QR Code" style="max-width: 100%;">`;
                    }
                } else {
                    qrCodeDiv.innerHTML = '<p style="color: #666; font-size: 12px;">QR Code ainda n√£o dispon√≠vel. Aguarde alguns segundos...</p>';
                }
            } catch (error) {
                qrCodeDiv.innerHTML = `<p style="color: #dc3545; font-size: 12px;">Erro ao carregar QR Code: ${escapeHtml(error.message)}</p>`;
            }
        }
        
        async function refreshWhatsAppServerLogs() {
            const logsDiv = document.getElementById('whatsapp-server-logs');
            if (!logsDiv) return;
            
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/logs?limit=200`);
                if (!response.ok) throw new Error('Servidor indispon√≠vel');
                
                const data = await response.json();
                logsDiv.style.display = 'block';
                
                if (data.success && data.logs && data.logs.length > 0) {
                    const emojiMap = {
                        'INFO': '‚ÑπÔ∏è',
                        'QR_CODE': 'üì±',
                        'READY': '‚úÖ',
                        'AUTHENTICATED': 'üîê',
                        'AUTH_FAILURE': '‚ùå',
                        'DISCONNECTED': '‚ö†Ô∏è',
                        'RECONNECT': 'üîÑ',
                        'LOGOUT': 'üö™',
                        'ERROR': '‚õî'
                    };
                    
                    logsDiv.innerHTML = data.logs.map(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString('pt-BR', { hour12: false });
                        const emoji = emojiMap[log.type] || 'üìù';
                        return `<div style="margin-bottom: 4px;"><span style="color: #888;">[${time}]</span> ${emoji} ${escapeHtml(log.message || '')}</div>`;
                    }).join('');
                } else {
                    logsDiv.innerHTML = '<div style="color: #888; font-style: italic;">Nenhum log dispon√≠vel.</div>';
                }
            } catch (error) {
                logsDiv.style.display = 'block';
                logsDiv.innerHTML = `<div style="color: #dc3545;">Erro ao carregar logs: ${escapeHtml(error.message)}</div>`;
            }
        }
        
        function startMessengerTabPolling() {
            checkWhatsAppServerStatus();
            refreshWhatsAppServerLogs();
            
            if (whatsappStatusInterval) clearInterval(whatsappStatusInterval);
            whatsappStatusInterval = setInterval(checkWhatsAppServerStatus, 5000);
            
            if (whatsappLogsInterval) clearInterval(whatsappLogsInterval);
            whatsappLogsInterval = setInterval(refreshWhatsAppServerLogs, 6000);
        }
        
        function stopMessengerTabPolling() {
            if (whatsappStatusInterval) {
                clearInterval(whatsappStatusInterval);
                whatsappStatusInterval = null;
            }
            if (whatsappLogsInterval) {
                clearInterval(whatsappLogsInterval);
                whatsappLogsInterval = null;
            }
            if (whatsappQrInterval) {
                clearInterval(whatsappQrInterval);
                whatsappQrInterval = null;
            }
            hideQRCode(true);
        }
        
        // ========== FIM DAS FUN√á√ïES DE CONTROLE DO SERVIDOR WHATSAPP ==========
        
        function addMessengerLog(message) {
            const logsOutput = document.getElementById('messenger-logs');
            if (logsOutput) {
                const timestamp = new Date().toLocaleTimeString('pt-BR');
                logsOutput.value += `[${timestamp}] ${message}\n`;
                logsOutput.scrollTop = logsOutput.scrollHeight;
            }
        }
        
        // ========== FUN√á√ïES DE ENVIO EM LOTE ==========
        
        let batchFiles = [];
        let unidadesMapping = null;
        
        function handleBatchFolderSelect(event) {
            const files = Array.from(event.target.files).filter(file => {
                const ext = file.name.toLowerCase().split('.').pop();
                return ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
            });
            
            batchFiles = files;
            
            const infoDiv = document.getElementById('batch-files-info');
            const countSpan = document.getElementById('batch-files-count');
            const listDiv = document.getElementById('batch-files-list');
            
            if (files.length > 0) {
                infoDiv.style.display = 'block';
                countSpan.textContent = files.length;
                
                // Listar primeiros 20 arquivos
                const maxDisplay = 20;
                let html = '<div style="margin-top: 5px;">';
                files.slice(0, maxDisplay).forEach((file, index) => {
                    const unidade = extractUnidadeFromFilename(file.name);
                    html += `<div style="padding: 3px 0; border-bottom: 1px solid #eee;">
                        ${index + 1}. ${file.name}${unidade ? ` <span style="color: #28a745;">‚Üí ${unidade}</span>` : ''}
                    </div>`;
                });
                if (files.length > maxDisplay) {
                    html += `<div style="padding: 3px 0; color: #999; font-style: italic;">
                        ... e mais ${files.length - maxDisplay} arquivo(s)
                    </div>`;
                }
                html += '</div>';
                listDiv.innerHTML = html;
                
                addMessengerLog(`‚úÖ ${files.length} imagem(ns) selecionada(s) da pasta`);
            } else {
                infoDiv.style.display = 'none';
                addMessengerLog('‚ö†Ô∏è Nenhuma imagem v√°lida encontrada na pasta');
            }
        }
        
        function extractUnidadeFromFilename(filename) {
            // Remove extens√£o
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, '');
            
            // Padr√£o: W_16_11_BAU_1 ou similar
            // Procura por padr√£o de 3 letras mai√∫sculas (c√≥digo de unidade)
            const match = nameWithoutExt.match(/_([A-Z]{3})_/);
            if (match) {
                return match[1];
            }
            
            // Tenta outros padr√µes comuns
            const patterns = [
                /([A-Z]{3})_\d+/,  // BAU_1
                /_([A-Z]{3})$/,     // _BAU
                /^([A-Z]{3})_/,     // BAU_
                /([A-Z]{3})/        // Qualquer 3 letras mai√∫sculas
            ];
            
            for (const pattern of patterns) {
                const m = nameWithoutExt.match(pattern);
                if (m) {
                    return m[1];
                }
            }
            
            return null;
        }
        
        async function loadUnidadesMapping() {
            if (unidadesMapping) {
                return unidadesMapping;
            }
            
            try {
                addMessengerLog('üîÑ Carregando mapeamento de unidades...');
                const response = await fetch('${BACKEND_URL}/load-unidades', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.mapping) {
                        unidadesMapping = data.mapping;
                        addMessengerLog(`‚úÖ Mapeamento carregado: ${Object.keys(unidadesMapping).length} unidade(s)`);
                        return unidadesMapping;
                    } else {
                        addMessengerLog(`‚ö†Ô∏è ${data.error || 'Erro ao carregar mapeamento'}`);
                        return null;
                    }
                } else {
                    addMessengerLog(`‚ùå Erro HTTP ${response.status} ao carregar unidades`);
                    return null;
                }
            } catch (error) {
                addMessengerLog(`‚ùå Erro ao carregar unidades: ${error.message}`);
                return null;
            }
        }
        
        function toggleBatchMode() {
            const mode = document.getElementById('batch-mode').value;
            const infoDiv = document.getElementById('batch-specific-info');
            
            if (mode === 'specific') {
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        function clearBatchSelection() {
            batchFiles = [];
            document.getElementById('batch-folder-input').value = '';
            document.getElementById('batch-files-info').style.display = 'none';
            addMessengerLog('üóëÔ∏è Sele√ß√£o de pasta limpa');
        }
        
        async function startBatchSend() {
            if (batchFiles.length === 0) {
                addMessengerLog('‚ùå Por favor, selecione uma pasta com imagens');
                return;
            }
            
            const mode = document.getElementById('batch-mode').value;
            const caption = document.getElementById('message-text').value.trim();
            
            // Verificar servidor WhatsApp
            try {
                const healthResponse = await fetch('http://localhost:3001/health');
                if (!healthResponse.ok) {
                    throw new Error(`Servidor retornou status ${healthResponse.status}`);
                }
                
                const healthData = await healthResponse.json();
                if (healthData.status !== 'ready') {
                    addMessengerLog('‚ùå Servidor WhatsApp n√£o est√° pronto. Aguarde a autentica√ß√£o.');
                    return;
                }
            } catch (error) {
                addMessengerLog('‚ùå N√£o foi poss√≠vel conectar ao servidor WhatsApp');
                addMessengerLog(`   Erro: ${error.message}`);
                return;
            }
            
            // Se modo espec√≠fico, carregar mapeamento
            if (mode === 'specific') {
                const mapping = await loadUnidadesMapping();
                if (!mapping) {
                    addMessengerLog('‚ùå N√£o foi poss√≠vel carregar mapeamento de unidades. Verifique o arquivo Unidades.xlsx');
                    return;
                }
            } else {
                // Modo "todos" - verificar se h√° destinat√°rios selecionados
                if (selectedRecipients.length === 0) {
                    addMessengerLog('‚ùå Por favor, selecione pelo menos um destinat√°rio (grupo ou contato)');
                    return;
                }
            }
            
            // Desabilitar bot√£o
            const sendBtn = document.getElementById('batch-send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥ Enviando...';
            
            // Mostrar progresso
            const progressDiv = document.getElementById('batch-progress');
            progressDiv.style.display = 'block';
            
            let successCount = 0;
            let failCount = 0;
            
            addMessengerLog(`üöÄ Iniciando envio em lote de ${batchFiles.length} imagem(ns)...`);
            addMessengerLog(`üìã Modo: ${mode === 'all' ? 'Enviar para Todos' : 'Espec√≠fico por Unidade'}`);
            
            for (let i = 0; i < batchFiles.length; i++) {
                const file = batchFiles[i];
                const fileName = file.name;
                
                // Atualizar progresso
                const progress = ((i + 1) / batchFiles.length) * 100;
                document.getElementById('batch-progress-bar').style.width = progress + '%';
                document.getElementById('batch-progress-text').textContent = `${i + 1} / ${batchFiles.length}`;
                document.getElementById('batch-current-file').textContent = `Enviando: ${fileName}`;
                
                try {
                    let recipients = [];
                    
                    if (mode === 'specific') {
                        // Extrair unidade do nome do arquivo
                        const unidade = extractUnidadeFromFilename(fileName);
                        
                        if (!unidade) {
                            addMessengerLog(`‚ö†Ô∏è N√£o foi poss√≠vel extrair unidade de: ${fileName} - Pulando...`);
                            failCount++;
                            continue;
                        }
                        
                        // Buscar grupo correspondente
                        const groupId = unidadesMapping[unidade];
                        
                        if (!groupId) {
                            addMessengerLog(`‚ö†Ô∏è Unidade "${unidade}" n√£o encontrada no mapeamento - Pulando: ${fileName}`);
                            failCount++;
                            continue;
                        }
                        
                        recipients = [{
                            id: groupId,
                            name: `Grupo ${unidade}`,
                            type: 'group'
                        }];
                        
                        addMessengerLog(`üì§ [${i + 1}/${batchFiles.length}] Enviando ${fileName} ‚Üí Unidade: ${unidade} ‚Üí Grupo: ${groupId}`);
                    } else {
                        // Modo "todos" - usar destinat√°rios selecionados
                        recipients = selectedRecipients;
                        addMessengerLog(`üì§ [${i + 1}/${batchFiles.length}] Enviando ${fileName} para ${recipients.length} destinat√°rio(s)`);
                    }
                    
                    // Fazer upload da imagem primeiro
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const uploadResponse = await fetch(`${BACKEND_URL}/upload-image`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        throw new Error(`Erro no upload: ${uploadResponse.status}`);
                    }
                    
                    const uploadData = await uploadResponse.json();
                    
                    if (uploadData.status !== 'success') {
                        throw new Error(uploadData.error || 'Erro desconhecido no upload');
                    }
                    
                    const imagePath = uploadData.path;
                    
                    // Enviar para destinat√°rios
                    const sendResponse = await fetch(`${WHATSAPP_API_URL}/send-batch`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            recipients: recipients,
                            imagePath: imagePath,
                            text: caption || null,
                            delayFirstMin: 25000,
                            delayFirstMax: 35000,
                            delaySubsequentMin: 30000,
                            delaySubsequentMax: 45000
                        })
                    });
                    
                    const sendData = await sendResponse.json();
                    
                    if (sendData.success) {
                        successCount += sendData.results.success.length;
                        failCount += sendData.results.failed.length;
                        addMessengerLog(`‚úÖ ${fileName} enviado com sucesso`);
                    } else {
                        failCount++;
                        addMessengerLog(`‚ùå Erro ao enviar ${fileName}: ${sendData.error}`);
                    }
                    
                    // Delay entre envios (exceto no √∫ltimo)
                    if (i < batchFiles.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    
                } catch (error) {
                    failCount++;
                    addMessengerLog(`‚ùå Erro ao processar ${fileName}: ${error.message}`);
                }
            }
            
            // Finalizar
            addMessengerLog(`\n‚úÖ Envio em lote conclu√≠do!`);
            addMessengerLog(`   ‚úì Sucesso: ${successCount}`);
            addMessengerLog(`   ‚úó Falhas: ${failCount}`);
            
            sendBtn.disabled = false;
            sendBtn.textContent = 'üöÄ Iniciar Envio em Lote';
            document.getElementById('batch-current-file').textContent = 'Conclu√≠do!';
        }
        
        // ========== FUN√á√ïES DO EMOJI PICKER ==========
        
        function toggleEmojiPicker() {
            const picker = document.getElementById('emoji-picker');
            if (!picker) return;
            
            // Encontrar o bot√£o de emoji atrav√©s do container (como no toggleBannerEmojiPicker)
            const emojiContainer = picker.closest('.emoji-picker-container') || 
                                  picker.parentElement?.querySelector('.emoji-picker-container');
            const emojiBtn = emojiContainer?.querySelector('.emoji-btn') || 
                           picker.previousElementSibling;
            
            if (!emojiBtn) return;
            
            if (picker.classList.contains('active')) {
                // Fechar picker
                picker.classList.remove('active');
            } else {
                // Abrir picker e posicionar
                picker.classList.add('active');
                
                // Calcular posi√ß√£o baseada no bot√£o
                const btnRect = emojiBtn.getBoundingClientRect();
                const pickerWidth = 500; // largura do picker
                const pickerHeight = 500; // altura m√°xima do picker
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // Posicionar acima do bot√£o por padr√£o
                let top = btnRect.top - pickerHeight - 10;
                let left = btnRect.left;
                
                // Se n√£o cabe acima, posicionar abaixo
                if (top < 10) {
                    top = btnRect.bottom + 10;
                }
                
                // Se n√£o cabe √† direita, ajustar para a esquerda
                if (left + pickerWidth > viewportWidth - 10) {
                    left = viewportWidth - pickerWidth - 10;
                }
                
                // Garantir que n√£o saia da tela √† esquerda
                if (left < 10) {
                    left = 10;
                }
                
                // Garantir que n√£o saia da tela em baixo
                if (top + pickerHeight > viewportHeight - 10) {
                    top = viewportHeight - pickerHeight - 10;
                }
                
                picker.style.top = `${top}px`;
                picker.style.left = `${left}px`;
            }
        }
        
        function toggleBannerEmojiPicker() {
            const picker = document.getElementById('banner-emoji-picker');
            if (!picker) return;
            
            // Encontrar o bot√£o de emoji atrav√©s do container
            const emojiContainer = picker.closest('.emoji-picker-container') || 
                                  picker.parentElement?.querySelector('.emoji-picker-container');
            const emojiBtn = emojiContainer?.querySelector('.emoji-btn') || 
                           picker.previousElementSibling;
            
            if (picker.classList.contains('active')) {
                picker.classList.remove('active');
            } else {
                picker.classList.add('active');
                
                if (emojiBtn) {
                    const btnRect = emojiBtn.getBoundingClientRect();
                    const pickerWidth = 500;
                    const pickerHeight = 500;
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    let top = btnRect.top - pickerHeight - 10;
                    let left = btnRect.left;
                    
                    if (top < 10) {
                        top = btnRect.bottom + 10;
                    }
                    
                    if (left + pickerWidth > viewportWidth - 10) {
                        left = viewportWidth - pickerWidth - 10;
                    }
                    
                    if (left < 10) {
                        left = 10;
                    }
                    
                    if (top + pickerHeight > viewportHeight - 10) {
                        top = viewportHeight - pickerHeight - 10;
                    }
                    
                    picker.style.top = `${top}px`;
                    picker.style.left = `${left}px`;
                }
            }
        }
        
        function insertEmoji(emoji) {
            const textarea = document.getElementById('message-text');
            const picker = document.getElementById('emoji-picker');
            
            if (!textarea) return;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            
            textarea.value = before + emoji + after;
            textarea.focus();
            
            // Reposicionar cursor ap√≥s o emoji inserido
            const newCursorPos = start + emoji.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            updateMessengerPreview();
            
            // Fechar o picker ap√≥s inserir (opcional - pode remover se quiser que fique aberto)
            // if (picker) {
            //     picker.classList.remove('active');
            // }
        }
        
        function insertBannerEmoji(emoji) {
            const textarea = document.getElementById('banner-caption-text');
            const picker = document.getElementById('banner-emoji-picker');
            
            if (!textarea) return;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(end);
            
            textarea.value = before + emoji + after;
            textarea.focus();
            
            const newCursorPos = start + emoji.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
        }
        
        // ========== FUN√á√ïES DE FORMATA√á√ÉO PARA FRASE DE IMPULSIONAMENTO ==========
        function formatImpulsionamentoText(formatType) {
            const textDiv = document.getElementById('impulsionamento-text');
            if (!textDiv) return;
            
            document.execCommand(formatType, false, null);
            textDiv.focus();
            updateCSS();
        }
        
        function applyImpulsionamentoColor() {
            const textDiv = document.getElementById('impulsionamento-text');
            const colorInput = document.getElementById('impulsionamento-color');
            if (!textDiv || !colorInput) return;
            
            const selectedColor = colorInput.value;
            document.execCommand('foreColor', false, selectedColor);
            textDiv.focus();
            updateCSS();
        }
        
        function updateImpulsionamentoColorDisplay() {
            const colorInput = document.getElementById('impulsionamento-color');
            const displaySpan = document.getElementById('impulsionamento-color-val');
            if (colorInput && displaySpan) {
                displaySpan.textContent = colorInput.value.toUpperCase();
            }
        }
        
        function handleImpulsionamentoPaste(event) {
            event.preventDefault();
            const text = (event.clipboardData || window.clipboardData).getData('text');
            document.execCommand('insertText', false, text);
            updateCSS();
        }
        
        function getImpulsionamentoText() {
            const textDiv = document.getElementById('impulsionamento-text');
            if (!textDiv) return '';
            return textDiv.innerHTML || textDiv.innerText || '';
        }
        
        // ========== FUN√á√ïES GEN√âRICAS DE ARRASTAR E POSICIONAR ELEMENTOS ==========
        let dragMode = false;
        let isDragging = false;
        let draggedElement = null;
        let dragStartX = 0;
        let dragStartY = 0;
        let initialLeft = 0;
        let initialTop = 0;
        let initialBottom = 0;
        let initialRight = 0;
        let initialMarginTop = 0;
        let initialMarginLeft = 0;
        let initialElementX = 0; // Posi√ß√£o visual inicial do elemento (centro ou canto superior esquerdo)
        let initialElementY = 0; // Posi√ß√£o visual inicial do elemento
        let initialClickOffsetX = 0; // Offset do clique dentro do elemento
        let initialClickOffsetY = 0; // Offset do clique dentro do elemento
        
        // Mapeamento de elementos para seus controles (top/left ou margin-top/margin-left)
        const elementControlMap = {
            'preview-impulsionamento-text': {
                type: 'absolute',
                topControl: 'impulsionamento-top',
                leftControl: 'impulsionamento-left',
                bottomControl: 'impulsionamento-bottom',
                rightControl: 'impulsionamento-right'
            },
            'draggable-produto-nome': {
                type: 'relative',
                topControl: 'produto-nome-top',
                leftControl: 'produto-nome-left'
            },
            'draggable-produto-codigo': {
                type: 'relative',
                topControl: 'produto-codigo-top',
                leftControl: 'produto-codigo-left'
            },
            'draggable-preco-de': {
                type: 'relative',
                topControl: 'preco-de-top',
                leftControl: 'preco-de-left'
            },
            'draggable-preco-comercial': {
                type: 'relative',
                topControl: 'preco-comercial-top',
                leftControl: 'preco-comercial-left'
            },
            'draggable-preco-por': {
                type: 'relative',
                topControl: 'preco-por-top',
                leftControl: 'preco-por-left'
            },
            'draggable-preco-por-unidade': {
                type: 'relative',
                topControl: 'preco-por-unidade-top',
                leftControl: 'preco-por-unidade-left'
            },
            'draggable-preco-promocional': {
                type: 'relative',
                topControl: 'preco-promocional-top',
                leftControl: 'preco-promocional-left'
            },
            'draggable-base-produto': {
                type: 'absolute-bottom',
                bottomControl: 'base-produto-bottom',
                leftControl: 'base-produto-left'
            },
            'draggable-logo-superior': {
                type: 'absolute-right',
                topControl: 'logo-superior-top',
                rightControl: 'logo-superior-right'
            },
            'draggable-logo-ofertas': {
                type: 'absolute-center',
                topControl: 'logo-ofertas-top',
                leftControl: 'logo-ofertas-left'
            },
            'draggable-logo-inferior': {
                type: 'absolute-bottom',
                bottomControl: 'logo-inferior-bottom',
                leftControl: 'logo-inferior-left'
            },
            'draggable-call-action': {
                type: 'absolute-bottom',
                bottomControl: 'call-action-bottom',
                topControl: 'call-action-top',
                leftControl: 'call-action-left'
            },
            'draggable-bandeira': {
                type: 'absolute',
                topControl: 'bandeira-top',
                rightControl: 'bandeira-right',
                bottomControl: 'bandeira-bottom',
                leftControl: 'bandeira-left'
            }
        };
        
        function toggleImpulsionamentoDragMode() {
            dragMode = !dragMode;
            const btn = document.getElementById('toggle-impulsionamento-drag');
            
            if (dragMode) {
                btn.textContent = '‚úÖ Modo Ativo';
                btn.style.background = '#28a745';
            } else {
                btn.textContent = 'üéØ Posicionar no Preview';
                btn.style.background = '#17a2b8';
            }
            
            // Reconfigurar listeners
            setupUniversalDrag();
        }
        
        // Usar AbortController para gerenciar listeners
        let dragAbortController = null;
        
        function setupUniversalDrag() {
            // Aguardar o preview ser gerado - aumentar delay para garantir que elementos est√£o prontos
            setTimeout(() => {
                const previewWrapper = document.querySelector('.preview-wrapper');
                if (!previewWrapper) {
                    console.warn('[DRAG] Preview wrapper n√£o encontrado! Tentando novamente...');
                    // Tentar novamente ap√≥s mais tempo
                    setTimeout(setupUniversalDrag, 200);
                    return;
                }
                
                // Cancelar listeners antigos
                if (dragAbortController) {
                    dragAbortController.abort();
                }
                dragAbortController = new AbortController();
                const signal = dragAbortController.signal;
                
                // Verificar se elementos existem antes de adicionar listeners
                let elementsFound = 0;
                Object.keys(elementControlMap).forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        elementsFound++;
                    }
                });
                
                console.log(`[DRAG] setupUniversalDrag: ${elementsFound}/${Object.keys(elementControlMap).length} elementos encontrados, dragMode=${dragMode}`);
                
                // Adicionar listeners baseado no modo
                if (dragMode) {
                    previewWrapper.addEventListener('mousedown', handleMouseDown, { signal });
                    previewWrapper.addEventListener('mousemove', handleMouseMove, { signal });
                    previewWrapper.addEventListener('mouseup', handleMouseUp, { signal });
                    
                    // Ativar estilo draggable em todos os elementos mapeados
                    Object.keys(elementControlMap).forEach(elementId => {
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.style.cursor = 'move';
                            element.style.userSelect = 'none';
                            if (elementId === 'preview-impulsionamento-text') {
                                element.style.border = '2px dashed #007bff';
                            } else {
                                element.style.outline = '2px dashed #007bff';
                                element.style.outlineOffset = '2px';
                            }
                            console.log(`[DRAG] Estilo draggable aplicado em ${elementId}`);
                        } else {
                            console.warn(`[DRAG] Elemento ${elementId} n√£o encontrado no DOM!`);
                        }
                    });
                    
                    // Se nem todos os elementos foram encontrados, tentar novamente ap√≥s mais tempo
                    if (elementsFound < Object.keys(elementControlMap).length) {
                        console.warn(`[DRAG] Nem todos os elementos foram encontrados! Tentando novamente...`);
                        setTimeout(setupUniversalDrag, 200);
                    }
                } else {
                    // Remover estilo draggable
                    Object.keys(elementControlMap).forEach(elementId => {
                        const element = document.getElementById(elementId);
                        if (element) {
                            element.style.cursor = 'default';
                            element.style.userSelect = 'auto';
                            if (elementId === 'preview-impulsionamento-text') {
                                element.style.border = '2px dashed rgba(255,255,255,0.5)';
                            } else {
                                element.style.outline = 'none';
                            }
                        }
                    });
                }
            }, 150);
        }
        
        function handleMouseDown(e) {
            if (!dragMode) return;
            
            // Verificar se o clique foi em um elemento draggable
            let target = e.target;
            let elementConfig = null;
            let elementId = null;
            
            // Subir na √°rvore DOM para encontrar o elemento draggable
            while (target && target !== document.body) {
                elementId = target.id;
                if (elementId && elementControlMap[elementId]) {
                    elementConfig = elementControlMap[elementId];
                    draggedElement = target;
                    break;
                }
                target = target.parentElement;
            }
            
            if (!elementConfig || !draggedElement) return;
            
            e.preventDefault();
            e.stopPropagation();
            isDragging = true;
            
            // Para elementos dentro de containers, usar o container pai como refer√™ncia
            const previewWrapper = document.querySelector('.preview-wrapper');
            if (!previewWrapper) return;
            
            // Sempre usar preview-wrapper como container de refer√™ncia para elementos absolute
            let containerRect = previewWrapper.getBoundingClientRect();
            if (elementConfig.type !== 'absolute' && elementConfig.type !== 'absolute-bottom' && elementConfig.type !== 'absolute-right' && elementConfig.type !== 'absolute-center') {
                // Para elementos relative/margin, tentar encontrar container pai
                let parent = draggedElement.parentElement;
                while (parent && parent !== previewWrapper) {
                    const parentClass = parent.className;
                    if (parentClass && (parentClass.includes('produto-info') || parentClass.includes('precos') || parentClass.includes('preco-linhas'))) {
                        containerRect = parent.getBoundingClientRect();
                        break;
                    }
                    parent = parent.parentElement;
                }
            }
            
            // Obter posi√ß√£o visual atual do elemento relativa ao container
            const elementRect = draggedElement.getBoundingClientRect();
            const elementStartX = elementRect.left - containerRect.left;
            const elementStartY = elementRect.top - containerRect.top;
            
            // Calcular offset do clique dentro do elemento (para manter o offset durante o drag)
            const clickOffsetX = e.clientX - elementRect.left;
            const clickOffsetY = e.clientY - elementRect.top;
            
            // Salvar posi√ß√£o do clique relativa ao container (para calcular delta)
            dragStartX = e.clientX - containerRect.left;
            dragStartY = e.clientY - containerRect.top;
            
            // IMPORTANTE: Usar a POSI√á√ÉO VISUAL ATUAL como base, n√£o os valores dos controles
            // Isso garante que o elemento se move exatamente onde o mouse est√°
            initialElementX = elementStartX;
            initialElementY = elementStartY;
            
            // Salvar offset do clique para manter a posi√ß√£o relativa do mouse no elemento
            initialClickOffsetX = clickOffsetX;
            initialClickOffsetY = clickOffsetY;
            
            // Ler valores atuais dos controles apenas para refer√™ncia (n√£o usar como base)
            if (elementConfig.type === 'absolute') {
                const leftControl = elementConfig.leftControl ? document.getElementById(elementConfig.leftControl) : null;
                const topControl = elementConfig.topControl ? document.getElementById(elementConfig.topControl) : null;
                initialLeft = leftControl ? parseInt(leftControl.value) || 0 : 0;
                initialTop = topControl ? parseInt(topControl.value) || 0 : 0;
            } else if (elementConfig.type === 'absolute-bottom') {
                const leftControl = elementConfig.leftControl ? document.getElementById(elementConfig.leftControl) : null;
                const bottomControl = elementConfig.bottomControl ? document.getElementById(elementConfig.bottomControl) : null;
                initialLeft = leftControl ? parseInt(leftControl.value) || 0 : 0;
                initialBottom = bottomControl ? parseInt(bottomControl.value) || 0 : 0;
            } else if (elementConfig.type === 'absolute-right') {
                const topControl = elementConfig.topControl ? document.getElementById(elementConfig.topControl) : null;
                const rightControl = elementConfig.rightControl ? document.getElementById(elementConfig.rightControl) : null;
                initialTop = topControl ? parseInt(topControl.value) || 0 : 0;
                initialRight = rightControl ? parseInt(rightControl.value) || 0 : 0;
            } else if (elementConfig.type === 'absolute-center') {
                const topControl = elementConfig.topControl ? document.getElementById(elementConfig.topControl) : null;
                const leftControl = elementConfig.leftControl ? document.getElementById(elementConfig.leftControl) : null;
                initialTop = topControl ? parseInt(topControl.value) || 0 : 0;
                initialLeft = leftControl ? parseInt(leftControl.value) || 0 : 0;
            } else if (elementConfig.type === 'margin') {
                const leftControl = elementConfig.leftControl ? document.getElementById(elementConfig.leftControl) : null;
                const topControl = elementConfig.topControl ? document.getElementById(elementConfig.topControl) : null;
                initialMarginLeft = leftControl ? parseInt(leftControl.value) || 0 : 0;
                initialMarginTop = topControl ? parseInt(topControl.value) || 0 : 0;
            } else if (elementConfig.type === 'relative') {
                const leftControl = elementConfig.leftControl ? document.getElementById(elementConfig.leftControl) : null;
                const topControl = elementConfig.topControl ? document.getElementById(elementConfig.topControl) : null;
                initialLeft = leftControl ? parseInt(leftControl.value) || 0 : 0;
                initialTop = topControl ? parseInt(topControl.value) || 0 : 0;
            }
            
            console.log(`[DRAG] Iniciando drag de ${elementId}:`, {
                tipo: elementConfig.type,
                posicaoVisual: { x: elementStartX, y: elementStartY },
                clickOffset: { x: clickOffsetX, y: clickOffsetY },
                valoresControles: { left: initialLeft, top: initialTop, bottom: initialBottom, right: initialRight }
            });
            
            draggedElement.style.transition = 'none';
        }
        
        function handleMouseMove(e) {
            if (!isDragging || !dragMode || !draggedElement) return;
            e.preventDefault();
            
            const elementId = draggedElement.id;
            const elementConfig = elementControlMap[elementId];
            if (!elementConfig) return;
            
            // Encontrar o container de refer√™ncia
            const previewWrapper = document.querySelector('.preview-wrapper');
            if (!previewWrapper) return;
            
            let containerRect = previewWrapper.getBoundingClientRect();
            if (elementConfig.type !== 'absolute' && elementConfig.type !== 'absolute-bottom' && elementConfig.type !== 'absolute-right' && elementConfig.type !== 'absolute-center') {
                let parent = draggedElement.parentElement;
                while (parent && parent !== previewWrapper) {
                    const parentClass = parent.className;
                    if (parentClass && (parentClass.includes('produto-info') || parentClass.includes('precos') || parentClass.includes('preco-linhas'))) {
                        containerRect = parent.getBoundingClientRect();
                        break;
                    }
                    parent = parent.parentElement;
                }
            }
            
            // Posi√ß√£o atual do mouse relativa ao container
            const currentX = e.clientX - containerRect.left;
            const currentY = e.clientY - containerRect.top;
            
            // Calcular nova posi√ß√£o do elemento baseada na posi√ß√£o do mouse
            // O elemento deve seguir o mouse mantendo o offset inicial do clique
            const newElementX = currentX - initialClickOffsetX;
            const newElementY = currentY - initialClickOffsetY;
            
            // Aplicar posi√ß√£o diretamente baseada na posi√ß√£o visual
            if (elementConfig.type === 'absolute') {
                // Para absolute, usar left/top em pixels
                let newLeft = Math.max(0, Math.min(newElementX, containerRect.width));
                let newTop = Math.max(0, Math.min(newElementY, containerRect.height));
                
                draggedElement.style.position = 'absolute';
                draggedElement.style.left = newLeft + 'px';
                draggedElement.style.top = newTop + 'px';
                draggedElement.style.bottom = 'auto';
                draggedElement.style.right = 'auto';
                draggedElement.style.transform = 'none';
            } else if (elementConfig.type === 'absolute-bottom') {
                // Para absolute-bottom, usar bottom (invertido) e left (percentual)
                const containerHeight = containerRect.height;
                const newBottom = containerHeight - newElementY; // Converter top visual para bottom
                const newLeftPercent = (newElementX / containerRect.width) * 100;
                
                draggedElement.style.position = 'absolute';
                draggedElement.style.left = newLeftPercent + '%';
                draggedElement.style.bottom = newBottom + 'px';
                draggedElement.style.top = 'auto';
                draggedElement.style.right = 'auto';
                draggedElement.style.transform = 'translateX(-50%)';
            } else if (elementConfig.type === 'absolute-right') {
                // Para absolute-right, usar top e right (invertido)
                const containerWidth = containerRect.width;
                const newRight = containerWidth - newElementX; // Converter left visual para right
                let newTop = Math.max(0, Math.min(newElementY, containerRect.height));
                
                draggedElement.style.position = 'absolute';
                draggedElement.style.top = newTop + 'px';
                draggedElement.style.right = newRight + 'px';
                draggedElement.style.left = 'auto';
                draggedElement.style.bottom = 'auto';
                draggedElement.style.transform = 'none';
            } else if (elementConfig.type === 'absolute-center') {
                // Para absolute-center, usar top e left (percentual com transform)
                const newLeftPercent = (newElementX / containerRect.width) * 100;
                let newTop = Math.max(0, Math.min(newElementY, containerRect.height));
                
                draggedElement.style.position = 'absolute';
                draggedElement.style.left = newLeftPercent + '%';
                draggedElement.style.top = newTop + 'px';
                draggedElement.style.bottom = 'auto';
                draggedElement.style.right = 'auto';
                draggedElement.style.transform = 'translateX(-50%)';
            } else if (elementConfig.type === 'margin') {
                // Para margin, calcular delta e aplicar como margin
                const deltaX = newElementX - initialElementX;
                const deltaY = newElementY - initialElementY;
                const newMarginLeft = initialMarginLeft + deltaX;
                const newMarginTop = initialMarginTop + deltaY;
                
                draggedElement.style.marginLeft = newMarginLeft + 'px';
                draggedElement.style.marginTop = newMarginTop + 'px';
                draggedElement.style.position = '';
                draggedElement.style.left = '';
                draggedElement.style.top = '';
            } else if (elementConfig.type === 'relative') {
                // Para relative, calcular delta e aplicar como left/top
                const deltaX = newElementX - initialElementX;
                const deltaY = newElementY - initialElementY;
                const newLeft = initialLeft + deltaX;
                const newTop = initialTop + deltaY;
                
                draggedElement.style.position = 'relative';
                draggedElement.style.left = newLeft + 'px';
                draggedElement.style.top = newTop + 'px';
            }
        }
        
        function handleMouseUp(e) {
            if (!isDragging || !draggedElement) return;
            
            const elementId = draggedElement.id;
            const elementConfig = elementControlMap[elementId];
            if (!elementConfig) {
                isDragging = false;
                draggedElement = null;
                return;
            }
            
            draggedElement.style.transition = '';
            
            // Encontrar o container de refer√™ncia
            const previewWrapper = document.querySelector('.preview-wrapper');
            if (!previewWrapper) return;
            
            let containerRect = previewWrapper.getBoundingClientRect();
            if (elementConfig.type !== 'absolute' && elementConfig.type !== 'absolute-bottom' && elementConfig.type !== 'absolute-right' && elementConfig.type !== 'absolute-center') {
                let parent = draggedElement.parentElement;
                while (parent && parent !== previewWrapper) {
                    const parentClass = parent.className;
                    if (parentClass && (parentClass.includes('produto-info') || parentClass.includes('precos') || parentClass.includes('preco-linhas'))) {
                        containerRect = parent.getBoundingClientRect();
                        break;
                    }
                    parent = parent.parentElement;
                }
            }
            
            // Obter posi√ß√£o visual final do elemento (centro do elemento para elementos com transform)
            const elementRect = draggedElement.getBoundingClientRect();
            const elementCenterX = elementRect.left + elementRect.width / 2 - containerRect.left;
            const elementTopY = elementRect.top - containerRect.top;
            const elementBottomY = containerRect.height - (elementRect.bottom - containerRect.top);
            
            let leftPx, topPx, bottomPx, rightPx;
            
            // Converter posi√ß√£o visual para valores dos controles
            if (elementConfig.type === 'absolute') {
                // Para absolute, usar left/top em pixels (canto superior esquerdo)
                leftPx = Math.round(elementRect.left - containerRect.left);
                topPx = Math.round(elementTopY);
            } else if (elementConfig.type === 'absolute-bottom') {
                // Para absolute-bottom, usar bottom (px) e left (percentual do centro)
                bottomPx = Math.round(elementBottomY);
                leftPx = Math.round((elementCenterX / containerRect.width) * 100);
            } else if (elementConfig.type === 'absolute-right') {
                // Para absolute-right, usar top (px) e right (px)
                topPx = Math.round(elementTopY);
                // right √© a dist√¢ncia do canto direito do elemento at√© o canto direito do container
                rightPx = Math.round(containerRect.width - (elementRect.right - containerRect.left));
            } else if (elementConfig.type === 'absolute-center') {
                // Para absolute-center, usar top (px) e left (percentual do centro)
                topPx = Math.round(elementTopY);
                leftPx = Math.round((elementCenterX / containerRect.width) * 100);
            } else if (elementConfig.type === 'margin') {
                // Para margin, ler valores inline aplicados durante drag
                const inlineMarginLeft = draggedElement.style.marginLeft;
                const inlineMarginTop = draggedElement.style.marginTop;
                leftPx = inlineMarginLeft ? Math.round(parseFloat(inlineMarginLeft)) : 0;
                topPx = inlineMarginTop ? Math.round(parseFloat(inlineMarginTop)) : 0;
            } else if (elementConfig.type === 'relative') {
                // Para relative, ler valores inline aplicados durante drag
                const inlineLeft = draggedElement.style.left;
                const inlineTop = draggedElement.style.top;
                leftPx = inlineLeft ? Math.round(parseFloat(inlineLeft)) : 0;
                topPx = inlineTop ? Math.round(parseFloat(inlineTop)) : 0;
            }
            
            console.log(`[DRAG] Soltando elemento ${elementId}:`, {
                tipo: elementConfig.type,
                leftPx: leftPx !== undefined ? leftPx : undefined,
                topPx: topPx !== undefined ? topPx : undefined,
                bottomPx: bottomPx !== undefined ? bottomPx : undefined,
                rightPx: rightPx !== undefined ? rightPx : undefined,
                posicaoVisual: { x: elementCenterX, y: elementTopY }
            });
            
            // Atualizar controles ANTES de regenerar o preview
            // IMPORTANTE: Salvar valores diretamente e garantir que foram salvos
            
            // Atualizar leftControl (se existir)
            if (elementConfig.leftControl && leftPx !== undefined) {
                const leftControl = document.getElementById(elementConfig.leftControl);
                const leftVal = document.getElementById(elementConfig.leftControl + '-val');
                if (leftControl) {
                    leftControl.value = leftPx;
                    leftControl.dispatchEvent(new Event('input', { bubbles: true }));
                    if (leftVal) {
                        // Verificar se √© percentual
                        const percentLeftIds = ['produto-imagem-left', 'base-produto-left', 'call-action-left', 'logo-inferior-left', 'logo-ofertas-left', 'footer-left'];
                        if (percentLeftIds.includes(elementConfig.leftControl)) {
                            leftVal.textContent = leftPx + '%';
                        } else {
                            // Verificar se precisa adicionar "px" (para controles de posi√ß√£o)
                            const positionLeftIds = ['preco-de-left', 'preco-por-left', 'preco-por-unidade-left', 'preco-comercial-left', 'preco-promocional-left', 'produto-nome-left', 'produto-codigo-left'];
                            if (positionLeftIds.includes(elementConfig.leftControl)) {
                                leftVal.textContent = leftPx + 'px';
                            } else {
                                leftVal.textContent = leftPx;
                            }
                        }
                    }
                }
            }
            
            // Atualizar topControl (se existir)
            if (elementConfig.topControl && topPx !== undefined) {
                const topControl = document.getElementById(elementConfig.topControl);
                const topVal = document.getElementById(elementConfig.topControl + '-val');
                if (topControl) {
                    topControl.value = topPx;
                    topControl.dispatchEvent(new Event('input', { bubbles: true }));
                    if (topVal) {
                        // Verificar se precisa adicionar "px" (para controles de posi√ß√£o)
                        const positionTopIds = ['preco-de-top', 'preco-por-top', 'preco-por-unidade-top', 'preco-comercial-top', 'preco-promocional-top', 'produto-nome-top', 'produto-codigo-top'];
                        if (positionTopIds.includes(elementConfig.topControl)) {
                            topVal.textContent = topPx + 'px';
                        } else {
                            topVal.textContent = topPx;
                        }
                    }
                }
            }
            
            // Atualizar bottomControl (se existir)
            if (elementConfig.bottomControl && bottomPx !== undefined) {
                const bottomControl = document.getElementById(elementConfig.bottomControl);
                const bottomVal = document.getElementById(elementConfig.bottomControl + '-val');
                if (bottomControl) {
                    bottomControl.value = bottomPx;
                    bottomControl.dispatchEvent(new Event('input', { bubbles: true }));
                    if (bottomVal) bottomVal.textContent = bottomPx;
                }
            }
            
            // Atualizar rightControl (se existir)
            if (elementConfig.rightControl && rightPx !== undefined) {
                const rightControl = document.getElementById(elementConfig.rightControl);
                const rightVal = document.getElementById(elementConfig.rightControl + '-val');
                if (rightControl) {
                    rightControl.value = rightPx;
                    rightControl.dispatchEvent(new Event('input', { bubbles: true }));
                    if (rightVal) rightVal.textContent = rightPx;
                }
            }
            
            // Limpar controles n√£o usados
            if (elementConfig.type === 'absolute') {
                if (elementConfig.bottomControl) {
                    const bottomControl = document.getElementById(elementConfig.bottomControl);
                    if (bottomControl) bottomControl.value = 0;
                }
                if (elementConfig.rightControl) {
                    const rightControl = document.getElementById(elementConfig.rightControl);
                    if (rightControl) rightControl.value = 0;
                }
            } else if (elementConfig.type === 'absolute-right') {
                if (elementConfig.leftControl) {
                    const leftControl = document.getElementById(elementConfig.leftControl);
                    if (leftControl) leftControl.value = 0;
                }
                if (elementConfig.bottomControl) {
                    const bottomControl = document.getElementById(elementConfig.bottomControl);
                    if (bottomControl) bottomControl.value = 0;
                }
            }
            
            // Verificar valores finais antes de regenerar
            const finalLeftControl = elementConfig.leftControl ? document.getElementById(elementConfig.leftControl) : null;
            const finalTopControl = elementConfig.topControl ? document.getElementById(elementConfig.topControl) : null;
            const finalBottomControl = elementConfig.bottomControl ? document.getElementById(elementConfig.bottomControl) : null;
            const finalRightControl = elementConfig.rightControl ? document.getElementById(elementConfig.rightControl) : null;
            const finalLeftValue = finalLeftControl ? parseInt(finalLeftControl.value) : null;
            const finalTopValue = finalTopControl ? parseInt(finalTopControl.value) : null;
            const finalBottomValue = finalBottomControl ? parseInt(finalBottomControl.value) : null;
            const finalRightValue = finalRightControl ? parseInt(finalRightControl.value) : null;
            
            console.log(`[DRAG] Valores finais salvos nos controles:`, {
                leftControl: elementConfig.leftControl,
                topControl: elementConfig.topControl,
                bottomControl: elementConfig.bottomControl,
                rightControl: elementConfig.rightControl,
                leftValue: finalLeftValue,
                topValue: finalTopValue,
                bottomValue: finalBottomValue,
                rightValue: finalRightValue,
                esperadoLeft: leftPx !== undefined ? leftPx : undefined,
                esperadoTop: topPx !== undefined ? topPx : undefined,
                esperadoBottom: bottomPx !== undefined ? bottomPx : undefined,
                esperadoRight: rightPx !== undefined ? rightPx : undefined
            });
            
            // Marcar que o arraste terminou, mas MANTER o modo drag ATIVO
            // IMPORTANTE: O modo s√≥ deve ser desativado quando o bot√£o for clicado explicitamente
            isDragging = false;
            draggedElement = null;
            
            // Garantir que o modo drag permanece ativo
            if (!dragMode) {
                console.warn('[DRAG] Modo drag estava desativado! Reativando para manter continuidade...');
                dragMode = true;
            }
            
            // Usar setTimeout para garantir que o DOM foi atualizado
                setTimeout(() => {
                // Verificar novamente os valores antes de regenerar
                const checkLeftControl = elementConfig.leftControl ? document.getElementById(elementConfig.leftControl) : null;
                const checkTopControl = elementConfig.topControl ? document.getElementById(elementConfig.topControl) : null;
                const checkBottomControl = elementConfig.bottomControl ? document.getElementById(elementConfig.bottomControl) : null;
                const checkRightControl = elementConfig.rightControl ? document.getElementById(elementConfig.rightControl) : null;
                
                if (checkLeftControl && leftPx !== undefined && parseInt(checkLeftControl.value) !== leftPx) {
                    console.error(`[DRAG] ERRO: Valor left perdido antes de regenerar! Esperado: ${leftPx}, Encontrado: ${checkLeftControl.value}`);
                    checkLeftControl.value = leftPx;
                }
                if (checkTopControl && topPx !== undefined && parseInt(checkTopControl.value) !== topPx) {
                    console.error(`[DRAG] ERRO: Valor top perdido antes de regenerar! Esperado: ${topPx}, Encontrado: ${checkTopControl.value}`);
                    checkTopControl.value = topPx;
                }
                if (checkBottomControl && bottomPx !== undefined && parseInt(checkBottomControl.value) !== bottomPx) {
                    console.error(`[DRAG] ERRO: Valor bottom perdido antes de regenerar! Esperado: ${bottomPx}, Encontrado: ${checkBottomControl.value}`);
                    checkBottomControl.value = bottomPx;
                }
                if (checkRightControl && rightPx !== undefined && parseInt(checkRightControl.value) !== rightPx) {
                    console.error(`[DRAG] ERRO: Valor right perdido antes de regenerar! Esperado: ${rightPx}, Encontrado: ${checkRightControl.value}`);
                    checkRightControl.value = rightPx;
                }
                
                // Atualizar o CSS/preview - isso j√° vai preservar e reaplicar o modo drag
                // O updateCSS() preserva o estado do dragMode automaticamente
                updateCSS();
                
                // Verificar ap√≥s um delay se os valores foram aplicados e o modo est√° ativo
                setTimeout(() => {
                    // Verificar se os valores foram aplicados corretamente no preview regenerado
                    const regeneratedElement = document.getElementById(elementId);
                    if (regeneratedElement) {
                        const computedAfter = window.getComputedStyle(regeneratedElement);
                        let appliedLeft = null;
                        let appliedTop = null;
                        
                        if (elementConfig.type === 'margin') {
                            appliedLeft = parseFloat(computedAfter.marginLeft) || 0;
                            appliedTop = parseFloat(computedAfter.marginTop) || 0;
                        } else if (elementConfig.type === 'relative') {
                            appliedLeft = parseFloat(computedAfter.left) || 0;
                            appliedTop = parseFloat(computedAfter.top) || 0;
                        } else if (elementConfig.type === 'absolute') {
                            appliedLeft = parseFloat(computedAfter.left) || 0;
                            appliedTop = parseFloat(computedAfter.top) || 0;
                        } else if (elementConfig.type === 'absolute-bottom') {
                            // Para absolute-bottom, verificar bottom e left
                            const computedBottom = parseFloat(computedAfter.bottom) || 0;
                            appliedTop = -computedBottom; // Inverter para compara√ß√£o
                            // left √© percentual, converter para valor absoluto aproximado
                            const leftPercent = parseFloat(computedAfter.left) || 0;
                            appliedLeft = leftPercent; // J√° √© percentual
                        }
                        
                        const expectedValue = elementConfig.type === 'absolute-bottom' ? bottomPx : topPx;
                        const appliedValue = elementConfig.type === 'absolute-bottom' ? -appliedTop : appliedTop;
                        const valoresCorretos = elementConfig.type === 'absolute-bottom' 
                            ? (Math.abs(appliedLeft - leftPx) < 1 && Math.abs(appliedValue - bottomPx) < 1)
                            : (appliedLeft === leftPx && appliedTop === topPx);
                        
                        console.log(`[DRAG] Verifica√ß√£o ap√≥s regenera√ß√£o:`, {
                            elemento: elementId,
                            tipo: elementConfig.type,
                            esperadoLeft: leftPx,
                            esperadoTop: topPx !== undefined ? topPx : undefined,
                            esperadoBottom: bottomPx !== undefined ? bottomPx : undefined,
                            aplicadoLeft: appliedLeft,
                            aplicadoTop: appliedTop,
                            aplicadoBottom: elementConfig.type === 'absolute-bottom' ? appliedValue : undefined,
                            valoresCorretos: valoresCorretos,
                            dragModeAtivo: dragMode
                        });
                        
                        if (!valoresCorretos) {
                            console.error(`[DRAG] PROBLEMA DETECTADO: Valores n√£o foram aplicados corretamente!`, {
                                tipo: elementConfig.type,
                                esperado: elementConfig.type === 'absolute-bottom' 
                                    ? { left: leftPx, bottom: bottomPx }
                                    : { left: leftPx, top: topPx },
                                aplicado: elementConfig.type === 'absolute-bottom'
                                    ? { left: appliedLeft, bottom: appliedValue }
                                    : { left: appliedLeft, top: appliedTop },
                                controleLeft: finalLeftValue,
                                controleTop: finalTopValue,
                                controleBottom: finalBottomValue
                            });
                        }
                    }
                    
                    // GARANTIR que o modo est√° ativo ap√≥s regenera√ß√£o
                    // O modo NUNCA deve ser desativado automaticamente, apenas pelo bot√£o
                    if (!dragMode) {
                        console.warn('[DRAG] Modo drag foi desativado inesperadamente ap√≥s regenera√ß√£o! Reativando...');
                        dragMode = true;
                        // Atualizar bot√£o tamb√©m
                        const btn = document.getElementById('toggle-impulsionamento-drag');
                        if (btn) {
                            btn.textContent = '‚úÖ Modo Ativo';
                            btn.style.background = '#28a745';
                        }
                        setupUniversalDrag();
                    } else {
                        // Se o modo est√° ativo, garantir que os listeners est√£o configurados
                        // Usar um delay maior para garantir que o preview foi completamente regenerado
                        console.log('[DRAG] Reaplicando setupUniversalDrag ap√≥s regenera√ß√£o...');
                        setupUniversalDrag();
                    }
                }, 400);
            }, 50);
        }
        
        function initializeEmojiPicker() {
            // Faces & Emo√ß√µes (emojis mais populares)
            const facesEmojis = [
                'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 
                'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 
                'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 
                'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 
                'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 
                'ü§ß', 'ü•µ', 'ü•∂', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê', 
                'üòï', 'üòü', 'üôÅ', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 
                'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üòû', 'üòì', 
                'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üòà', 'üëø', 'üíÄ', 
                '‚ò†Ô∏è', 'üí©', 'ü§°', 'üëπ', 'üë∫', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ', 'üò∫', 
                'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ'
            ];
            
            // Gestos & Pessoas (mais populares)
            const peopleEmojis = [
                'üëã', 'ü§ö', 'üñê', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 
                'ü§ü', 'ü§ò', 'ü§ô', 'üëà', 'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 
                'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 
                'üôè', '‚úçÔ∏è', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ', 
                'üë∂', 'üëß', 'üßí', 'üë¶', 'üë©', 'üßë', 'üë®', 'üëµ', 'üßì', 'üë¥', 
                'üë∏', 'ü§¥', 'üë∞', 'ü§µ', 'üëº', 'üéÖ', 'ü§∂', 'üßô', 'üßö', 'üßõ', 
                'üßú', 'üßù', 'üßû', 'üßü', 'üíÜ', 'üíá', 'üö∂', 'üèÉ', 'üíÉ', 'üï∫', 
                'üï¥', 'üëØ', 'üßò', 'üßó', 'ü§∫', 'üèá', '‚õ∑Ô∏è', 'üèÇ', 'üèåÔ∏è', 'üèÑ', 
                'üö£', 'üèä', '‚õπÔ∏è', 'üèãÔ∏è', 'üö¥', 'üöµ', 'ü§∏', 'ü§º', 'ü§Ω', 'ü§æ', 
                'ü§π', 'üë≠', 'üë´', 'üë¨', 'üíè', 'üíë', 'üë™', 'üë®‚Äçüë©‚Äçüëß', 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶'
            ];
            
            // Objetos & S√≠mbolos (mais populares)
            const objectsEmojis = [
                '‚åö', 'üì±', 'üì≤', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üïπÔ∏è', 
                'üóúÔ∏è', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩÔ∏è', 
                'üéûÔ∏è', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéôÔ∏è', 'üéöÔ∏è', 'üéõÔ∏è', 
                '‚è±Ô∏è', '‚è≤Ô∏è', '‚è∞', 'üï∞Ô∏è', '‚åõ', '‚è≥', 'üì°', 'üîã', 'üîå', 'üí°', 
                'üî¶', 'üïØÔ∏è', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'üí∞', 
                'üí≥', 'üíé', '‚öñÔ∏è', 'üß∞', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'üî©', 
                '‚öôÔ∏è', 'üß±', '‚õìÔ∏è', 'üß≤', 'üî´', 'üí£', 'üß®', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 
                'üõ°Ô∏è', 'üö¨', '‚ö∞Ô∏è', '‚ö±Ô∏è', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öóÔ∏è', 
                'üî≠', 'üî¨', 'üï≥Ô∏è', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'ü©∏', 'üß¨', 'ü¶†', 
                'üß´', 'üß™', 'üå°Ô∏è', 'üßπ', 'üß∫', 'üßª', 'üöΩ', 'üöø', 'üõÅ', 'üõÄ', 
                'üßº', 'üßΩ', 'üß¥', 'üõéÔ∏è', 'üîë', 'üóùÔ∏è', 'üö™', 'ü™ë', 'üõãÔ∏è', 'üõèÔ∏è', 
                'üõå', 'üß∏', 'üñºÔ∏è', 'üõçÔ∏è', 'üõí', 'üéÅ', 'üéà', 'üéè', 'üéÄ', 'ü™Ñ', 
                'ü™Ö', 'ü™Ü', 'üïπÔ∏è', 'üß©', 'ü™Ä', 'ü™Å', 'üéÆ', 'üé∞', 'üé≤', 'üß∏', 
                'üÉè', 'üÄÑ', 'üé¥', 'üé≠', 'üñºÔ∏è', 'üé®', 'üßµ', 'üß∂', 'üëì', 'üï∂Ô∏è', 
                'ü•Ω', 'ü•º', 'ü¶∫', 'üëî', 'üëï', 'üëñ', 'üß£', 'üß§', 'üß•', 'üß¶', 
                'üëó', 'üëò', 'ü•ª', 'ü©±', 'ü©≤', 'ü©≥', 'üëô', 'üëö', 'üëõ', 'üëú', 
                'üëù', 'üõçÔ∏è', 'üéí', 'üëû', 'üëü', 'ü•æ', 'ü•ø', 'üë†', 'üë°', 'ü©∞', 
                'üë¢', 'üëë', 'üëí', 'üé©', 'üéì', 'üß¢', '‚õëÔ∏è', 'üìø', 'üíÑ', 'üíç', 
                'üíé', 'üîá', 'üîà', 'üîâ', 'üîä', 'üì¢', 'üì£', 'üìØ', 'üîî', 'üîï', 
                'üéº', 'üéµ', 'üé∂', 'üéôÔ∏è', 'üéöÔ∏è', 'üéõÔ∏è', 'üé§', 'üéß', 'üìª', 'üé∑', 
                'üé∫', 'üé∏', 'ü™ï', 'üéª', 'üéπ', 'ü•Å', 'üé≤', 'üéØ', 'üé≥', 'üéÆ', 
                'üé∞', 'üß©'
            ];
            
            // Natureza & Comida (mais populares)
            const natureEmojis = [
                'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 
                'ü¶Å', 'üêÆ', 'üê∑', 'üêΩ', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 
                'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 
                'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 
                'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 
                'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 
                'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 
                'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'ü¶¨', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 
                'üêè', 'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 
                'üêì', 'ü¶É', 'ü¶§', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶©', 'üïäÔ∏è', 'üêá', 'ü¶ù', 
                'ü¶®', 'ü¶°', 'ü¶´', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêøÔ∏è', 'ü¶î', 'üå≤', 
                'üå≥', 'üå¥', 'üåµ', 'üå∂Ô∏è', 'üåæ', 'üåø', '‚òòÔ∏è', 'üçÄ', 'üçÅ', 'üçÇ', 
                'üçÉ', 'üçá', 'üçà', 'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'ü•≠', 'üçé', 
                'üçè', 'üçê', 'üçë', 'üçí', 'üçì', 'ü´ê', 'ü•ù', 'üçÖ', 'ü´í', 'ü••', 
                'ü•ë', 'üçÜ', 'ü•î', 'ü•ï', 'üåΩ', 'üå∂Ô∏è', 'ü´ë', 'ü•í', 'ü•¨', 'ü•¶', 
                'üßÑ', 'üßÖ', 'üçÑ', 'ü•ú', 'üå∞', 'üçû', 'ü•ê', 'ü•ñ', 'ü´ì', 'ü•®', 
                'ü•Ø', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 
                'üçü', 'üçï', 'ü´î', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ', 'üåØ', 'ü´î', 'ü•ó', 
                'ü•ò', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'ü¶™', 
                'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç¢', 'üç°', 'üçß', 
                'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 
                'üçø', 'üç©', 'üç™', 'üå∞', 'ü•ú', 'üçØ', 'ü•õ', 'üçº', 'ü´ñ', '‚òïÔ∏è', 
                'üçµ', 'üßÉ', 'ü•§', 'üßã', 'üç∂', 'üç∫', 'üçª', 'ü•Ç', 'üç∑', 'ü•É', 
                'üç∏', 'üçπ', 'üßâ', 'üçæ', 'üßä'
            ];
            
            // Atividades & Lugares (mais populares)
            const activitiesEmojis = [
                '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 
                'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥', 'ü™Å', 
                'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 
                'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è‚Äç‚ôÄÔ∏è', 'üèãÔ∏è', 'ü§º‚Äç‚ôÄÔ∏è', 'ü§º', 'ü§∏‚Äç‚ôÄÔ∏è', 'ü§∏', 
                '‚õπÔ∏è‚Äç‚ôÄÔ∏è', '‚õπÔ∏è', 'ü§∫', 'ü§æ‚Äç‚ôÄÔ∏è', 'ü§æ', 'üèåÔ∏è‚Äç‚ôÄÔ∏è', 'üèåÔ∏è', 'üèá', 'üßò‚Äç‚ôÄÔ∏è', 'üßò', 
                'üèÑ‚Äç‚ôÄÔ∏è', 'üèÑ', 'üèä‚Äç‚ôÄÔ∏è', 'üèä', 'ü§Ω‚Äç‚ôÄÔ∏è', 'ü§Ω', 'üö£‚Äç‚ôÄÔ∏è', 'üö£', 'üßó‚Äç‚ôÄÔ∏è', 'üßó', 
                'üöµ‚Äç‚ôÄÔ∏è', 'üöµ', 'üö¥‚Äç‚ôÄÔ∏è', 'üö¥', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', 
                'üèµÔ∏è', 'üéóÔ∏è', 'üé´', 'üéüÔ∏è', 'üé™', 'ü§π‚Äç‚ôÄÔ∏è', 'ü§π', 'üé≠', 'ü©∞', 'üé®', 
                'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'ü™ò', 'üé∑', 'üé∫', 'ü™ó', 
                'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è', 'üéØ', 'üé≥', 'üéÆ', 'üé∞', 'üß©', 
                'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 
                'üõª', 'üöö', 'üöõ', 'üöú', 'ü¶Ø', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõµ', 
                'üèçÔ∏è', 'üõ∫', 'üö®', 'üöî', 'üöç', 'üöò', 'üöñ', 'üö°', 'üö†', 'üöü', 
                'üöÉ', 'üöã', 'üöû', 'üöù', 'üöÑ', 'üöÖ', 'üöà', 'üöÇ', 'üöÜ', 'üöá', 
                'üöä', 'üöâ', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'üí∫', 'üöÅ', 'üöü', 'üö†', 
                'üö°', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üõéÔ∏è', 'üß≥', '‚åõ', '‚è≥', '‚åö', '‚è∞', 
                '‚è±Ô∏è', '‚è≤Ô∏è', 'üï∞Ô∏è', 'üåç', 'üåé', 'üåè', 'üåê', 'üó∫Ô∏è', 'üß≠', 'üèîÔ∏è', 
                '‚õ∞Ô∏è', 'üåã', 'üóª', 'üèïÔ∏è', 'üèñÔ∏è', 'üèúÔ∏è', 'üèùÔ∏è', 'üèûÔ∏è', 'üèüÔ∏è', 'üèõÔ∏è', 
                'üèóÔ∏è', 'üß±', 'üèòÔ∏è', 'üèöÔ∏è', 'üè†', 'üè°', 'üè¢', 'üè£', 'üè§', 'üè•', 
                'üè¶', 'üè®', 'üè©', 'üè™', 'üè´', 'üè¨', 'üè≠', 'üèØ', 'üè∞', 'üóº', 
                'üóΩ', '‚õ™', 'üïå', 'üõï', 'üïç', '‚õ©Ô∏è', 'üïã', '‚õ≤', '‚õ∫', 'üåÅ', 
                'üåÉ', 'üèôÔ∏è', 'üåÑ', 'üåÖ', 'üåÜ', 'üåá', 'üåâ', '‚ô®Ô∏è', 'üé†', 'üé°', 
                'üé¢', 'üíà', 'üé™'
            ];
            
            // S√≠mbolos & Sinais (mais populares)
            const symbolsEmojis = [
                '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', 
                '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', 
                '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', 
                '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', 
                '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 
                'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 
                'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', 
                '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 
                'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùì', '‚ùï', '‚ùî', '‚ÄºÔ∏è', 
                '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', 
                '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 
                'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 
                'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', 
                '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üî¢', 'üîü', '#Ô∏è‚É£', '*Ô∏è‚É£', '0Ô∏è‚É£', '1Ô∏è‚É£', 
                '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü', 
                '¬©Ô∏è', '¬ÆÔ∏è', '‚Ñ¢Ô∏è', '‚úñÔ∏è', '‚ûï', '‚ûñ', '‚ûó', '‚ôæÔ∏è', 'üí±', 'üí≤', 
                '‚úÇÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', 
                '‚èÆÔ∏è', '‚è©', '‚è™', '‚è´', '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', 
                '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è', '‚ÜîÔ∏è', '‚Ü™Ô∏è', '‚Ü©Ô∏è', 
                '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÉ', 'üîÑ', 'üîô', 'üîö', 'üîõ', 'üîú', 'üîù'
            ];
            
            // Popular emojis nas categorias (Messenger)
            populateEmojiCategory('emoji-faces', facesEmojis, insertEmoji);
            populateEmojiCategory('emoji-people', peopleEmojis, insertEmoji);
            populateEmojiCategory('emoji-objects', objectsEmojis, insertEmoji);
            populateEmojiCategory('emoji-nature', natureEmojis, insertEmoji);
            populateEmojiCategory('emoji-activities', activitiesEmojis, insertEmoji);
            populateEmojiCategory('emoji-symbols', symbolsEmojis, insertEmoji);
            
            // Popular emojis nas categorias (Banner)
            populateEmojiCategory('banner-emoji-faces', facesEmojis, insertBannerEmoji);
            populateEmojiCategory('banner-emoji-people', peopleEmojis, insertBannerEmoji);
            populateEmojiCategory('banner-emoji-objects', objectsEmojis, insertBannerEmoji);
            populateEmojiCategory('banner-emoji-nature', natureEmojis, insertBannerEmoji);
            populateEmojiCategory('banner-emoji-activities', activitiesEmojis, insertBannerEmoji);
            populateEmojiCategory('banner-emoji-symbols', symbolsEmojis, insertBannerEmoji);
        }
        
        function populateEmojiCategory(categoryId, emojis, insertFunction) {
            const container = document.getElementById(categoryId);
            if (!container) return;
            
            container.innerHTML = '';
            
            emojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.title = emoji;
                emojiItem.onclick = () => insertFunction(emoji);
                container.appendChild(emojiItem);
            });
        }
        
        // Fechar picker quando clicar fora (ap√≥s carregar a p√°gina)
        function setupEmojiPickerClose() {
            document.addEventListener('click', (event) => {
                const picker = document.getElementById('emoji-picker');
                if (picker && picker.classList.contains('active')) {
                    // Encontrar o bot√£o atrav√©s do container (como no toggleEmojiPicker)
                    const emojiContainer = picker.closest('.emoji-picker-container') || 
                                          picker.parentElement?.querySelector('.emoji-picker-container');
                    const emojiBtn = emojiContainer?.querySelector('.emoji-btn') || 
                                   picker.previousElementSibling;
                    
                    // Se o clique foi fora do picker e do bot√£o, fechar o picker
                    if (!picker.contains(event.target) && (!emojiBtn || !emojiBtn.contains(event.target))) {
                        picker.classList.remove('active');
                    }
                }
                
                const bannerPicker = document.getElementById('banner-emoji-picker');
                if (bannerPicker && bannerPicker.classList.contains('active')) {
                    const bannerEmojiContainer = bannerPicker?.closest('.emoji-picker-container');
                    const bannerEmojiBtn = bannerEmojiContainer?.querySelector('.emoji-btn');
                    
                    if (!bannerPicker.contains(event.target) && (!bannerEmojiBtn || !bannerEmojiBtn.contains(event.target))) {
                        bannerPicker.classList.remove('active');
                    }
                }
            });
        }
        
        // ============================================
        // FUN√á√ïES GMAIL MONITOR
        // ============================================
        const GMAIL_API_URL = getGmailUrl();
        console.log('üìß Gmail API URL:', GMAIL_API_URL);
        let gmailMonitorInterval = null;
        
        // Fun√ß√µes de extra√ß√£o de e-mail (JavaScript)
        function extractEmailInfo(emailBody) {
            const result = {
                vendedor_nome_completo: '',
                vendedor_primeiro_nome: '',
                name: '',
                code: '',
                phone: '',
                empresa: '',
                cnpj: '',
                telefone_formatado: '',
                telefone_vendedor: ''
            };
            
            // 1. Extrair nome do vendedor
            const vendedorMatch = emailBody.match(/Prezado,\s*([A-Z√Å√â√ç√ì√ö√á√É√ï√Ç√ä√î\s]+)/i);
            if (vendedorMatch) {
                const nomeCompleto = vendedorMatch[1].trim();
                result.vendedor_nome_completo = nomeCompleto;
                result.vendedor_primeiro_nome = nomeCompleto.split(' ')[0] || nomeCompleto;
            }
            
            // 2. Extrair "name" (Patiocanoagrill)
            const nameMatch = emailBody.match(/O\(A\)\s+([A-Za-z0-9\s]+?)\s+Cliente:/i);
            if (nameMatch) {
                result.name = nameMatch[1].trim();
            }
            
            // 3. Extrair "empresa" (PATIO GRILL)
            const empresaMatch = emailBody.match(/Cliente:\s*([^-]+?)\s*-\s*CNPJ:/i);
            if (empresaMatch) {
                result.empresa = empresaMatch[1].trim();
            }
            
            // 4. Extrair CNPJ
            const cnpjMatch = emailBody.match(/CNPJ:\s*([0-9.\/-]+)/);
            if (cnpjMatch) {
                result.cnpj = cnpjMatch[1].trim();
            }
            
            // 5. Extrair "code" (c√≥digo do cliente)
            const codeMatch = emailBody.match(/Cod\s+Cliente:\s*(\d+)/i);
            if (codeMatch) {
                result.code = codeMatch[1].trim();
            }
            
            // 6. Extrair telefone utilizado
            const telefoneMatch = emailBody.match(/Telefone\s+utilizado:\s*\(?(\d{2})\)?\s*(\d{4,5})-?(\d{4})/i);
            if (telefoneMatch) {
                const ddd = telefoneMatch[1];
                const parte1 = telefoneMatch[2];
                const parte2 = telefoneMatch[3];
                result.phone = `${ddd}${parte1}${parte2}`;
                result.telefone_formatado = `(${ddd}) ${parte1}-${parte2}`;
            }
            
            // 7. Extrair telefone do vendedor
            const telefoneVendedorMatch = emailBody.match(/Telefone\s+do\s+Vendedor:\s*\(?(\d{2})\)?\s*(\d{4,5})-?(\d{4})/i);
            if (telefoneVendedorMatch) {
                const ddd_v = telefoneVendedorMatch[1];
                const parte1_v = telefoneVendedorMatch[2];
                const parte2_v = telefoneVendedorMatch[3];
                result.telefone_vendedor = `55${ddd_v}${parte1_v}${parte2_v}`;
            }
            
            return result;
        }
        
        function formatWhatsAppMessage(emailBody, extractedInfo) {
            const vendedor = extractedInfo.vendedor_primeiro_nome || '';
            const name = extractedInfo.name || '';
            const code = extractedInfo.code || '';
            const empresa = extractedInfo.empresa || '';
            const cnpj = extractedInfo.cnpj || '';
            const telefone = extractedInfo.telefone_formatado || '';
            
            const mensagem = `Prezado, ${vendedor}

O(A) ${name}, tentou acessar a conta do Cliente: ${code} - ${empresa} - CNPJ: ${cnpj} na Assistente Virtual WhatsApp com o telefone ${telefone} por√©m esse telefone n√£o est√° cadastrado no sistema.

Clique no Link Abaixo para autorizar ou recusar o Acesso desse cliente com esse n√∫mero.

${generateAuthorizationLink(extractedInfo)}`;
            
            return mensagem;
        }
        
        function generateAuthorizationLink(extractedInfo) {
            const baseUrl = "https://script.google.com/macros/s/AKfycbzeo4Q6HwuzOfAYQZfUoYBlFxH1CqKQrvi3LAysYrO5gusBu4w1LoPzopxj71L210Sn/exec";
            
            const name = encodeURIComponent(extractedInfo.name || '');
            const code = extractedInfo.code || '';
            const phone = extractedInfo.phone || '';
            const empresa = encodeURIComponent(extractedInfo.empresa || '');
            
            return `${baseUrl}?name=${name}&code=${code}&phone=${phone}&empresa=${empresa}`;
        }
        
        // Fun√ß√µes de interface
        function addGmailLog(message) {
            const logsDiv = document.getElementById('gmail-logs');
            if (logsDiv) {
                const timestamp = new Date().toLocaleTimeString('pt-BR');
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${timestamp}] ${message}`;
                logsDiv.appendChild(logEntry);
                logsDiv.scrollTop = logsDiv.scrollHeight;
            }
        }
        
        function clearGmailLogs() {
            const logsDiv = document.getElementById('gmail-logs');
            if (logsDiv) {
                logsDiv.innerHTML = '<div>üìß Logs limpos...</div>';
            }
        }
        
        async function connectGmail() {
            addGmailLog('üîê Iniciando conex√£o com Gmail...');
            
            // Verificar se o servidor est√° acess√≠vel
            try {
                const healthCheck = await fetch(`${GMAIL_API_URL}/health`);
                if (!healthCheck.ok) {
                    throw new Error('Servidor n√£o est√° respondendo');
                }
                const healthData = await healthCheck.json();
                if (!healthData || healthData.status !== 'ok') {
                    throw new Error('Servidor n√£o est√° funcionando corretamente');
                }
            } catch (error) {
                addGmailLog(`‚ùå Servidor Gmail Monitor n√£o est√° acess√≠vel na porta 5000`);
                alert(`Erro: Servidor Gmail Monitor n√£o est√° rodando!\n\nPor favor:\n1. Certifique-se de que o servidor gmail-monitor-api.py est√° rodando\n2. Verifique se a porta 5001 est√° dispon√≠vel\n3. Execute: python gmail-monitor-api.py\n\nOu use o iniciar-servidor.bat que inicia todos os servidores automaticamente.`);
                return;
            }
            
            try {
                addGmailLog('‚è≥ Aguardando autentica√ß√£o... (uma janela do navegador ser√° aberta)');
                
                const response = await fetch(`${GMAIL_API_URL}/gmail/connect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    timeout: 120000 // 2 minutos para autentica√ß√£o OAuth2
                });
                
                if (!response.ok) {
                    // Tentar ler como JSON, se falhar, ler como texto
                    const responseText = await response.text();
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch (e) {
                        // Se n√£o for JSON, pode ser HTML de erro
                        throw new Error(`Erro HTTP ${response.status}: ${responseText.substring(0, 200)}`);
                    }
                    throw new Error(errorData.error || `Erro HTTP ${response.status}`);
                }
                
                // Verificar se a resposta √© JSON v√°lido
                const responseText = await response.text();
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`Resposta inv√°lida do servidor: ${responseText.substring(0, 200)}`);
                }
                
                if (data.success) {
                    addGmailLog(`‚úÖ Gmail conectado: ${data.email}`);
                    document.getElementById('gmail-status-text').textContent = '‚úÖ Conectado';
                    document.getElementById('gmail-email').textContent = data.email;
                    document.getElementById('connect-gmail-btn').style.display = 'none';
                    document.getElementById('disconnect-gmail-btn').style.display = 'inline-block';
                } else {
                    addGmailLog(`‚ùå Erro: ${data.error}`);
                    alert(`Erro ao conectar: ${data.error}\n\nVerifique:\n1. Se o arquivo credentials.json existe na raiz do projeto\n2. Se a Gmail API est√° habilitada no Google Cloud Console\n3. Veja README_GMAIL_MONITOR.md para instru√ß√µes detalhadas`);
                }
            } catch (error) {
                addGmailLog(`‚ùå Erro de conex√£o: ${error.message}`);
                let errorMsg = `Erro ao conectar com a API: ${error.message}`;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg += '\n\nCertifique-se de que o servidor gmail-monitor-api.py est√° rodando na porta 5001.';
                } else if (error.message.includes('credentials')) {
                    errorMsg += '\n\nVerifique se o arquivo credentials.json existe e est√° correto.';
                }
                
                alert(errorMsg);
            }
        }
        
        function disconnectGmail() {
            document.getElementById('gmail-status-text').textContent = '‚ùå N√£o conectado';
            document.getElementById('gmail-email').textContent = '';
            document.getElementById('connect-gmail-btn').style.display = 'inline-block';
            document.getElementById('disconnect-gmail-btn').style.display = 'none';
            addGmailLog('üîå Gmail desconectado');
        }
        
        async function refreshGmailStatus() {
            try {
                // Primeiro verificar se o servidor est√° respondendo
                const healthResponse = await fetch(`${GMAIL_API_URL}/health`);
                if (!healthResponse.ok) {
                    throw new Error('Servidor n√£o est√° respondendo');
                }
                
                const healthData = await healthResponse.json();
                if (!healthData || healthData.status !== 'ok') {
                    throw new Error('Servidor n√£o est√° funcionando corretamente');
                }
                
                const [statusResponse, monitorResponse] = await Promise.all([
                    fetch(`${GMAIL_API_URL}/gmail/status`),
                    fetch(`${GMAIL_API_URL}/gmail/monitor-status`)
                ]);
                
                // Verificar se as respostas s√£o JSON v√°lido
                const statusText = await statusResponse.text();
                const monitorText = await monitorResponse.text();
                
                let statusData, monitorData;
                try {
                    statusData = JSON.parse(statusText);
                } catch (e) {
                    throw new Error(`Resposta inv√°lida do servidor (status): ${statusText.substring(0, 100)}`);
                }
                
                try {
                    monitorData = JSON.parse(monitorText);
                } catch (e) {
                    // Se monitor-status falhar, usar valores padr√£o
                    monitorData = {
                        running: false,
                        last_check: null,
                        statistics: { total: 0, enviados: 0, pendentes: 0 }
                    };
                }
                
                // Atualizar status de conex√£o
                if (statusData.authenticated) {
                    document.getElementById('gmail-status-text').textContent = '‚úÖ Conectado';
                    document.getElementById('gmail-email').textContent = statusData.email;
                    document.getElementById('connect-gmail-btn').style.display = 'none';
                    document.getElementById('disconnect-gmail-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('gmail-status-text').textContent = '‚ùå N√£o conectado';
                    document.getElementById('gmail-email').textContent = '';
                    document.getElementById('connect-gmail-btn').style.display = 'inline-block';
                    document.getElementById('disconnect-gmail-btn').style.display = 'none';
                }
                
                // Atualizar status do monitor
                document.getElementById('monitor-status-text').textContent = monitorData.running ? '‚ñ∂Ô∏è Ativo' : '‚è∏Ô∏è Pausado';
                document.getElementById('last-check').textContent = monitorData.last_check ? 
                    new Date(monitorData.last_check).toLocaleString('pt-BR') : 'Nunca';
                document.getElementById('emails-processed').textContent = monitorData.statistics.enviados || 0;
                document.getElementById('emails-pending').textContent = monitorData.statistics.pendentes || 0;
                
                // Atualizar bot√µes
                if (monitorData.running) {
                    document.getElementById('start-monitor-btn').style.display = 'none';
                    document.getElementById('stop-monitor-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('start-monitor-btn').style.display = 'inline-block';
                    document.getElementById('stop-monitor-btn').style.display = 'none';
                }
                
                addGmailLog('üîÑ Status atualizado');
            } catch (error) {
                const errorMsg = error.message || 'Erro desconhecido';
                addGmailLog(`‚ùå Erro ao atualizar status: ${errorMsg}`);
                
                // Se o erro for de conex√£o, mostrar mensagem mais clara
                if (errorMsg.includes('Failed to fetch') || errorMsg.includes('NetworkError') || errorMsg.includes('n√£o est√° respondendo')) {
                    addGmailLog('‚ö†Ô∏è Servidor Gmail Monitor n√£o est√° rodando na porta 5000');
                    document.getElementById('monitor-status-text').textContent = '‚ùå Servidor offline';
                }
            }
        }
        
        async function startGmailMonitor() {
            const interval = parseInt(document.getElementById('check-interval').value) || 5;
            const intervalSeconds = interval * 60;
            
            addGmailLog(`‚ñ∂Ô∏è Iniciando monitoramento (intervalo: ${interval} min)...`);
            
            try {
                const response = await fetch(`${GMAIL_API_URL}/gmail/start-monitor`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval: intervalSeconds })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addGmailLog('‚úÖ Monitor iniciado com sucesso');
                    document.getElementById('start-monitor-btn').style.display = 'none';
                    document.getElementById('stop-monitor-btn').style.display = 'inline-block';
                    document.getElementById('monitor-status-text').textContent = '‚ñ∂Ô∏è Ativo';
                    
                    // Iniciar atualiza√ß√£o peri√≥dica de status
                    if (gmailMonitorInterval) clearInterval(gmailMonitorInterval);
                    gmailMonitorInterval = setInterval(refreshGmailStatus, 30000); // A cada 30 segundos
                } else {
                    addGmailLog(`‚ùå Erro: ${data.error}`);
                    alert(`Erro ao iniciar monitor: ${data.error}`);
                }
            } catch (error) {
                addGmailLog(`‚ùå Erro de conex√£o: ${error.message}`);
                alert(`Erro ao iniciar monitor: ${error.message}`);
            }
        }
        
        async function stopGmailMonitor() {
            addGmailLog('‚è∏Ô∏è Parando monitoramento...');
            
            try {
                const response = await fetch(`${GMAIL_API_URL}/gmail/stop-monitor`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    addGmailLog('‚úÖ Monitor parado');
                    document.getElementById('start-monitor-btn').style.display = 'inline-block';
                    document.getElementById('stop-monitor-btn').style.display = 'none';
                    document.getElementById('monitor-status-text').textContent = '‚è∏Ô∏è Pausado';
                    
                    if (gmailMonitorInterval) {
                        clearInterval(gmailMonitorInterval);
                        gmailMonitorInterval = null;
                    }
                } else {
                    addGmailLog(`‚ùå Erro: ${data.error}`);
                }
            } catch (error) {
                addGmailLog(`‚ùå Erro de conex√£o: ${error.message}`);
            }
        }
        
        async function processPendingEmails() {
            addGmailLog('üîÑ Processando e-mails pendentes...');
            
            try {
                const response = await fetch(`${GMAIL_API_URL}/gmail/process-pending`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.results;
                    addGmailLog(`‚úÖ Processamento conclu√≠do: ${results.success.length} sucesso, ${results.failed.length} falhas`);
                    
                    if (results.failed.length > 0) {
                        results.failed.forEach(fail => {
                            addGmailLog(`‚ùå Falha: ${fail.message_id} - ${fail.error}`);
                        });
                    }
                    
                    // Atualizar lista e status
                    loadPendingEmails();
                    refreshGmailStatus();
                } else {
                    addGmailLog(`‚ùå Erro: ${data.error}`);
                }
            } catch (error) {
                addGmailLog(`‚ùå Erro de conex√£o: ${error.message}`);
            }
        }
        
        async function loadPendingEmails() {
            try {
                const response = await fetch(`${GMAIL_API_URL}/gmail/pending-emails`);
                const data = await response.json();
                
                const container = document.getElementById('pending-emails-list');
                
                if (data.success && data.emails.length > 0) {
                    container.innerHTML = '';
                    
                    data.emails.forEach(email => {
                        const emailDiv = document.createElement('div');
                        emailDiv.style.cssText = 'background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd;';
                        emailDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <strong>üìß ${email.subject || 'Sem assunto'}</strong>
                                <span style="color: #666; font-size: 12px;">${new Date(email.date_received).toLocaleString('pt-BR')}</span>
                            </div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 10px;">
                                <div><strong>De:</strong> ${email.from_email}</div>
                                <div><strong>Vendedor:</strong> ${email.vendedor_primeiro_nome || 'N/A'}</div>
                                <div><strong>Telefone:</strong> ${email.telefone_vendedor || 'N/A'}</div>
                                <div><strong>Cliente:</strong> ${email.empresa || 'N/A'} (${email.code || 'N/A'})</div>
                            </div>
                            <div style="max-height: 100px; overflow-y: auto; font-size: 11px; color: #888; background: #f8f9fa; padding: 8px; border-radius: 4px;">
                                ${email.email_body.substring(0, 200)}${email.email_body.length > 200 ? '...' : ''}
                            </div>
                        `;
                        container.appendChild(emailDiv);
                    });
                } else {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">‚úÖ Nenhum e-mail pendente</p>';
                }
            } catch (error) {
                document.getElementById('pending-emails-list').innerHTML = 
                    `<p style="color: #dc3545; text-align: center; padding: 20px;">‚ùå Erro ao carregar: ${error.message}</p>`;
            }
        }
        
        async function cleanPendingEmails() {
            if (!confirm('Tem certeza que deseja limpar e-mails pendentes que n√£o existem mais no Gmail?\n\nEsta a√ß√£o ir√°:\n- Verificar cada e-mail pendente no Gmail\n- Remover do banco de dados os que n√£o existem mais\n\nEsta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }
            
            addGmailLog('üßπ Iniciando limpeza de e-mails pendentes...');
            
            try {
                const response = await fetch(`${GMAIL_API_URL}/gmail/clean-pending`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.results;
                    addGmailLog(`‚úÖ Limpeza conclu√≠da: ${results.removed} e-mail(s) removido(s), ${results.exists} ainda existe(m)`);
                    
                    if (results.removed > 0) {
                        alert(`Limpeza conclu√≠da!\n\n‚úÖ ${results.removed} e-mail(s) removido(s) do banco de dados\n‚úÖ ${results.exists} e-mail(s) ainda existe(m) no Gmail\n\n${results.errors > 0 ? `‚ö†Ô∏è ${results.errors} erro(s) durante a verifica√ß√£o\n` : ''}`);
                    } else {
                        alert(`Limpeza conclu√≠da!\n\n‚úÖ Todos os e-mails pendentes ainda existem no Gmail\n‚úÖ Nenhum e-mail foi removido`);
                    }
                    
                    // Atualizar lista e status
                    loadPendingEmails();
                    refreshGmailStatus();
                } else {
                    addGmailLog(`‚ùå Erro: ${data.error}`);
                    alert(`Erro ao limpar e-mails: ${data.error}`);
                }
            } catch (error) {
                addGmailLog(`‚ùå Erro de conex√£o: ${error.message}`);
                alert(`Erro ao limpar e-mails: ${error.message}\n\nCertifique-se de que o servidor Gmail Monitor est√° rodando.`);
            }
        }
        
        async function loadEmailHistory() {
            try {
                const response = await fetch(`${GMAIL_API_URL}/gmail/history?limit=50`);
                const data = await response.json();
                
                const container = document.getElementById('emails-history');
                
                if (data.success && data.emails.length > 0) {
                    container.innerHTML = '<table style="width: 100%; border-collapse: collapse; font-size: 12px;"><thead><tr style="background: #007bff; color: white;"><th style="padding: 8px; text-align: left;">Data</th><th style="padding: 8px; text-align: left;">Assunto</th><th style="padding: 8px; text-align: left;">Vendedor</th><th style="padding: 8px; text-align: left;">Status</th></tr></thead><tbody>';
                    
                    data.emails.forEach(email => {
                        const status = email.enviado_whatsapp ? '‚úÖ Enviado' : '‚è≥ Pendente';
                        const statusColor = email.enviado_whatsapp ? '#28a745' : '#ffc107';
                        container.innerHTML += `
                            <tr style="border-bottom: 1px solid #ddd;">
                                <td style="padding: 8px;">${new Date(email.date_received).toLocaleDateString('pt-BR')}</td>
                                <td style="padding: 8px;">${email.subject || 'Sem assunto'}</td>
                                <td style="padding: 8px;">${email.vendedor_primeiro_nome || 'N/A'}</td>
                                <td style="padding: 8px; color: ${statusColor}; font-weight: bold;">${status}</td>
                            </tr>
                        `;
                    });
                    
                    container.innerHTML += '</tbody></table>';
                } else {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Nenhum e-mail no hist√≥rico</p>';
                }
            } catch (error) {
                document.getElementById('emails-history').innerHTML = 
                    `<p style="color: #dc3545; text-align: center; padding: 20px;">‚ùå Erro ao carregar: ${error.message}</p>`;
            }
        }
        
        function toggleAutoMonitor() {
            const autoMonitor = document.getElementById('auto-monitor').checked;
            if (autoMonitor) {
                startGmailMonitor();
            } else {
                stopGmailMonitor();
            }
        }
        
        // Atualizar status ao carregar a aba Gmail
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar status quando a aba Gmail for aberta
            const gmailTab = document.getElementById('tab-gmail');
            if (gmailTab) {
                const observer = new MutationObserver(function(mutations) {
                    if (gmailTab.classList.contains('active')) {
                        refreshGmailStatus();
                        loadPendingEmails();
                        loadEmailHistory();
                    }
                });
                observer.observe(gmailTab, { attributes: true, attributeFilter: ['class'] });
            }
        });
    </script>
</body>
</html>